                 Interactive Connectivity Establishment (ICE):
         A Protocol for Network Address Translator (NAT) Traversal for
                             Offer/Answer Protocols
# Abstract

本文档描述了一种协议，用于基于UDP的多媒体会话的网络地址转换(Network Address Translator - NAT)穿越，该协议建立在offer/answer模型上。该协议称为交互式连接建立（Interactive Connectivity Establishment - ICE）。ICE利用NAT会话穿透工具(Session Traversal Utilities for NAT - STUN)协议及其扩展 (Traversal Using Relay NAT - TURN)。ICE可以被任何使用用offer/answer模型的协议使用，例如会话启动协议（SIP）。

<!-- TOC -->

- [Abstract](#abstract)
- [1. 引言](#1-引言)
- [2.  ICE 概述](#2--ice-概述)
  - [2.1. 采集候选地址](#21-采集候选地址)

<!-- /TOC -->

# 1. 引言

RFC3264[RFC3264]为建立多媒体会话的目的，定义了会话描述协议（SDP）消息[RFC4566]的两阶段交换。  这种offer/answer机制被诸如会话启动协议（SIP）[RFC3261]等协议所使用。

使用offer/answer的通信协议很难通过网络地址转换(NAT)来操作，因为它们的目的是建立媒体数据包流，它们往往在消息中携带媒体源和槽的IP地址和端口，这在NAT中是有问题的[RFC3235]。这些协议还寻求在参与者之间直接创建媒体流，因此它们之间没有应用层中介。这样做的目的是为了减少媒体延迟，减少数据包丢失，降低部署应用的运营成本。然而，通过NAT很难做到这一点，完整的原因超出了本规范的范围。

为了使这些协议能够通过NAT运行，已经定义了许多解决方案。这些解决方案包括应用层网关(Application Layer Gateways - ALGs)、中间盒控制协议(Middlebox Control Protocol)[RFC3303]、最初的UDP的NAT简单穿越(Simple Traversal of UDP Through NAT - STUN)[RFC3489]规范、Realm Specific IP[RFC3102][RFC3103]。除了解决方案，还定义了使其工作所需的会话描述扩展，如实时控制协议(RTCP)[RFC3605]的会话描述协议(SDP)[RFC4566]属性。不幸的是，这些技术都有优点和缺点，使得每一种技术在某些网络拓扑结构中是最佳的，但在其他网络拓扑结构中则是糟糕的选择。其结果是，管理员和实施者都在对部署其解决方案的网络拓扑结构进行假设。这给系统带来了复杂性和脆弱性。我们需要的是一个单一的解决方案，它足够灵活，可以在所有情况下都能很好地工作。

本规范定义了交互式连接建立(ICE)，它是一种基于UDP的媒体流的NAT穿越技术(ICE也可以扩展到处理其他传输协议，如TCP[ICE-TCP])。ICE是offer/answer模型的一个扩展，其工作原理是在SDP offer和answer中包含多个IP地址和端口，然后通过点对点连接性检查来测试其连接性。SDP中包含的IP地址和端口以及连接性检查都使用修订后的STUN规范[RFC5389]进行。STUN现在已经更名为NAT的会话穿越工具，新的名称和新的规范反映了它作为一个工具的新角色，它与其他NAT穿越技术（即ICE）一起使用，而不是像原来的STUN规范中说的那样作为一个独立的NAT穿越解决方案。ICE还利用了STUN的扩展 - TURN [RFC5766]进行穿越。由于ICE为每个媒体流交换了多个IP地址和端口，因此它还允许为多宿主机和双栈主机选择地址，为此它废弃了RFC4091[RFC4091]和[RFC4092]。

# 2.  ICE 概述

在一个典型的ICE部署模型中，我们有两个想要通信的端点（在RFC 3264术语中称为AGENTS）。它们能够通过某种信令协议（如SIP）间接通信，通过这种方式，它们可以进行SDP[RFC3264]消息的交换。请注意，ICE的目的不是为了SIP的NAT穿越，SIP假定是通过另一种机制[RFC5626]提供的。在ICE过程开始时，代理对自己的拓扑结构一无所知。特别是，它们可能在NAT（或多层NAT）后面，也可能不在NAT后面。ICE允许代理发现关于他们的拓扑结构的足够的信息，从而有可能找到一条或更多的路径，并通过这些路径可以进行通信。

图1显示了一个典型的ICE部署环境，两个端点被标记为L和R（代表左和右，这有助于可视化呼叫流）。L和R都在各自的NAT后面，虽然他们可能不知道。NAT的类型和它的属性也是未知的。为了在L和R之间建立媒体会话，代理人L和R能够通过交换SDP消息进行offer/answer交换，这种交换通常通过SIP服务器进行。

除了代理、SIP服务器和NAT之外，ICE通常与网络中的STUN或TURN服务器协同使用。每个代理可以有自己的STUN或TURN服务器，也可以是同一个。

                              +-------+
                              | SIP   |
           +-------+          | Srvr  |          +-------+
           | STUN  |          |       |          | STUN  |
           | Srvr  |          +-------+          | Srvr  |
           |       |         /         \         |       |
           +-------+        /           \        +-------+
                           /             \
                          /               \
                         /                 \
                        /                   \
                       /  <-  Signaling  ->  \
                      /                       \
                     /                         \
               +--------+                   +--------+
               |  NAT   |                   |  NAT   |
               +--------+                   +--------+
                 /                                \
                /                                  \
               /                                    \
           +-------+                             +-------+
           | Agent |                             | Agent |
           |   L   |                             |   R   |
           |       |                             |       |
           +-------+                             +-------+

                              图1：ICE部署场景
    
ICE背后的基本思想如下：每个代理都有各种候选传输地址（candidate TRANSPORT ADDRESSES - IP地址和端口的组合，用于特定的传输协议，在本规范中总是UDP），它们可以被用来与其他代理进行通信，这些地址包括：

- 直接连接的网络接口上的传输地址

- NAT公共侧的转换传输地址（"服务器反射" 地址）

- 从TURN服务器分配的传输地址（"中继地址"）

L的任何一个候选传输地址都有可能与R的任何一个候选传输地址进行通信。然而，在实践中，许多组合将无法工作。例如，如果L和R都在NAT后面，它们直接连接的接口地址就不可能直接通信（这就是为什么需要ICE的原因！）。ICE的目的是发现哪些地址对可以工作，方法是系统地尝试所有可能的地址对（按照仔细的排序），直到找到一个或多个可以工作的地址对。

## 2.1. 采集候选地址

为了执行ICE，代理必须识别所有的地址候选者。候选者是一个传输地址 -- 一个特定传输协议的IP地址和端口的组合（这里只指定UDP）。本文档定义了三种类型的候选者，有些来自物理或逻辑网络接口，有些则可通过STUN和TURN发现。当然，一种可行的候选者是直接从本地接口获得的传输地址，这样的候选地址被称为主机候选者。本地接口可以是以太网或WiFi，也可以是通过隧道机制获得的接口，如虚拟专用网（VPN）或移动IP（MIP）。在所有情况下，这样的网络接口在代理看来都是一个本地接口，可以从这个接口分配端口(以及候选者)。

如果一个代理是多接入的，它就会从每个IP地址中获取一个候选者。根据PEER(the other agent inthe session)在IP网络上相对于代理的位置，代理也许可以通过一个或多个IP地址被peer到达.例如，考虑一个代理，它在一个私有网10网络(I1)上有一个本地IP地址，另一个连接到公共互联网(I2)。  来自I1的候选者在与同一私有网10网络上的对等者通信时可以直接到达，而来自I2的候选者在与公共互联网上的对等者通信时可以直接到达。  在发送报价之前，报价代理不需要猜测哪一个IPaddress会工作，而是将两个候选者都包含在报价中。

下一步，代理使用STUN或TURN来获取更多的候选者，这些候选者有两种类型：NAT公共侧的翻译地址（SERVER REFLEXIVE CANDIDATES）和TURN服务器上的地址（RELAYED CANDIDATES）。  当使用TURN服务器时，这两种类型的候选地址都是从TURN服务器上获得的。  如果只使用STUN服务器，则只从它们那里获得服务器反射候选者。  这些候选者与主机候选者的关系如图2所示。  在该图中，两种类型的候选者都是利用TURN发现的。  在图中，符号X:x表示IPaddress X和UDP端口x。

                 To Internet
                     |
                     |
                     |  /------------  Relayed
                 Y:y | /               Address
                 +--------+
                 |        |
                 |  TURN  |
                 | Server |
                 |        |
                 +--------+
                     |
                     |
                     | /------------  Server
              X1':x1'|/               Reflexive
               +------------+         Address
               |    NAT     |
               +------------+
                     |
                     | /------------  Local
                 X:x |/               Address
                 +--------+
                 |        |
                 | Agent  |
                 |        |
                 +--------+
图2：候选者关系当代理从IP地址和端口X:x发送TURN Allocate请求时，NAT（假设有）将创建一个绑定X1':x1'，将这个服务器反射候选者映射到hostcandidate X:x。  从主机候选者发送的出站数据包将被NAT翻译成服务器反义候选者。  发往服务器反义候选者的传入数据包将由NAT翻译到主机候选者并转发给代理。  我们把与给定的服务器反义候选者相关联的主机候选者称为BASE。
注："基地 "指的是代理为特定的候选者发送的地址，因此，作为退化的情况，宿主候选者也有一个基地，但与宿主候选者相同。  因此，作为一种退化的情况，宿主候选人也有一个基数，但它和宿主候选人是一样的。
当代理和TURN服务器之间有多个NAT时，TURN请求将在每个NAT上创建一个绑定，但只有最外层的服务器反射候选者（离TURNserver最近的那个）会被代理发现。  如果代理不在NAT后面，那么基本候选者将与服务器反射候选者相同，服务器反射候选者是多余的，将被淘汰。
然后，Allocate请求到达TURN服务器。  TURN服务器从其本地IP地址Y中分配一个端口y，并生成一个Allocate响应，告知代理这个中继候选者，TURN服务器还通过将Allocate请求的源传输地址复制到Allocate响应中，告知代理服务器reflexivecandidate，X1':x1'。  TURN服务器的作用是作为数据包中继，转发L和R之间的流量，为了向L发送流量，R将流量发送到位于Y:y的TURN服务器，TURNserver将其转发到X1':x1'，通过NAT，在那里它被映射到X:x，并传递给L。
当只使用STUN服务器时，代理向其STUN服务器发送一个STUN Bindingrequest[RFC5389]。  STUN服务器将通过把Binding请求的源传输地址复制到Bindingresponse中，告知代理服务器反射候选X1':x1'。
2.2.  Connectivity Checks
一旦L收集到所有的候选者，就按优先级从高到低排序，并通过信令信道发送给R.候选者在SDP要约中以属性形式携带。  当Rreceives the offer时，它执行同样的收集过程，并以自己的候选者列表来回应。  在这个过程结束时，每个代理都有一个完整的候选者和它的同伴的候选者列表。  它将它们配对，从而产生candidatepairs。  为了查看哪些配对有效，每个代理安排了一系列的CHECKS。  每一个check都是一个STUN请求响应事务，客户端将通过从本地候选者向远程候选者发送一个STUNrequest来对特定的候选者对执行。
连接性检查的基本原理很简单。
1.  按优先顺序对候选对进行排序。
2.  按优先顺序对每对候选人进行检查。
3.  3. 确认从其他代理人处收到的支票。
随着两个代理对候选配对进行检查，结果是4方握手。
L R- -STUN请求-> \ L's<- STUN响应检查<- STUN请求\ R'sSTUN响应->检查图3：基本连接性检查需要注意的是，STUN请求被发送到和来自完全相同的IP地址和端口，这些地址和端口将被用于媒体（例如，RTP和RTCP）。  因此，代理使用数据包的内容而不是接收数据包的端口来解复用STUN和RTPRTCP。  幸运的是，这种解复用很容易做到，特别是对于RTP和RTCP。
由于STUN Binding请求用于连接性检查，STUN Binding响应将包含代理与其对等体之间任何NAT的公共侧的翻译后的传输地址，如果这个传输地址与代理已经学习的其他候选地址不同，则代表新的候选地址，称为PEER REFLEXIVE CANDIDATE。  如果这个传输地址与代理已经学会的其他候选者不同，它就代表一个新的候选者，称为PEER REFLEXIVE CANDIDATE，然后它就会像其他候选者一样被ICE测试。
作为一种优化，当R收到L的检查消息时，R就会安排在同一候选者对上向L发送连接性检查消息。  这样就加速了寻找有效候选者的过程，称为TRIGGERED CHECK。
在这个握手结束时，L和R都知道他们可以在两个方向上端对端发送（和接收）消息。
2.3.  Sorting Candidates
因为上面的算法搜索所有的候选对，如果存在一个工作对，无论候选对以什么顺序被尝试，它最终都会找到它。  为了产生更快（和更好）的结果，候选者按指定的顺序进行排序。  该算法在4.1.2节中有描述，但遵循两个一般原则。
o每个代理都给它的候选者一个数字优先级，这个优先级与候选者对同行的优先级是sentalong的。
o 本地和远程的优先级是结合在一起的，因此每个代理对候选对的排序是一样的。
当L和R前面有NAT时，第二个属性对于让ICE工作是很重要的。通常情况下，NAT不允许从主机发送数据包进来，直到NAT后面的代理向该主机发送数据包。  因此，在每个方向上的ICE检查都不会成功，直到双方都通过各自的NAT发送了一个检查。
代理商通过定期向列表中的下一个候选对发送STUN请求来完成这个检查列表。  这些称为ORDINARY CHECKKS。
一般来说，优先级算法的设计是为了使同类候选者获得相似的优先级，使更多的直接路由（即通过较少的媒体中继和较少的NAT）优于间接路由（有更多媒体中继和更多NAT的路由）。  然而，在这些准则范围内，代理有相当大的自由裁量权来调整他们的算法。
2.4.  Frozen Candidates
前面的描述只涉及到代理希望与一个COMPONENT(一个媒体流的片段，需要一个传输地址；一个媒体流可能需要多个组件，其中每个组件都必须为整个媒体流工作)建立媒体会话的情况。  通常情况下(如RTP和RTCP)，代理实际上需要为不止一个流建立连接。
每个组件的网络属性可能非常相似（特别是由于RTP和RTCP是由同一个IP地址发送和接收的）。  通常可以利用一个媒体组件的信息来确定另一个组件的最佳候选者。  ICE通过一种称为 "冻结候选者 "的机制来实现这一点。
每一个候选者都与一个叫做foundation的属性相关联。当两个候选者 "相似 "时，它们的foundation是相同的--类型相同，并且使用相同的协议从同一个候选者主机和STUNserver获得。  否则，它们的基础是不同的。  一个候选者对也有一个基础，这只是它的两个候选者基础的组合。  最初，只有具有唯一基础的候选对才会被测试，其他候选对被标记为 "冻结"。  其他候选对被标记为 "冻结"。  当一个候选对的连通性检查成功时，其他具有相同基础的候选对将被解冻。  这就避免了重复检查那些表面上更有吸引力但实际上很可能失败的成分。
虽然我们在这里将 "冻结 "描述为一个独立的机制forexpository，但实际上它是ICE的一个组成部分，ICE的优先级算法会自动确保正确的candidates被解冻，并按照正确的顺序进行检查。
2.5.  Security for Checks
因为ICE是用来发现哪些地址可以用来在两个代理之间发送媒体的，所以必须确保这个过程不会被劫持，将媒体发送到错误的位置。  每个STUN连接性检查都由一个消息认证码(MAC)覆盖，这个MAC是使用在信令通道中交换的密钥计算出来的。  这个MAC提供了消息完整性和数据来源认证，从而阻止攻击者伪造或修改连接性检查消息。  此外，如果SIP[RFC3261]呼叫者使用ICE，并且他们的呼叫分叉，ICE交换是独立地与每个分叉的接收者发生的。  在这种情况下，在signaling中交换的密钥有助于将每个ICE交换与每个forkedrecipient关联起来。
2.6.  Concluding ICE
ICE检查是按照特定的顺序进行的，因此高优先级的候选对首先被检查，然后是低优先级的。  结束ICE的一种方法是，当每个媒体流的每个组件的检查完成successfully后，就宣布胜利。  事实上，这是一种合理的算法，下文将提供详细的算法。  然而，有可能一个数据包丢失会导致一个更高优先级的检查需要更长的时间来完成.在这种情况下，允许ICE运行更长时间可能会产生更好的结果。  然而，更根本的是，本规范所定义的优先级可能不会产生 "最佳 "结果。  作为一个例子，如果目的是选择低延迟的媒体路径，使用arelay是一种暗示，即延迟可能更高，但它只是一种暗示。  实际的往返时间(RTT)测量可以做出来，它可能会证明优先级较低的网络对比优先级较高的网络对更好。
因此，移民局指定其中一个代理人担任 "控制代理人"，另一个代理人担任 "控制代理人"。  控制代理在有效的候选媒体中提名哪些候选对将被用于媒体。  ...
在常规提名的情况下，控制代理让检查继续进行，直到为每个介质流找到至少一个有效的候选对。  然后，它在这些有效的候选对中挑选，并对它的NOMINATED候选对发出第二个STUN请求，但这次设置了一个标志，以告诉对等体这个对已经被提名使用。  这一点如图4所示。
L R- -STUN请求 -> \ L's<- STUN响应检查<- STUN请求 \ R'sSTUN响应 -> 检查STUN请求+标志 -> \ L's<- STUN响应检查图4：常规提名一旦带有标志的STUN事务完成，双方就会取消该媒体流的任何未来检查。  ICE现在将使用这个对发送媒体。  ICE代理使用的媒体对被称为the SELECTED PAIR。
在激进的提名中，控制代理在每次发送的STUN请求中都会放入标志，这样一来，一旦第一次检查成功，ICE对该媒体流的处理就完成了，控制代理不必再发送第二次STUN请求。  这样，一旦第一次检查成功，该媒体流的ICE处理就完成了，控制代理就不必再发送第二个STUN请求。  这些被选中的对子将是检查成功的最高优先级的有效对子。  积极提名比普通提名快，但灵活性较差。  激进式提名如图5所示。
L R- -STUN请求+标志-> \ L's<- STUN响应检查<- STUN请求\ R'sSTUN响应->检查图5：激进的提名Once所有的媒体流都完成了，如果他们媒体流的m和c行中的候选者（称为DEFAULT CANDIDATES）不符合ICE的SELECTED CANDIDATES，控制端点会发送一个更新的offer。
一旦ICE结束，任何一个代理都可以在任何时候为一个或所有的媒体流重新启动。  这可以通过发送一个更新的报价来实现。
2.7.  Lite Implementations
为了使ICE能在通话中使用，两个代理都需要支持它。  然而，某些代理总是连接到公共互联网，并有一个公共IP地址，它可以接收来自任何对应方的数据包，为了使这些设备更容易支持ICE，ICE定义了一种特殊类型的实现，称为LITE（与普通的FULL相反）。  为了使这些设备更容易支持ICE，ICE定义了一种特殊类型的实现，称为LITE（与普通的FULL实现相反）。  Lite实现并不收集候选者，它只包括任何媒体流的主机候选者。  精简代理不生成连接性检查或运行状态机，尽管它们需要能够响应连接性检查。  当一个精简的实现与一个完整的实现连接时，完整的代理将扮演控制代理的角色，而精简的代理将扮演被控制的角色。  当两个精简实现连接时，不发送检查。
关于何时适合精简实施的指导意见，请参见附录A中的讨论。
需要注意的是，在本规范中增加了精简实现，以提供全面实现的踏脚石。  即使对于总是连接到公共互联网的设备来说，如果可以实现的话，最好是完全实现。
3.  Terminology
本文档中的关键词 "MUST"、"MUST NOT"、"REQUIRED"、"SHALL"、"SHALL NOT"、"SHOULD"、"SHOULD NOT"、"RECOMMENDED"、"MAY "和 "OPTIONAL "应按照RFC 2119[RFC2119]中的描述进行解释。
读者应该熟悉offeranswer模型[RFC3264]、STUN[RFC5389]和UDP的NAT Behavioralrequirements[RFC4787]中定义的术语。
本规范使用了以下附加术语：
代理商。  根据RFC 3264的定义，代理是指参与问答交换的协议实施。  在一个offeranswer交换中，有两个代理参与。
Peer。  从会话中的一个代理人的角度来看，它的同伴就是另一个代理人。  具体来说，从offerer的角度来看，peer就是应答者。  从应答者的角度看，同伴就是应答者。
传输地址。  IP地址和传输协议（如UDP或TCP）端口的组合。
候选者：作为接收媒体的潜在接触点的传输地址。  候选地址也有属性 -- -- 它们的类型（服务器反射式、中继式或主机式）、优先级、基础和基础。
组件。  一个组件是媒体流中需要单个传输地址的部分；一个媒体流可能需要多个组件，每个组件都必须为媒体流整体工作。  对于基于RTP的媒体流，每个媒体流有两个组件--一个用于RTP，一个用于RTCP。
主机候选者：从主机上的IP地址绑定到特定端口获得的候选者。  这包括物理接口上的IP地址和逻辑接口上的IP地址，如通过虚拟专用网络（VPN）和Realm Specific IP(RSIP)[RFC3102]获得的IP地址（位于操作系统层面）。
服务器反射候选者：一个候选者，其IP地址和端口是NAT为代理分配的绑定，当代理通过NAT向服务器发送acket时。  服务器反射候选者可以由STUN服务器使用Binding请求学习，或者由TURNservers学习，TURNservers同时提供中继和服务器反射候选者。
Peer Reflexidive Candidate：当代理通过NAT向其对等体发送STUNBinding请求时，NAT为其分配的IP地址和端口区域绑定的候选者。
中继候选者：通过从主机候选者向TURN服务器发送TURN Allocaterequest获得的候选者。  中继候选者驻留在TURN服务器上，TURN服务器将数据包向代理回传。
基数。  一个服务器反射式候选国的基数是它所衍生的主机候选国。  一个宿主候选者也被称为有一个基，等于该候选者本身。  同样，被铺设的候选者的基数也是该候选者本身。
基金会。  一个任意的字符串，对于两个具有相同类型、基本IP地址、协议（UDP、TCP等）和STUN或TURN服务器的候选者来说是相同的。  如果其中任何一项不同，那么基础就会不同。  两个具有相同基础对的候选对很可能具有相似的网络特性。  冻结算法中使用的是基础。
本地候选人：代理商获得的候选人，并包含在其发出的报价或答复中。
远程候选者：代理商从同行那里收到的报价或答案的候选者。
缺省目的地：媒体流中的一个组件的缺省目的地是不知道ICE的代理所使用的传输地址，对于RTP组件，缺省IP地址在SDP的c行，端口在m行。  对于RTP组件，默认IP地址在SDP的c行，端口在m行。  对于RTCP组件，当存在时，它在rtcpattribute中，当不存在时，IP地址在c行中，1加上端口在m行中。  一个组件的defaultcandidate是指其传输地址与该组件的默认目的地相匹配的组件。
候选人对。  包含一个本地候选人和一个远程候选人的配对。
检查，连接性检查，STUN检查。  一个STUN绑定请求交易，用于验证连接性。  一个检查从本地候选者发送到候选者对的远程候选者。
检查表。  一组有序的候选对，代理人将使用它来产生检查。
普通检查。  由代理产生的连接性检查，作为一个定时器的结果，定期发射，指示它发送检查。
触发检查。  在收到对等体的连接检查后产生的连接检查。
有效列表。  已被成功的STUN交易验证的媒体流候选对的有序集合。
完整：执行本规范所定义的完整功能集的ICE实现。
精简版。  一个省略了某些功能的ICE实现，只实现了一个完整的对等实现所需的功能，以获得ICE的好处。  精简版不维护任何状态机，也不产生连接性检查。
控制代理。  ICE代理负责选择最终的候选配对，并通过STUN向他们发出信号，如果需要的话，还负责更新报价。  在任何会话中，一个代理总是控制的。  另一个是被控代理。
受控代理。  一个ICE代理，等待控制代理选择最终的候选对。
常规提名。  通过一个STUN请求验证媒体流量的有效候选对，然后通过发送第二个STUN请求选择该对，并在请求中标明提名。
积极提名。  通过在每一个STUN请求中加入一个标志，为媒体流量选择一个有效的候选对的过程，这样，第一个产生有效的候选对的人就会被使用。
提名。  如果一个有效的候选对设置了提名标志，就意味着它可以被ICE选中来发送和接收媒体。
选定对、选定候选者：ICE选择的用于发送和接收媒体的候选对称为选定对，其每个候选者称为选定候选者。
4.  Sending the Initial Offer
为了在交换要约时发送初始要约，代理必须(1)收集候选者，(2)对它们进行优先级排序，(3)消除多余的候选者，(4)选择默认候选者，然后(5)制定并发送SDP要约。  除了最后一个步骤外，所有这五个步骤在完整和精简的实现中都有所不同。
4.1.  Full Implementation Requirements
4.1.1.  Gathering Candidates
当代理认为通信即将开始时，就会收集候选人。  要约人可以根据用户界面的提示，或根据明确的请求来启动会话。  每个候选者都是一个传输地址。  它也有一个类型和一个基础。  本规范定义并收集了四种类型--主机候选者、服务器反射候选者、对等反射候选者和中继候选者。  服务器反身候选者使用STUN或TURN收集，中继候选者通过TURN获得。  Peerreflexive候选者是在ICE的后期阶段获得的，作为连接性检查的结果。  候选者的基数是指代理在使用该候选者时，必须从该候选者发送。
4.1.1.1.  Host Candidates
第一步是收集主机候选者。  主机候选者是通过与主机上的一个接口（物理或虚拟接口，包括VPN接口）相连的IP地址上的端口（通常是短暂的）进行绑定而获得的。
对于代理希望使用的每一个UDP媒体流，代理should在主机拥有的每一个IP地址上为媒体流的每一个组件获取一个候选者。  它通过绑定到特定IP地址上的UDP端口来获取每个候选者。  一个主机候选者(事实上也是每一个候选者)总是与它所候选的特定组件相关联。  每个组件都有一个分配给它的ID，称为组件ID。  对于基于RTP的媒体流，RTP本身的组件ID为1，而RTCP的组件ID为2。 如果一个代理使用RTCP，它必须获得一个候选组件。  如果一个代理同时使用RTP和RTCP，如果一个代理有K个IP地址，它最终会得到2*K个主机候选者。
每个候选主机的基数设置为候选主机本身。
4.1.1.2.  Server Reflexive and Relayed Candidates
代理商应获得中继候选者，并应获得服务器反射候选者。  这些要求的强度是允许提供商变化的。  在封闭的网络中，代理从不连接到公共互联网或封闭网络外的端点，在这种情况下，使用STUN和TURN服务器可能是不必要的。  使用TURN服务器的成本很高，而且当使用ICE时，只有当两个端点都在执行地址和端口相关映射的NAT后面时，才会使用它们。  因此，一些部署可能认为这种用例是边缘化的，并选择不使用TURN服务器。  如果代理不收集服务器反射或中继候选，建议实现该功能，并通过配置将其禁用，以便在未来条件发生变化时可以通过配置重新启用。
如果代理同时收集中继和服务器反射候选者，则使用TURN服务器。  如果它只收集服务器反射候选者，它使用STUN服务器。
接下来，代理会将每个候选主机与它已配置或通过某种方式发现的 STUN 或 TURN 服务器配对。  如果配置了STUN或TURN服务器，建议配置一个域名，并使用[RFC5389]中的DNS程序（使用SRV记录和 "stun "服务）来发现STUN服务器，并使用[RFC5766]中的DNS程序（使用SRV记录和 "turn "服务）来发现TURN服务器。
本规范只考虑使用单一的STUN或TURNserver。  当单一的STUN或TURN服务器有多个选择时（例如，当它们是通过DNS记录学习的，并且返回多个结果时），代理应该为特定会话的所有候选者使用单一的STUN或TURN服务器（基于其IP地址）。  这可以提高ICE的性能。  结果是一组具有STUN或TURN服务器的主机候选者对。  然后，代理选择一对，并从该候选主机向服务器发送Binding或Allocate请求。  对 STUN 服务器的绑定请求不经过验证，响应中的任何 ALTERNATE-SERVER 属性将被忽略。  代理必须支持[RFC5389]中定义的Binding请求的向后兼容模式。  Allocate请求必须使用客户端通过其他方式获得的长期凭证进行认证。
此后每隔几毫秒，代理可以生成另一个新的STUN或TURN事务。  这个事务可以是重试之前因可恢复的错误而失败的事务（如认证失败），也可以是一个新的主机候选者和STUN或TURN服务器对的事务。  代理商产生事务的频率不应超过每Ta毫秒一次。  关于如何设置Ta和STUN重传timer，RTO的指导，请参见第16节。
代理将收到Binding或Allocate响应。  成功的Allocate响应将为代理提供一个服务器反射候选者（从映射地址获得）和XOR-RELAYED-ADDRESS属性中的中继候选者。  如果Allocate请求因为服务器缺乏资源来满足它而被拒绝，则代理should改为发送Binding请求来获取服务器reflexivecandidate。  Binding响应将只向代理提供作为服务器反射候选者（也是从映射地址中获得的）.服务器反射候选者的基数是Allocate或Binding请求发送的主机候选者。  中继候选者的基数是该候选者本身。  如果中继候选者与主机候选者相同（在极少数情况下可能发生），则必须丢弃该中继候选者。
4.1.1.3.  Computing Foundations
最后，代理给每个候选者分配一个foundation。  foundation是一个标识符，范围在一个会话中。  当以下所有条件为真时，两个候选者必须拥有相同的foundation ID。
o 它们的类型相同（主机、中继、服务器反射、或同行反射）。
o 他们的基地有相同的IP地址（端口可以不同）。
o 对于反射式和中继式候选者，用于获取它们的STUN或TURN服务器具有相同的IP地址。
o它们是使用相同的传输协议（TCP、UDP等）获得的。
同样，如果两个候选者的类型不同，它们的基地有不同的IP地址，用于获取它们的STUN或TURN服务器有不同的IP地址，或者它们的传输协议不同，那么它们必须有不同的基础。
4.1.1.4.  Keeping Candidates Alive
一旦服务器反身候选者和中继候选者被分配，它们必须保持活力，直到ICE处理完成，如第8.3节所述。  对于通过Binding请求学习的服务器反身候选者，必须通过对服务器的附加Binding请求来保持绑定的有效性。  如[RFC5766]中所述，分配的刷新是使用刷新事务来完成的。  Refresh请求也会刷新服务器reflexive候选者。
4.1.2.  Prioritizing Candidates
优先级确定过程的结果是为每个候选者分配一个优先级。  每个媒体流的候选者必须有一个唯一的优先级，该优先级必须是介于1和(2**31-1)之间的正整数。该优先级将被ICE用来确定连接性检查的顺序和候选者的相对优先级。
代理商应该使用第4.1.2.1节中的公式计算这个优先级，并使用第4.1.2.2节中的准则选择其参数。  如果一个代理选择使用不同的公式，ICE将需要更长的时间来收敛，因为两个代理在检查中不会协调。
4.1.2.1.  Recommended Formula
当使用该公式时，代理通过确定每种类型的候选者（服务器反射型、对等反射型、中继型和主机型）的偏好来计算优先级，并且当代理是多宿时，选择其IP地址的偏好。  然后将这两个偏好结合起来，计算出候选者的优先级。  该优先级是通过以下公式计算出来的。
优先级=(2^24)*(类型偏好)+(2^8)*(本地偏好)+(2^0)*(256-组件ID)类型偏好必须是0到126(含)的整数，代表对候选者类型的偏好(其中类型为本地、服务器反射、对等反射和中继)。  A126为最高偏好，0为最低偏好。  将value设置为0意味着该类型的候选者将只作为最后的手段使用。  对于同一类型的所有候选者，类型偏好必须是相同的，对于不同类型的候选者，类型偏好必须是不同的。  对等反射型候选者的类型偏好必须高于服务器反射型候选者的类型偏好。  请注意，根据第 4.1.1 节的程序收集的候选者永远不会是对等反射型候选者；这些类型的候选者是从 ICE 执行的连接检查中学习的。
本地偏好必须是一个从0到65535（含）的整数，它代表了对特定IP地址的偏好，在代理是多宿的情况下，65535代表最高的偏好，0代表最低的偏好，当只有一个IP地址时，这个值应该设置为65535。  更一般地，如果有多个候选者为某一媒体流的particular组件，且这些组件具有sametype，则每个组件的本地偏好必须是唯一的。  在本规范中，这种情况只发生在多宿主机上。  如果一台主机因为是双栈而被称为multihomed，那么本地优先权should等于RFC3484[RFC3484]中描述的IP地址的优先权值。
组件ID是候选人的组件ID，且必须在1到256之间。
4.1.2.2.  Guidelines for Choosing Type and Local Preferences
选择类型和本地偏好值的一个标准是使用媒体中介，如TURN服务器、VPNserver或NAT。  有了媒体中介，如果向该候选者发送媒体，它将首先转接媒体中介，然后再被接收。  中继候选者是涉及媒体中介的一种候选者。  另一种是从VPN接口获得的主机候选者。  当媒体通过媒体中介中转时，会增加传输和接收之间的延迟。  它可以增加数据包的损失，因为可能采取额外的路由器跳。  它可能会增加提供服务的成本，因为媒体将被路由进入并直接从供应商运行的媒体中介机构返回。  如果这些问题很重要，那么中继候选者的类型偏好应该低于主机候选者。  推荐的值是：主机候选者为126，服务器反射候选者为100，对等反射候选者为110，中继候选者为0。  此外，如果一个代理是多主机，并且有多个 IP 地址，那么来自 VPN 接口的主机候选者的本地优先级应该为 0。
另一个选择偏好的标准是IP地址系列。ICE既可以使用IPv4，也可以使用IPv6。  因此，它提供了一个过渡机制，允许双栈主机在IPv6之上选择连接，但在v6网络断开时（例如由于6to4中继失败）又回到IPv4[RFC3056]。  它也可以帮助那些同时拥有原生IPv6地址和6to4地址的主机。  在这种情况下，可以将更高的localpreferences分配给v6地址，然后是6to4地址，接着是v4地址。  这样一来，一个站点可以立即获得并开始使用本地v6地址，但在与其他站点的代理进行通信时，仍然可以回到6to4地址，而这些站点还没有本地v6连接。
36. 选择优先事项的另一个标准是安全。  如果用户是远程办公者，因此连接到公司网络和本地家庭网络，那么用户可能更愿意通过VPN对语音通信进行路由，以便在企业内部通信时将其保持在公司网络上，但在与企业外部用户通信时使用本地网络。  在这种情况下，VPN地址比其他地址具有更高的本地优先权。
另一个选择偏好的标准是拓扑意识.这对于利用中介的候选人来说是最有用的.在这些情况下,如果一个代理已经预先配置或动态发现了中介与自己的拓扑接近性知识,它可以利用这一点将较高的局部偏好分配给从较近的中介获得的候选人.
4.1.3.  Eliminating Redundant Candidates
接下来，代理会消除多余的候选者。  如果一个候选者的传输地址等于另一个候选者，并且它的基数等于另一个候选者的基数，那么这个候选者就是多余的。  请注意，两个候选者可以有相同的传输地址，但却有不同的基数，这些不会被认为是冗余的。  通常，当代理不在NAT后面时，作为服务器反射候选者和主机候选者将是冗余的。  代理商应该消除优先级较低的冗余候选者。
4.1.4.  Choosing Default Candidates
如果一个候选者是来自非ICE对等体的媒体的目标，那么这个候选者就被称为缺省，这个目标被称为DEFAULT DESTINATION.如果缺省候选者在与ICE感知的对等体通信时没有被ICE算法选中，那么在ICE处理完成后将需要更新的offeranswer，以便 "修复 "SDP，使媒体的缺省目标与ICE选择的候选者相匹配。  如果ICE恰好选择了默认的候选者，则需要更新的offeranswer。
代理商必须为每个正在使用的媒体流的每个组件选择一组候选者作为默认值。  如果一个媒体流的端口不为零（在RFC 3264中用于拒绝媒体流），那么该媒体流就是在使用中的。  因此，即使媒体流被标记为a=inactive[RFC4566]或带宽值为零，它也是在用的。
建议根据这些候选者与被联系的对等体合作的可能性来选择默认候选者。  建议默认候选者是中继候选者（如果中继候选者可用的话）、服务器反射候选者（如果服务器反射候选者可用的话），最后是主机候选者。
4.2.  Lite Implementation Requirements
精简版实现只使用主机候选者。  精简版实现必须为每个媒体流的每个组件分配零或一个IPv4候选者。  它可以分配0个或更多的IPv6候选者，但主机使用的每个IPv6地址不能超过一个。  由于每个媒体流的每个组件不能有一个以上的IPv4候选者，如果一个代理有多个IPv4地址，它必须选择一个来分配候选者。  如果一个主机是双栈，建议它分配一个IPv4候选地址和一个全局IPv6地址。  在精简的实现中，ICE不能用来动态地选择候选地址，因此，不推荐从一个特定的作用域中包含一个以上的候选地址，因为只有连接性检查才能决定是否使用一个地址或另一个地址。
每个组件都有一个ID，称为组件ID.对于基于RTP的媒体流，RTP本身的组件ID为1，RTCP的组件ID为2.如果一个代理使用RTCP，它必须为它获取候选者。
每个候选者都被分配一个基础。  对于从不同的IP地址分配的两个候选者，基础必须是不同的，否则必须是相同的。  一个简单的整数，每一个IP地址递增就足够了。  此外，每个候选者必须在同一媒体流的所有候选者中被分配一个唯一的优先级。  这个优先级应该等于
priority = (2^24)*(126)+(2^8)*(IP precedence)+(2^0)*(256 - component ID)如果一个主机是v4-only，它应该将IP precedence设置为65535。  如果主机是v6或双栈，IP优先权应该是RFC3484[RFC3484]中描述的IP地址的优先权值。
接下来，代理为每个媒体流的每个组件选择一个默认的候选者，如果主机是IPv4，那么每个媒体流的每个组件只有一个候选者，因此该候选者是默认的。  如果主机只有IPv4，那么每个媒体流的每个组件只有一个候选者，因此该候选者是默认的。  如果主机是IPv6或双栈，那么默认值的选择是本地政策的问题。  这个默认值的选择应该是最有可能被对等体使用的候选值。  对于只使用IPv6的主机来说，这通常是一个全局范围的IPv6地址。  对于双栈主机，推荐使用 IPv4 地址。
4.3.  Encoding the SDP
SDP的编码过程在完全和精简实施之间是相同的。
代理商将为它希望使用的每一个媒体流包含一个m行。  SDP中媒体流的顺序与ICE有关，ICE将首先对第一个m行进行连接性检查，因此媒体将能够首先为该流流动。
对于每个候选者来说，都会有一个候选属性，用于不同的媒体流。  第15节提供了构建该属性的详细规则。  该属性携带了候选者的IP地址、端口和传输协议，此外还携带了ICE工作时需要向对等体发出信号的属性：优先级、基础和组件ID。  candidate属性还携带了对诊断和其他功能有用的候选者的信息：它的类型和相关的传输地址。
代理之间的STUN连接性检查使用为STUN定义的短期凭证机制[RFC5389]进行认证。  该机制依赖于客户端和服务器之间通过协议机制交换的用户名和密码。  在ICE中，使用offeranswer交换来交换它们。  该凭证的usernamepart是由每个代理的usernamefragment连接而成，用冒号隔开。  每个代理还提供一个密码，用于计算它所收到的请求的消息完整性。  用户名片段和密码分别在ice-ufrag和ice-pwd属性中交换。  除了提供安全性之外，用户名还提供了与媒体流检查的歧义和相关性。  参见附录B.4的形式激励。
如果一个代理是精简的实现，它必须在其SDP中包含一个 "a=ice-lite "会话级属性。  如果一个代理是一个完整的实现，它必须不包括这个属性。
默认候选者作为媒体的defaultdestination添加到SDP中。  对于基于RTP的流，通过将RTP候选者的IP地址和端口分别放入c和mlines中来实现。  如果代理正在利用RTCP，它必须使用RFC 3605[RFC3605]中定义的a=rtcp属性对RTCP候选者进行编码。  如果没有使用RTCP，代理必须按照RFC3556[RFC3556]中的定义，使用b=RS:0和b=RR:0发出信号。
当与非ICE对等体通信时，作为默认目的地的传输地址formedia也必须在一个或多个a=candidate行中出现 ascandidates。
ICE 通过允许一个提议或回答包含一系列标识该代理所使用的 ICE 扩展的令牌来提供可扩展性。  如果一个代理支持一个ICE扩展，它必须在ice-options属性中包含为该扩展定义的标记。
以下是一个包含ICE属性的SDP消息的例子(为了便于阅读，行数折叠)。
v=0o=jdoe 2890844526 2890842807 IN IP4 10.0.1.1s=c=IN IP4 192.0.2.3t=0 0a=ice-pwd:asd88fgpdd777uzjYhagZga=ice-ufrag:8hhYm=audio 45664 RTPAVP 0b=RS:0b=RR:0a=rtpmap:0 PCMU8000a=candidate:1 1 UDP 2130706431 10.0.1.1 8998 typ hosta=candidate:2 1 UDP 1694498815 192.0.2.3 45664 typ srflx raddr10.0.1.1 rport 8998Once an agent has sent its offer or its answer, that agent MUST beprepared to receive both STUN and media packets on each candidate.As discussed in Section 11.1, media packets can be sent to acandidate before its appearance as the default destination formedia in an offer or answer.
5.  Receiving the Initial Offer
当代理收到初始offer时，会检查offerer是否支持ICE，确定自己的角色，收集候选者，确定优先级，选择默认候选者，编码并发送答案，对于完整的实现，形成检查列表，开始连接性检查。
5.1.  Verifying ICE Support
如果对于收到的SDP中的每一个媒体流，该媒体流的每一个组成部分的默认目的地出现在候选属性中，则代理将继续执行本规范中定义的ICE程序。  例如，在RTP的情况下，c行和m行中的IPaddress和端口分别出现在acandidate属性中，rtcp属性中的值出现在acandidate属性中。
如果不满足这个条件，代理必须根据正常的RFC 3264程序处理SDP，而不使用本规范剩余部分中描述的任何ICE机制，但有以下例外。
1.  1. 代理商必须遵守第10节的规则，该节规定了所有代理商的维持生命程序。
2.  如果代理因为有werea=cididate属性，但没有任何属性与媒体流的defaultdestination相匹配而没有进行ICE，代理必须在其答案中包含一个a=icemismatch属性。
3.  如果默认候选人是通过TURN服务器学习的中继候选人，则代理必须在TURNserver中为刚刚收到的SDP中从对等方学习的IP地址创建权限。  如果不这样做，来自对等体的介质流中的初始数据包可能会丢失。
5.2.  Determining Role
对于每一次会议，每个代理人都要扮演一个角色。  有两种角色 -- -- 控制和被控制。  控制代理负责选择用于通信的最终候选对。  对于一个完整的代理，这意味着为每个媒体流提名可以被ICE使用的候选对，并在需要时根据ICE的选择生成更新的offer。  对于一个较小的实施，作为控制代理意味着根据offer和应答中的候选对选择一个候选对（对于IPv4，永远只有一个候选对），然后在需要的时候生成一个反映该选择的更新offer（对于一个仅有IPv4的主机，永远不需要）。  被控制的代理被告知每个媒体流使用哪些候选配对，并且不生成更新的报价以提示该信息。  下面的章节详细描述了控制节点和被控节点所遵循的实际程序。
确定作用和对行为影响的规则如下：
两个代理都是满员。  生成启动ICE处理的提议的代理必须扮演控制角色 另一个代理必须扮演被控制角色  两个代理都将形成检查表，运行ICE状态机，并生成连接性检查。  控制代理将执行第8.1节中的逻辑来提名将被ICE选择的对，然后两个代理按照第8.1.2节中的描述结束ICE。  在附录B.11中描述的非正常情况下，两个代理有可能误认为他们是被控制的或控制的，为了解决这个问题，每个代理必须选择一个随机数，称为 "打平者"，均匀分布在0和(2**64)-1(即64位正整数)之间。  这个数字在连接性检查中用于检测和修复这种情况，如7.1.2.2节所述。
一个完整代理，一个精简代理。  全代理必须扮演控制角色 而精简代理必须扮演被控制角色。  全代理将形成检查列表，运行ICE状态机，并生成连接性检查。  该代理将执行第8.1节的逻辑来提名将被ICE选择的对，并使用第8.1.2节的逻辑来结束ICE。  精简实现将只监听连接性检查，接收检查并对其做出响应，然后按照第8.2节中的描述结束ICE。  对于精简的实现，每个媒体流的ICE处理状态被认为是Running，ICE整体的状态是Running。
都是精简的。  生成ICE处理的提议的代理必须是控制角色 另一个必须是被控制角色  在这种情况下，永远不会发送连接性检查。  相反，一旦offeranswer交换完成，每个agent都会执行第8节中描述的处理，而不进行连接性检查。  有可能两个agent都会相信自己是被控制的或控制的。  在后一种情况下，通过承载要约回答交换的signaling协议中的眩光检测功能解决冲突。  每个媒体流的ICE处理状态被认为是Running，ICE整体的状态是Running。
一旦确定了一个会话的角色，除非 ICE 被重启，否则它们将持续存在。  ICE重启(第9.1节)会导致新的角色和决胜局的选择。
5.3.  Gathering Candidates
在应答者处收集候选人的过程与第4.1.1节(全面实施)和第4.2节(简化实施)所述的应答者过程相同。  建议这个过程在收到提议时立即开始，然后再提醒用户。  这种收集可以在代理启动时开始。
5.4.  Prioritizing Candidates
如第4.1.2节(全面实施)和第4.2节(简化实施)所述，应答者对候选人进行优先排序的过程与出价者遵循的过程相同。
5.5.  Choosing Default Candidates
答辩人选择缺省候选者的过程与出价人遵循的过程相同，如第4.1.4节(全面实施)和第4.2节(简易实施)所述。
5.6.  Encoding the SDP
在应答器处对SDP进行编码的过程，与第4.3节所述的完全实施和简化实施时应答器遵循的过程相同。
5.7.  Forming the Check Lists
形成检查列表仅由完全实现完成。  精简版的实现必须跳过本节中定义的步骤。
每个使用中的媒体流都有一个由offer-answer交换产生的检查列表。  为了形成一个媒体流的检查列表，代理形成候选对，计算候选对的优先级，按优先级排序，修剪它们，并设置它们的状态。
5.7.1.  Forming Candidate Pairs
首先，代理接受它的每一个媒体流的候选者(称为LOCAL CANDIDATES)，并将它们与它从对等者那里收到的该媒体流的候选者(称为REMOTE CANDIDATES)配对。  为了防止第18.5.2节中描述的攻击，代理可以限制它们在提供方回答中接受的候选者数量。  如果且仅当两个候选者具有相同的组件ID和具有相同的IP地址版本时，本地候选者才会与远程候选者配对。  有可能一些本地候选人不会与远程候选人配对，而一些远程候选人也不会与本地候选人配对。  如果一个代理不包括媒体流的所有组件的候选者，就会出现这种情况。  如果发生这种情况，该媒体流的组件数量就会有效减少，并被认为等于两个代理提供的媒体流所有组件的最大组件ID的最小值。
在RTP的情况下，当一个代理为RTCP提供候选者而另一个不提供时，就会发生这种情况。  另一个例子是，提供方可以在同一个端口上复用RTP和RTCP，并通过SDP属性[RFC5761]在SDP中发出信号，表明它可以这样做。然而，由于提供方不知道应答方是否可以执行这样的复用，所以提供方将RTP和RTCP的候选者分别包含在不同的端口上，这样，提供方在每个介质流上有两个组件。  如果应答者能够执行这样的多路复用，它将只为每个候选者包含一个组件--用于组合RTPRTCP mux。  ICE最终会表现为这个候选者只有一个单组件。
本地候选者和远程候选者都是某一特定组件的默认候选者的候选对，不出所料，被称为该组件的默认候选对。  如果两个代理都没有被ICE识别，这对候选对将被用来传输媒体。
为了帮助理解，图6显示了几个关键概念之间的关系 -- -- 传送地址、候选人、候选人对和核对表，此外还显示了候选人和候选人对的主要属性。
       +------------------------------------------+
       |                                          |
       | +---------------------+                  |
       | |+----+ +----+ +----+ |   +Type          |
       | || IP | |Port| |Tran| |   +Priority      |
       | ||Addr| |    | |    | |   +Foundation    |
       | |+----+ +----+ +----+ |   +ComponentiD   |
       | |      Transport      |   +RelatedAddr   |
       | |        Addr         |                  |
       | +---------------------+   +Base          |
       |             Candidate                    |
       +------------------------------------------+
       *                                         *
       *    *************************************
       *    *
     +-------------------------------+
    .|                               |
     | Local     Remote              |
     | +----+    +----+   +default?  |
     | |Cand|    |Cand|   +valid?    |
     | +----+    +----+   +nominated?|
     |                    +State     |
     |                               |
     |                               |
     |          Candidate Pair       |
     +-------------------------------+
     *                              *
     *                  ************
     *                  *
     +------------------+
     |  Candidate Pair  |
     +------------------+
     +------------------+
     |  Candidate Pair  |
     +------------------+
     +------------------+
     |  Candidate Pair  |
     +------------------+
5.7.2.  Computing Pair Priority and Ordering Pairs
CheckList图6：CheckList的概念图一旦形成了对子，就会计算出候选对子的优先级.让G是控制代理提供的候选者的优先级。  让D为被控代理提供的候选者的优先级。  一对候选者的优先级计算如下。
pair priority = 2^32*MIN(G,D) + 2*MAX(G,D) + (G>D?1:0)其中G>D?1:0是一个表达式，如果G大于D，其值为1，否则为0。  一旦分配了优先级，代理就按照优先级的递减顺序对候选对进行排序。  如果两个候选对的优先级相同，则它们之间的排序是任意的。
5.7.3.  Pruning the Pairs
候选对的排序列表用于确定将要执行的连接性检查序列。  由于代理不能直接从反射式候选者发送请求，而只能从它的基础上发送请求，所以代理接下来会检查候选者对的排序列表。  对于每一个本地候选者是服务器反射型的候选者对，服务器反射型候选者必须由它的基座替换。  一旦完成了这些工作，代理就必须对列表进行修剪。  如果一对候选者的本地和远程候选者与优先级列表上较高的一对候选者的本地和远程候选者完全相同，则删除该对候选者。  结果是一个有序的候选对序列，称为该媒体流的检查列表。
此外，为了限制第 18.5.2 节所述的攻击，代理必须将代理在所有检查列表中执行的连通性检查总数限制在一个特定的值上，而且这个值必须是可配置的。  建议使用默认值100。  这个限制是通过丢弃优先级较低的检查对来执行的，直到检查对少于 100 个。  建议在可能的情况下使用较低的值，设置为实际部署配置中可能出现的最大数量的可信检查。  对配置的要求是为了提供一个工具，以便在部署后发现该值有问题时，在实地对其进行修正。
5.7.4.  Computing States
检查表中的每一对候选者都有一个基础和一个状态，基础是该对候选者中本地和远程候选者的基础组合，状态是在计算出每个媒体流的检查表后分配的。  一旦计算出每个媒体流的检查表，就会分配状态。  状态可以有五种潜在的值。
等待。  尚未对该对进行检查，只要它是检查表上优先级最高的等待对，就可以进行检查。
正在进行中。  已经为这对夫妇发送了一张支票，但交易正在进行中。
成功了。  已经完成了对这对夫妇的检查，并产生了一个成功的结果。
失败。  该对的检查已经完成，但失败了，既没有产生任何响应，也没有产生一个不可恢复的失败响应。
冻结。  这个对子的检查还没有被执行，它不能被执行 直到其他检查成功，使这个对子解冻 并进入等待状态。
随着ICE的运行，对子将在状态之间移动，如图7所示。
      +-----------+
      |           |
      |           |
      |  Frozen   |
      |           |
      |           |
      +-----------+
            |
            |unfreeze
            |
            V
      +-----------+         +-----------+
      |           |         |           |
      |           | perform |           |
      |  Waiting  |-------->|In-Progress|
      |           |         |           |
      |           |         |           |
      +-----------+         +-----------+
                                  / |
                                //  |
                              //    |
                            //      |
                           /        |
                         //         |
               failure //           |success
                     //             |
                    /               |
                  //                |
                //                  |
              //                    |
             V                      V
      +-----------+         +-----------+
      |           |         |           |
      |           |         |           |
      |   Failed  |         | Succeeded |
      |           |         |           |
      |           |         |           |
      +-----------+         +-----------+
图7：配对状态FSMT对检查列表中的每个配对的初始状态进行计算，具体步骤如下。
1.  代理商将每个检查表中的所有对子都设置为冰冻状态。
2.  代理商检查第一个媒体流的核对表(当SDP提议和答复的第一行描述媒体流时，媒体流就是第一个媒体流)。  对于该媒体流。
* 对于具有相同基础的所有配对，它将具有最低组件ID的配对状态设置为等待。  如果有超过一个这样的对子，则使用优先级最高的那一个。
其中一个核对表将有一定数量的对子处于等待状态，而其他核对表将有所有的对子处于冻结状态。  一个至少有一对处于等待状态的检查表称为活动检查表，一个所有对子都处于冻结状态的检查表称为冻结检查表。
检查列表本身与一个状态相关联，它捕捉了该媒体流的ICE检查状态。  有三种状态。
正在运行。  在这种状态下，ICE检查仍在进行中 对于这个媒体流。
完成。  在这种状态下，ICE检查已经为媒体流的每一个组成部分产生了提名对。  因此，ICE检查成功，可以发送媒体。
Failed（失败）。  在这种状态下，ICE检查没有成功完成 这个媒体流。
当检查列表作为anofferanswer交换的结果首次被构造时，它被置于Running状态。
所有媒体流的ICE处理也有一个相关的状态。  当ICE处理进行时，该状态等于Running。  当 ICE 处理完成时，该状态为 Completed，如果没有成功，则为 Failed。  下面描述了在两种状态之间转换的规则。
5.8.  Scheduling Checks
检查仅由完全实现生成。  精简版的实现必须跳过本节中描述的步骤。
一个代理执行普通检查和触发检查。  这两种检查的产生都由一个定时器控制，定时器对每个媒体流周期性地开火。  代理商维护一个FIFOqueue，称为触发检查队列，其中包含候选者对，检查将在下一个可用的机会发送。  当定时器启动时，代理从触发检查队列中移除最前面的对，对该对进行连接性检查，并将候选对的状态设置为正在进行中。  如果触发检查队列中没有对，则发送普通检查。
一旦代理按照第5.7节的描述计算出了检查列表，它就会为每个活动的检查列表设置一个计时器，计时器每Ta*N秒发射一次，其中N是活动检查列表的数量（最初只有一个活动检查列表）。  定时器每隔Ta*N秒触发一次，其中N是活动检查列表的数量（最初，只有一个活动检查列表）。  实现者可以将定时器设置为比这更少的频率。  实现者应注意分散这些定时器，以便它们不会在每个媒体流的同一时间发射。  Ta和重传定时器RTO的计算方法如第16节所述。  乘以N，可以将总的检查吞吐量分摊到所有活动的检查列表中。  第一个定时器立即启动，这样，代理在交换要约和答复的瞬间就会执行连接性检查，然后在几秒钟后进行下一次检查Ta（因为只有一个活动的检查列表）。
当定时器响起，没有触发的检查要发送时，agent必须选择普通检查，如下图。
o 在该检查列表中找到处于等待状态的最高优先级的一对。
o 如果有这样一对。
* 从该对的本地候选者向该对的远程候选者发送STUN检查。  为此目的形成STUN请求的程序在第7.1.2节中描述。
* 将候选对的状态设为 "正在进行中"。
o 如果没有这样的对子。
*找出该检查表中处于冰冻状态的最高优先级的一对。
* 如果有这样一对。
＋解冻这一对。
＋对该对进行检查，使其状态转为进行中。
* 如果没有这种对子。
+ 终止该检查单的定时器。
为了计算检查的消息完整性，代理使用从SDP中从其peer那里学到的远程用户名片段和密码。  本地用户名片段由代理直接知道自己的候选者。
6.  Receipt of the Initial Answer
本节描述了代理在收到对等体的回答时遵循的程序。  它验证它的对等体是否支持ICE，确定它的角色，对于完整的实现，形成检查列表并开始执行普通检查。
当ICE与SIP一起使用时，分叉可能导致一个发价产生多个应答。  在这种情况下，ICE会对每个答案进行完全平行和独立的处理，把它的出价和每个答案的组合看作是一个独立的出价和答案交换，有它自己的一组对子、检查列表、状态等。  对一个对子的处理对另一个对子产生影响的唯一情况是释放考生，下文第8.3节将讨论。
6.1.  Verifying ICE Support
要约人的逻辑与第5.1节所述的应约人的逻辑相同，但要约人不会在SDP中产生a=ice不匹配的属性。
在某些情况下，回答者可能会省略媒体流的a=候选属性，而在SDP中为一个或多个媒体流包含一个a=ice不匹配属性。  这就向应答者发出信号，表明应答者支持ICE，但ICE处理没有用于会话，因为信令中介修改了媒体组件的默认目的地，而没有修改相应的候选属性。  关于这种情况的讨论请参见第18节。  本规范为代理在这种失败情况下应如何处理提供了指导。
6.2.  Determining Role
报价人遵循第5.2节中对答辩人所述的相同程序。
6.3.  Forming the Check List
核对表的形成仅由完全实施者进行。
6.4.  Performing Ordinary Checks
普通检查只由完全实现者进行。  要约人遵循第5.8节中对应约人描述的相同程序。
7.  Performing Connectivity Checks
本节介绍了如何进行连接性检查。  所有的ICE实现都必须符合[RFC5389]，而不是旧的[RFC3489]。  但是，一个完整的实现既能生成检查（作为STUN客户端）又能接收检查（作为STUN服务器），而一个精简的实现只能接收检查，因此只能作为STUN服务器。
7.1.  STUN Client Procedures
这些过程定义了代理如何发送连接性检查，是普通检查还是触发检查。  这些程序只适用于完整的实现。
7.1.1.  Creating Permissions for Relayed Candidates
如果连接性检查是使用中继的本地候选者发送的，客户机必须先创建一个权限，如果它之前还没有创建的话。  如果它告诉TURN服务器为给定的中继候选者朝远程候选者的IP地址创建一个权限，那么它之前就已经创建了一个权限。  为了创建这个权限，代理按照[RFC5766]中定义的程序进行。  该权限必须朝向远程候选者的 IP 地址创建。  建议代理延迟创建TURN通道，直到ICE完成，在这种情况下，通常使用CreatePermission请求创建连接性检查的权限。  一旦建立，代理必须保持该权限的活性，直到ICE结束。
7.1.2.  Sending the Request
检查是通过从本地候选者向远程候选者发送Binding请求来生成的。  RFC5389]描述了Bindingrequests是如何构造和生成的。  连接性检查必须使用STUN短期凭证机制。  支持与RFC 3489的向后兼容性的连接性检查必须不使用或假设。  连接性检查必须使用FINGERPRINT机制。
ICE 扩展了 STUN， 定义了几个新的属性， 包括 PRIORITY、 USE-CANDIDATE、 ICE-CONTROLLED 和 ICE-CONTROLLING。  这些新属性在第 19.1 节中正式定义， 其用法在下面的小节中描述。  这些 STUN 扩展只适用于用于 ICE 的连接性检查。
7.1.2.1.  PRIORITY and USE-CANDIDATE
代理人必须在它的Binding请求中包含PRIORITY属性，该属性必须设置为等于根据第4.1.2节中的算法，如果一个对等反射型候选者被学习到的话，将被分配的优先级（关于对等反射型候选者如何被学习，请参见第7.1.3.2.1节）。  这个优先级值的计算方法与计算该对本地候选者的优先级的方法相同，只是类型偏好被设置为对等反射候选者类型的值。
控制代理可以在 Binding 请求中包含 USE-CANDIDATE 属性。  被控代理不得在其绑定请求中包含该属性。  这个属性标志着控制代理希望停止对这个组件的检查，并对这个组件使用检查后得到的候选对。  第8.1.1节提供了确定何时包含它的指导。
7.1.2.2.  ICE-CONTROLLED and ICE-CONTROLLING
代理商必须在请求中包含ICE-CONTROLLED属性，如果它是受控角色，必须在请求中包含ICE-CONTROLLING属性。  Thecontent of either attribute MUST is the tie-breaker that wasdetermined in Section 5.2.  这些属性在第19.1节有完整的定义。
7.1.2.3.  Forming Credentials
作为连接检查的Binding请求必须使用STUN短期凭证机制。  该凭证的用户名由对等体提供的用户名片段和发送请求的代理的用户名片段连接而成，用冒号(":")分隔。  密码等于对等体提供的密码。  例如，考虑这样的情况：代理L是提供者，代理R是回答者。  Agent Lin为其候选人提供了一个LFRAG的用户名片段和LPASS的密码。  Agent R提供了一个RFRAG的用户名片段和一个RPASS的密码。  A connectivity check from L to R utilizes theusername RFRAG:LFRAG and a password of RPASS.  从R到L的连接性检查利用用户名LFRAG:RFRAG和密码RPASS。  回应使用与请求相同的用户名和密码(注意USERNAME属性在回应中不存在)。
7.1.2.4.  DiffServ Treatment
如果代理在itmedia数据包中使用Diffserv Codepoint标记[RFC2475]，它应该将这些相同的标记应用于itsconnectivity检查。
7.1.3.  Processing the Response
当收到Binding响应时，它会使用[RFC5389]中定义的事务ID与其Bindingrequest相关联，然后将其与发送Binding请求的候选对联系起来。
7.1.3.1.  Failure Cases
如果STUN事务产生487（角色冲突）错误响应，代理检查是否在Binding请求中包含ICE-CONTROLLED或ICE-CONTROLLING属性。  如果请求包含了ICE-CONTROLLED属性，代理必须切换到控制角色，如果它还没有这样做。  如果请求包含ICE-CONTROLLING属性，代理必须切换到受控角色，如果它还没有这样做。  一旦切换，代理必须将其检查产生487的候选对 enqueue 到触发的检查队列中。  该对的状态被设置为等待。  当触发检查被发送时，它将包含一个ICE-CONTROLLING或ICE-CONTROLLED属性，以反映它的新角色.但是，请注意，平局值必须不被重新选择。
角色的改变将要求代理重新计算配对的优先级(第5.7.2节)，因为这些优先级是控制和被控制角色的函数。  角色的变化还将影响代理是否负责选择提名的配对和在ICE结束后产生更新的要约。
代理商可以支持接收ICMP错误以进行连接性检查，如果STUN事务产生ICMP错误，代理商将该对的状态设置为Failed。  如果STUN事务产生一个不可恢复的STUN错误响应（如[RFC5389]中所定义）或超时，代理将该对的状态设置为Failed。
代理商必须检查响应的源IP地址和端口是否等于发送Binding请求的目的IP地址和端口，响应的目的IP地址和端口是否与发送Binding请求的源IP地址和端口相匹配。  换句话说，请求和响应中的源和目的传输地址是对称的。  如果它们不对称，代理会将该对的状态设置为Failed。
7.1.3.2.  Success Cases
如果以下所有情况都为真，则认为检查成功。
o STUN交易产生了一个成功的响应。
o 响应的源IP地址和端口等于Binding请求到达的目的IP地址和端口。
o 响应的目标IP地址和端口与发出Binding请求的源IP地址和端口一致。
7.1.3.2.1.  Discovering Peer Reflexive Candidates
代理商检查STUN响应中的映射地址。  如果传输地址与代理知道的任何本地候选者不匹配，映射地址就代表一个新的候选者--对等反身候选者。  像其他候选者一样，它有一个类型、基础、优先级和基础。  它们的计算方法如下。
o 它的类型等于同行的反身性。
o 它的基数被设置为等于发送STUN检查的候选人对的本地候选人。
o 它的优先级被设置为等于Binding请求中PRIORITY属性的值。
o 其地基按4.1.1.3节所述选择。
然后，这个对等反身候选者被添加到媒体流的本地候选者列表中。  它的用户名片段和passworda与该媒体流的所有其他本地候选者相同。
但是，同行反身候选者不会与其他远程候选者配对。  这没有必要；根据第7.1.3.2.2节中的程序，将从它瞬间生成一个有效的配对。  如果代理希望将对等反射候选者与除将生成的有效对中的候选者之外的其他远程候选者配对，代理可以生成一个包括对等反射候选者的更新提议。  这将导致它与所有其他远程候选者配对。
7.1.3.2.2.  Constructing a Valid Pair
代理人构建一个候选对，其本地候选者等于响应的映射地址，其远程候选者等于发送请求的目的地址。  这被称为有效对，因为它已经被STUN连接性检查验证。  有效对可能等于产生检查的对，可能等于检查列表中的另一个对，也可能是当前不在任何检查列表中的对。  如果对子等于产生检查的对子或当前在检查列表中，它也会被添加到VALID LIST中，该列表由代理为每个媒体流维护。  这个列表在ICE处理开始时是空的，当检查被执行时，这个列表就会被填充，从而产生有效的候选对。
这将是非常常见的情况，即该对将不在任何检查列表中.回顾一下，检查列表中有一些本地候选者不属于服务器反义的对；这些对的本地候选者已被转换为服务器反义候选者的基础，如果它们是冗余的，则被修剪。  当STUN检查的响应到达时，如果两者之间有NAT，则映射的地址将是reflexive.在这种情况下，有效的对将有一个本地候选者，它不匹配检查列表中的任何对。
如果对子不在任何检查列表上，代理根据每个候选者的优先级，使用5.7节中的算法计算对子的优先级。  本地候选者的优先级取决于其类型。  如果它不是对等反射的，它等于SDP中为该候选者发出的优先级信号。  如果是peerreflexive，则等于代理在刚刚完成的Binding请求中放置的priority属性。  远程候选者的优先级取自对等体的SDP。  如果候选者没有出现在那里，那么检查一定是对一个新的远程候选者的触发检查。  在这种情况下，优先级被取为触发刚刚完成的检查的Binding请求中PRIORITY属性的值。  然后，这对候选者会被添加到VALIDLIST中。
7.1.3.2.3.  Updating Pair States
代理人将*产生*检查的对的状态设置为Succeeded。  请注意，作为响应的结果，*产生*检查的对可能与第7.1.3.2.2节中构造的有效对不同。  这个检查的成功可能会导致其他检查的状态也发生变化。  代理人必须执行以下两个步骤。
1.  代理商将同一媒体流和同一基础的所有其他冻结对的状态改为等待。  通常情况下，但并不总是如此，这些其他的冻结对将有不同的组件ID。
2.  2. 如果该媒体流的每一个组成部分在有效清单中都有一个对子(这是指正在使用的实际组成部分数目，在SDP中发出信号的组成部分数目因发包人和应答人而异的情况下)，这项检查的成功可以解除对其他媒体流的检查。  请注意，这个步骤不仅是在被考虑的有效列表第一次有每个组件的对子时才会被跟踪，而且在检查成功并增加另一个对子时也会被跟踪。  代理商依次检查每个媒体流的检查列表。
* 如果检查列表处于活动状态，则代理将该检查列表中所有基础与考虑中的有效列表中的对子相匹配的Frozen对子的状态改为Waiting。
* 如果检查列表被冻结，并且检查列表中至少有一个对子的基础与考虑中的有效列表中的对子相匹配，则检查列表中所有对子的基础与考虑中的有效列表中的对子相匹配的状态被设置为等待。  这将导致检查表处于活动状态，并开始对其进行普通检查，如5.8节所述。
* 如果检查列表被冻结，并且在检查列表中没有与考虑的有效列表中的对子基础相匹配的对子，则代理+将所有具有相同基础的对子分组，并且+对每个分组，将具有最低成分ID的对子的状态设置为等待。  如果有多个这样的对子，则使用优先级最高的那一个。
7.1.3.2.4.  Updating the Nominated Flag
如果该代理是控制代理，并且在 Binding 请求中包含了 USE-CANDIDATE 属性，那么从该检查中生成的有效对的提名标志就会被设置为 true。  这个标志表明，如果这个有效对是提名标志被设置的媒体中优先级最高的，那么它就应该被用于媒体。  这可以结束对该媒体流或所有媒体流的 ICE 处理，参见第 8 节。
如果该代理是受控代理，则响应可能是触发检查的结果，而该检查是为了响应一个本身具有 USE-CANDIDATE 属性的请求而发送的。  这种情况在第 7.2.1.5 节中有描述，现在可能会导致为从原始请求中学习到的对设置指定标志。
7.1.3.3.  Check List and Timer State Updates
无论检查是成功还是失败，交易的完成都可能需要更新检查清单和定时器状态。
如果现在检查列表中的所有对子都处于Failed或Succeeded状态。
o 如果他们媒体流的每个组件的有效列表中没有一对，则检查列表的状态被设置为Failed。
o 对于每个冻结的检查列表，代理*将具有相同基础的所有对子分组，*对于每个分组，将具有最低成分ID的对子的状态设置为等待。  如果有多个这样的对子，则使用优先级最高的那一个。
如果检查列表中没有一个对处于等待或冻结状态，则检查列表不再被认为是活动的，并且在计算第5.8节所述的普通检查的定时器时将不计入N的值。
7.2.  STUN Server Procedures
代理商必须准备好接收基于它最近的提议或回答中包含的每个候选人的Binding请求。  即使对等体是一个精简的实现，这个要求也是有效的。
代理商必须使用一个短期凭证来验证该请求，并执行消息完整性检查。  如果用户名由两个用冒号分隔的值组成，代理必须认为用户名是有效的，其中第一个值等于代理在一个正在进行的会话的提议或回答中生成的用户名片段。  一个offerer有可能(事实上也很有可能)在收到同行的回答之前收到一个Binding请求。  如果发生这种情况，代理必须立即生成响应（包括计算第7.2.1.2节中描述的映射地址）。  代理商在这一点上有足够的信息来生成响应；不需要来自对等体的密码。  一旦收到响应，它必须继续执行所需的其余步骤，即7.2.1.3、7.2.1.4和7.2.1.5（对于完整的实现）。  如果在回答之前收到多个STUN请求，可能会导致触发检查队列中的多个对子排队。
代理商不得利用ALTERNATE-SERVER机制，不得支持RFC 3489的后向兼容机制。  它必须利用FINGERPRINT机制。
如果代理在媒体数据包中使用Diffserv Codepoint标记[RFC2475]，它应该将这些标记应用于对Binding请求的响应。  这同样适用于终端可能应用于媒体数据包的任何第2层标记。
7.2.1.  Additional Procedures for Full Implementations
本小节定义了适用于全面实施的附加服务器程序。
7.2.1.1.  Detecting and Repairing Role Conflicts
通常，第5.2节中的角色选择规则将导致每个代理选择不同的角色--一个是控制角色，一个是被控制角色。  然而，在不寻常的呼叫流中，通常利用第三方呼叫控制，有可能两个代理选择同一个角色。  本节介绍了检查这种情况和修复它的程序。
代理商必须检查ICE-CONTROLLING或ICE-CONTROLLED属性的Binding请求。  它必须遵循这些程序。
o 如果该请求中既没有出现ICE-CONTROLLING，也没有出现ICE-CONTROLLED，那么对等代理可能已经实现了该规范的以前版本。  可能存在冲突，但不能被检测到。
o 如果代理处于控制角色，并且请求中存在ICE-CONTROLLINGattribute。
* 如果代理的平局大于或等于ICE-CONTROLLING属性的内容，代理就会产生一个Binding错误响应，并包含一个ERROR-CODE属性，其值为487（角色冲突），但保留其角色。
* 如果代理的平局小于ICE-CONTROLLING属性的内容，代理将切换到受控角色。
o 如果代理处于受控角色，且请求中存在ICE-CONTROLLEDattribute。
* 如果代理的平局大于或等于ICE-CONTROLLED属性的内容，代理就会切换到控制角色。
* 如果代理的平局小于ICE-CONTROLLED属性的内容，代理就会产生一个Binding errorresponse，并包含一个值为487（角色冲突）的ERROR-CODE属性，但保留其角色。
o 如果代理处于受控角色，且请求中存在ICE-CONTROLLING属性，或者代理处于受控角色，且请求中存在ICE-CONTROLLED属性，则不存在冲突。
角色的改变将要求代理重新计算配对的优先级(第5.7.2节)，因为这些优先级是控制和被控制角色的函数。  角色的变化还将影响代理是否负责选择提名的配对和在ICE结束后生成更新的报价。
如果服务器对Binding请求产生了成功的响应，即使agent改变了角色，也要遵循第7.2.1节的其余部分。
7.2.1.2.  Computing Mapped Address
对于在中继候选者上收到的请求，用于STUN处理的源传输地址（即生成XOR-MAPPED-ADDRESS属性）是TURN服务器看到的传输地址。  如果Binding请求是通过数据指示传递的，则该源传输地址将存在于数据指示消息的XOR-PEER-ADDRESS属性中。  如果Binding请求是通过ChannelData消息传递的，那么源传输地址就是与通道绑定的那个地址。
7.2.1.3.  Learning Peer Reflexive Candidates
如果请求的源传输地址不匹配任何现有的远程候选者，则代表一个新的对等反射远程候选者。  这个候选者的构造如下。
o 候选人的优先级设置为请求中的PRIORITY属性。
o 候选人的类型被设置为同行反省。
o 候选者的基础被设置为一个任意值，不同于所有其他远程候选者的基础。  如果随后的任何要约回答交换在SDP中包含这个对等反射候选者，它将发出该候选者实际基础的信号。
o 该候选人的组件ID被设置为发送请求的本地候选人的组件ID。
这个候选者被添加到远程候选者列表中。  但是，代理不会将该候选人与任何本地候选人配对。
7.2.1.4.  Triggered Checks
接下来，代理构建了一个对，其本地候选者等于收到STUN请求的传输地址，而远程候选者等于该请求来自的源传输地址（可能是刚刚学到的对等反射远程候选者）。  本地候选者将是一个主机候选者(对于请求不是通过arelay收到的情况)或中继候选者(对于通过中继收到的情况)。  本地候选者永远不可能是服务器反射候选者（reflexivecandidate）。  由于这两个候选者都是代理已知的，它可以获取它们的优先级，并计算出候选者对的优先级，然后在检查列表中查找这对候选者。  可以有以下几种结果之一。
o 如果对子已经在核对表上。
* 如果该对的状态是等待或冻结，则该对的检查将被排入触发的检查队列中，如果还没有出现。
* 如果该对的状态为正在进行中，代理将取消正在进行中的事务。  取消意味着代理将不会重新发送请求，不会将没有响应视为失败，而是等待交易超时的持续时间以获得响应。  此外，代理必须为该对创建一个新的连接性检查(代表一个新的STUN Binding请求事务)，将该对在触发的检查队列中排队。  然后，该对的状态将被改变为等待。
* 如果该对的状态为Failed，则改为Waiting，代理必须为该对创建一个新的连接性检查（代表一个新的STUN Binding请求事务），通过在触发的检查队列中排队该对。
* 如果该对的状态为成功，则不做任何进一步处理。
这些步骤是为了在两个代理都在NAT后面时，方便快速完成ICE。
o 如果核对表上没有该对子。
* 根据优先次序将该对子列入核对表。
* 其状态设置为等待。
* 该对被列入触发的检查队列。
当要发送触发检查时，按照第7.1.2节的规定进行构建和处理。  这些程序要求代理知道传输地址、用户名片段和同行的密码。  远程候选者的用户名片段等于刚刚收到的Binding请求中USERNAME的冒号后的部分。  使用该用户名片段，代理可以检查从其对等体收到的SDP消息（在分叉的情况下可能有多个），并找到这个用户名片段。  然后选择对应的密码。
7.2.1.5.  Updating the Nominated Flag
如果代理收到的 Binding 请求中设置了 USE-CANIDATEattribute，并且代理处于受控角色，则代理会查看第 7.2.1.4 节中计算出的 pair 的状态。
o 如果该对的状态是Succeeded，则意味着该对产生的检查结果产生了一个成功的响应，这将使代理在收到该成功响应时构建一个有效的对（见7.1.3.2.2节）。  当收到成功响应时，这将导致代理构建一个有效对（见7.1.3.2.2节）。  代理人现在将有效对中的提名标志设置为真。  这可能会结束对该媒体流的ICE处理；见第8节。
o 如果这个对的状态是In-Progress，如果它的检查产生了一个成功的结果，当响应到达时，产生的有效对有它指定的标志集。  当该媒体流到达时，这可能会结束ICE对该媒体流的处理；见第8节。
7.2.2.  Additional Procedures for Lite Implementations
如果刚刚收到的检查中包含了 USE-CANDIDATE 属性，则代理会构造一个候选对，其本地候选对等于接收请求的传输地址，其远程候选对等于接收请求的源传输地址。  这对候选者被赋予一个任意的优先级，并被放入一个称为有效列表的有效候选者列表中。  代理将该对的提名标志设置为真。  如果有效列表中包含每个组件的候选对，则认为对媒体流的ICE处理已经完成。
8.  Concluding ICE Processing
本节介绍代理如何完成ICE。
8.1.  Procedures for Full Implementations
结论ICE涉及到控制者提名对和国家机器的更新。
8.1.1.  Nominating Pairs
控制代理通过使用两种技术中的一种来提名要被ICE选择的对子：常规提名或激进提名.如果它的同行有一个精简的实现，代理必须使用常规提名算法。  如果它的对等体正在使用ICE选项(存在于对等体的ice-options属性中)，而代理不理解，代理必须使用常规提名算法。  如果它的对等体是一个完整的实现，并且没有使用任何ICE选项，或者使用的是代理理解的ICE选项，代理可以使用激进或常规提名算法。  然而，建议使用常规算法，因为它提供了更大的稳定性。
8.1.1.1.  Regular Nomination
对于常规的提名，代理会让一些检查完成，每个检查都会省略 USE-CANDIDATE 属性。  一旦一个或多个检查成功完成，就会生成有效的对，并添加到有效列表中。  代理人让检查继续进行，直到满足某个停止标准，然后根据评估标准在有效对中挑选。  停止检查的标准和评估有效对的标准完全是一个局部优化的问题。
当控制代理选择有效的对子时，它会重复产生这个有效对子的检查（通过将产生检查的对子列入触发检查队列），这次使用 USE-CANDIDATE 属性。  这次的检查应该会成功 (因为之前的检查已经成功了)， 从而导致该对的提名标志被设置。  因此， 每个组件的有效列表中只有一个被提名的对子， 当检查列表的状态转为已完成时， 该对子将被 ICE 选为该组件的收发媒体。
常规提名提供了最大的灵活性，因为代理可以控制检查的停止和选择标准。  唯一的要求是，代理必须最终选择一个且仅有一个候选对，并为该对生成一个带有 USE-CANDIDATE 属性的检查。  Regular nomination 还提高了 ICE 对实现变化的弹性（见第 14 节）。  Regularnomination 也更稳定，允许两个代理收敛在媒体的单一对上，而不会出现激进算法可能出现的瞬时选择。  regularnomination的缺点是，它保证会增加延迟，因为它需要做额外的检查。
8.1.1.2.  Aggressive Nomination
在积极提名的情况下，控制代理会在每次发送的检查中加入 USE-CANDIDATE 属性。  一旦一个组件的第一次检查成功，它就会被添加到有效列表中，并被设置为提名标志。  当所有的组件在有效列表中都有一个提名对时，媒体就可以使用优先级最高的提名对开始流动。  然而，由于代理在所有的检查中都包含了 USE-CANDIDATE 属性，因此另一个检查可能会完成，导致另一个有效的对子的提名标志被设置。  因此，在ICE检查完成后，所选的对子实际上可能会发生短暂的变化，导致一组瞬时的选择，直到它稳定下来。
8.1.2.  Updating States
对于控制代理和被控制代理来说，ICE处理的状态取决于有效列表中是否存在被提名的候选对以及检查列表的状态。  需要注意的是，在任何时候，以下几种情况都可以适用。
o 如果一个介质流的有效列表中没有提名对，且检查列表的状态为Running，则ICE处理继续进行。
o 如果在amedia流的有效列表中至少有一个被提名的对子，并且检查列表的状态是Running。
* 代理商必须删除检查表和触发检查队列中的所有等待和冻结对，作为该媒体流的指定对。
* 如果检查列表中的正在进行中的对子与提名对子属于同一组件，如果对子的优先级低于该组件的最低优先级提名对子，代理应停止对其检查的传输。
o一旦有效列表中至少有一个被提名的对子，永远是至少一个媒体流的组成部分，并且检查列表的状态是运行。
* 代理商必须将该媒体流的检查表的处理状态改为Completed。
* 代理商必须继续响应它可能仍然收到的对该媒体流的任何检查，并且如果第7.2节的处理要求，必须执行触发检查。
* 代理商必须继续为该检查清单重传任何进行中检查。
* 代理商可按照第11.1节所述，开始为该媒体流传输媒体。
o 一旦每个核对表的状态为完成。
* 代理人将ICE处理的整体状态设置为Completed。
* 如果一个代理是控制性的，它将检查每个介质流的每个组成部分的最高优先级提名的候选对。  如果这些候选对中的任何一对与最近一次报价答辩交换中的默认候选对不同，控制代理必须按照第9节的规定生成更新的报价。  如果控制代理使用的是激进的提名算法，这可能会导致几个更新的报价，因为为媒体选择的对发生变化。  代理商可以延迟发送要约一个短暂的时间间隔（建议一秒），以便让选定的对子稳定下来。
o 如果检查列表的状态为Failed，则ICE无法完成该媒体流的检查。  正确的行为取决于其他媒体流的检查列表的状态。
* 如果所有的检查列表都是Failed，ICE处理总体上被认为是处于Failed状态，代理应该认为会话是失败的，不应该重新启动ICE，控制代理应该终止整个会话。
* 如果其他媒体流的检查清单中至少有一项是 "完成"，则控制机构应在其更新的报价中从会话中删除失败的媒体流。
* 如果其他媒体流的检查列表都没有完成，但至少有一个正在运行，代理应该让ICE继续。
8.2.  Procedures for Lite Implementations
结论ICE的精简实现是相对直接的。  有两种情况需要考虑。
实施的是精简版，而其同行的是完整版。
实施是精简的，其同行也是精简的。
ICE结论的效果是，代理可以释放任何没有被ICE利用的分配主机候选者，如第8.3节所述。
8.2.1.  Peer Is Full
在这种情况下，代理将收到来自其同行的连接性检查。  当代理收到包含媒体流中每个组件的 USE-CANDIDATE 属性的连接检查时，该媒体流的 ICE 处理状态就会从 Running 转为 Completed。  当所有媒体流的 ICE 处理状态为 Completed 时，ICE 处理的整体状态为 Completed。
精简的实现永远不会自己确定一个媒体流的ICE处理已经失败；相反，完整的对等体将做出这一决定，然后在随后的提议中删除或重新启动失败的媒体流。
8.2.2.  Peer Is Lite
一旦要约和答复交换完成，两个代理都会检查自己的候选人和同行的候选人。  对于每个媒体流，每个代理将自己的候选者与该媒体流中的同行候选者配对。  当两个候选者为同一组件，使用相同的传输协议（本规范中为UDP），并且来自相同的IP地址系列（IPv4或IPv6）时，它们将被配对。
o 如果每个组件只有一个对子，则该对子被添加到Valid列表中。  如果一个媒体流的所有组件都只有一对，则该媒体流的ICE处理状态被设置为Completed。  如果所有媒体流都是Completed，则ICE处理的状态总体上被设置为Completed。  对于仅有IPv4的实现来说，情况总是如此。
o 如果每个组件有一对以上。
* 代理商必须根据本地策略选择一对。  由于这种情况只出现在IPv6上，建议代理遵循RFC3484[RFC3484]的程序选择单对。
* 代理商将每个组件的选定对添加到有效列表中。  如第11.1节所述，这将允许媒体开始流动。  但是，两个代理可能（事实上也很可能）选择了不同的线对。
* 为了解决这个问题，控制机构必须按照第9.1.3节的规定发送更新后的报价，其中将包括远程候选人属性。
* 代理商在发送offer时，不得更新ICE处理状态。  如果此后的要约完成，控制代理必须将所有媒体流的ICE处理状态改为Completed，ICE处理的整体状态改为Completed。  受控代理的状态是根据第9.2.3节的逻辑来设置的。
8.3.  Freeing Candidates
8.3.1.  Full Implementation Procedures
第8节中的程序要求代理继续监听STUN请求，并继续对媒体流产生触发检查，即使对该流的处理完成后也是如此。  本节中的程序描述了什么时候代理可以安全地停止在一个没有被ICE选择的候选者上发送或接收检查，然后释放该候选者。
当ICE与SIP一起使用时，并且一个提议被分叉到多个收件人，ICE将对每个应答者进行并行和独立的处理，所有应答者都使用相同的本地候选者。  一旦使用这些候选者的媒体流的所有对等体的ICE处理达到完成状态，代理应该再等待三秒钟，然后它可以停止响应该候选者的检查或生成触发检查。  它可以在那个时候释放候选者。释放服务器反射候选者从来都不是显式的，而是在缺乏keepalive的情况下发生的。  三秒的延迟处理了使用aggressive nomination时的情况，并且在ICE完成后，所选的对子可以迅速改变。
8.3.2.  Lite Implementation Procedures
一个精简的实现可以释放没有被ICE选择的候选者，只要ICE处理达到了所有对等体使用这些候选者的媒体流的完成状态。
9.  Subsequent Offer/Answer Exchanges
任何一个代理都可以在RFC 3264[RFC3264]允许的任何时候产生一个后续提议。  第8节中的规则将使控制代理在ICE处理结束时，当ICE从默认对中选择了不同的候选对时，发送更新的提议。  本节定义了构造随后的提议和回答的规则。
如果随后的提议被拒绝，移民局的处理将继续进行，就像从未提出过随后的提议一样。
9.1.  Generating the Offer
9.1.1.  Procedures for All Implementations
9.1.1.1.  ICE Restarts
代理商可以重新启动现有媒体流的ICE处理。  顾名思义，ICE重启将导致ICE处理的所有先前状态被刷新，检查重新开始。  ICE重启和一个全新的媒体会话之间的唯一区别是，在重启期间，媒体可以继续发送到先前验证过的媒体对。
在以下情况下，代理必须重新启动媒体流的ICE： 1:
o 生成报价的目的是为了改变媒体流的目标。  换句话说，如果一个代理想要生成一个更新的报价，如果没有使用ICE，就会导致媒体组件的目标值发生变化。
o 代理商正在改变其执行级别。  这种情况通常发生在第三方呼叫控制用例中，即执行信令的实体不是接收媒体的实体，而且它在会话中改变了媒体的目标，换成了另一个有不同ICE实现的实体。
这些规则意味着，将c行中的IP地址设置为0.0.0.0将导致ICE重启。  因此，ICE实现不得利用这种机制进行呼叫保持，而必须使用[RFC3264]中描述的a=inactive和a=sendonly。
要重启ICE，代理必须同时更改一个offer中媒体流的ice-pwd和ice-ufrag。  请注意，允许在一个offer中使用会话级属性，但在随后的offer中提供相同的ice-pwd或ice-ufrag作为媒体级属性。  这不是密码的改变，只是改变了它的表示方式，并且不会导致ICE的重新启动。
代理商为该媒体流设置SDP中的其余字段，就像在该媒体流的初始报价中一样（见第4.3节）。  因此，候选者集合可能包括该媒体流的一些、没有或所有以前的候选者，也可能包括按第4.1.1节所述收集的全新的候选者集合。
9.1.1.2.  Removing a Media Stream
如果代理通过将媒体流的端口设置为零来删除媒体流，它必须不包括该媒体流的任何候选属性，也不应该包括第15节中为该媒体流定义的任何其他ICE相关属性。
9.1.1.3.  Adding a Media Stream
如果代理想要添加一个新的媒体流，它就会在SDP中为这个媒体流设置字段，就像这是一个媒体流的初始报价一样（见4.3节）。  这将导致该媒体流的ICE处理开始。
9.1.2.  Procedures for Full Implementations
本节介绍了全面实施的其他程序，涵盖现有的媒体流。
用户名片段、密码和执行级别必须保持与之前使用的相同。  如果代理需要改变这些内容，它必须重新启动该媒体流的ICE。
其他行为取决于该媒体流的状态ICE处理。
9.1.2.1.  Existing Media Streams with ICE Running
如果代理生成一个更新的报价，其中包括一个先前建立的媒体流，并且对于该媒体流，ICE检查处于Running状态，代理将遵循这里定义的程序。
代理商必须包括其先前为该媒体流发出信号的所有本地候选者的候选属性。  该候选者在SDP中发出信号的属性--优先级、基础、类型和相关传输地址--必须保持不变。  IP地址、端口和传输协议，从根本上标识该候选者，必须保持不变（如果它们发生变化，那将是一个新的候选者）。  组件ID必须保持不变。  代理商可以包含它之前没有提供的，但它在上次交换offer-answer后收集到的额外候选者，包括同行反身候选者。
代理商可以改变媒体的默认目的地。  作为初始报价内，报价中必须有一组候选属性与该默认目的地相匹配。
9.1.2.2.  Existing Media Streams with ICE Completed
如果代理生成一个更新的报价，包括先前建立的媒体流，并且ICE检查处于完成状态，代理将遵循这里定义的程序。
媒体的默认目的地（即m和c行中用于该媒体流的IP地址和端口的值）必须是每个组件的有效列表中优先级最高的提名对中的本地候选人。  这就 "固定 "了媒体的defaultdestination，使其等于ICE所选择的目的地formedia。
代理必须包括与媒体流的每个组件的默认目的地相匹配的候选者属性，而不能包括任何其他候选者。
此外，如果代理是控制者，它必须为检查列表处于完成状态的每个媒体流包含a=远程候选者属性。  该属性包含该媒体流的每个组件的有效列表中最高优先级的提名对中的远程候选者。  它需要避免race条件，即控制代理选择其对，但更新后的offer击败了对被控代理的连接性检查，而被控代理甚至不知道这些对是有效的，更不用说oneselected了。  关于这种竞赛条件的阐述参见附录B.6。
9.1.3.  Procedures for Lite Implementations
9.1.3.1.  Existing Media Streams with ICE Running
本节介绍了对ICE运行的现有流进行精简实现的程序。
一个精简的实现必须在任何后续提供中的a=candidate属性中包含其对每个媒体流的每个组件的所有候选者。  这些候选者的形成与第4.2节中描述的初始报价的程序相同。
一个精简的实现不得在随后的提供中添加额外的主机候选者。  如果一个代理需要提供额外的候选者，它必须重新启动ICE。
用户名片段、密码和执行级别必须保持与之前使用的相同。  如果代理需要改变这些内容，它必须重新启动该媒体流的ICE。
9.1.3.2.  Existing Media Streams with ICE Completed
如果ICE已经完成了一个媒体流，该媒体流的默认目的地必须设置为有效列表中该组件的候选对的远程候选。  对于精简的实施，在有效列表中，媒体流的每个组件总是只有一个候选对。  此外，agent必须为每个defaultdestination包含一个候选属性。
此外，如果代理是控制型的（只有当两个代理都是精简型的时候才会发生），代理必须为每个媒体流包含a=remote-candidatesattribute。  该属性包含有效列表中的候选对中的远程候选（每个媒体流的每个组件都有一对）。
9.2.  Receiving the Offer and Generating an Answer
9.2.1.  Procedures for All Implementations
当在现有会话中收到后续报价时，代理必须重新应用第5.1节中的验证程序，而不考虑之前任何报价回复交换的验证结果。  事实上，有可能之前的报价答辩交换导致ICE没有被使用，但它是作为后续交换的一个结果被使用。
9.2.1.1.  Detecting ICE Restart
如果该提议包含的a=ice-ufrag或a=ice-pwdattributes与之前来自对等体的SDP相比发生了变化，则表明该媒体流的ICE正在重启。  如果所有的媒体流都在重启，则说明ICE整体在重启。
如果ICE是为了一个媒体流而重新启动。
o 代理商必须改变答案中的a=ice-ufrag和a=ice-pwd属性。
o 代理商可以在答案中改变其执行级别。
代理商为该媒体流设置SDP中的其余字段，就像在对该媒体流的初始回答中一样（见第4.3节）。  因此，候选者集合可能包括该媒体流的一些、没有或所有以前的候选者，也可能包括按第4.1.1节所述收集的全新的候选者集合。
9.2.1.2.  New Media Stream
如果报价中包含一个新的媒体流，则代理将答案中的字段设置为它已收到包含该媒体流的初始报价（见第4.3节）。  这将导致ICE对该媒体流的处理开始。
9.2.1.3.  Removed Media Stream
如果一个报价包含一个端口为零的媒体流，代理必须不在其答案中包含该媒体流的任何候选属性，并且不应包含第15节中为该媒体流定义的任何其他ICE相关属性。
9.2.2.  Procedures for Full Implementations
除非代理已经从offer中检测到ICE重启，否则用户名碎片、密码和执行级别必须与之前使用的相同。  如果代理需要改变其中之一，它必须通过生成一个offer来重新启动该媒体流的ICE；ICE不能在应答中重新启动。
其他行为取决于该媒体流的ICE处理状态。
9.2.2.1.  Existing Media Streams with ICE Running and no remote-
candidatesI如果ICE正在运行一个媒体流，而该媒体流的报价缺乏远程-candidates属性，则答案的构造规则与第9.1.2.1节中描述的报价者的规则相同。
9.2.2.2.  Existing Media Streams with ICE Completed and no remote-
candidatesIf ICE is Completed for a media stream, and the offer for that mediastream lacked the remote-candidates attribute, the rules forconstruction of the answer is identical to those for the offerer asdescribed in Section 9.1.2.2, except that the answerer MUST NOTinclude the a=remote-candidates attribute in the answer.
9.2.2.3.  Existing Media Streams and remote-candidates
受控代理将在其对等者结束对媒体流的ICE处理时，收到一个带有a=remote-candidatesattribute的offer，这个属性存在于offer中，以处理收到offer和收到Binding响应之间的竞赛条件。  这个属性出现在offer中是为了处理收到offer和收到Binding响应之间的竞赛条件，Binding响应告诉应答者ICE将选择的候选者。  这种竞赛条件的解释见附录B.6。  因此，带有该属性的offer的处理取决于竞赛的获胜者。
代理人通过以下方式为介质流中的每个组件形成一个候选对：
o 将远程候选者设置为等于该组件的要约人的defaultdestination（例如，RTP的m和clines的内容，以及RTCP的a=rtcp属性）o 将本地候选者设置为等于要约人a=remote-candidates属性中的同一组件的传输地址。
然后，代理查看这些候选对是否存在于有效列表中。  如果某个特定的对子不在有效列表中，那么check就 "输掉 "了比赛。  称这样的对子为 "输掉的对子"。
代理人在检查列表中找到所有的对，其远程候选者等于输掉对中的远程候选者。
o 如果没有一个对子是In-Progress，而至少有一个是Failed，那么很可能发生了网络故障，如网络分割或严重的数据包丢失。  代理商应该为这个媒体流生成一个答案，就像远程-候选属性不存在一样，然后为这个流重新启动ICE。
o 如果至少有一个对子在进行中，代理应该等待这些检查完成，当每个检查完成后，重新做本节的处理，直到没有丢失的对子。
一旦没有输掉的对子，代理就可以生成答案.它必须将媒体的默认目的地设置为offer中的候选者inthe remote-candidates属性(每个候选者都将成为有效列表中候选者对的本地候选者).它必须在答案中为offer中远程候选者属性中的每个候选者包含一个候选者属性。
9.2.3.  Procedures for Lite Implementations
如果接收到的报价中包含了媒体流的远程候选属性，则代理通过以下方式为媒体流的每个组件形成候选对。
o 将远程候选者设置为等于提供方对该组件的defaultdestination（例如，对于RTP的m和clines的内容，对于RTCP的a=rtcp属性）。
o 将本地候选人与offer中a=remote-candidates属性中的同一组件的传输地址相等。
然后，它将这些候选者放入该媒体流的有效列表中。  该媒体流的ICE处理状态被设置为Completed。
此外，如果代理认为自己是控制者，但offer中包含了远程-candidates属性，则两个代理都认为自己是控制者。  在这种情况下，两者会在同一时间发送更新的offer。  然而，携带offeranswer交换的信令协议将解决这个眩光条件，sothat一个代理总是 "赢家"，因为它的offer在它的同行发送offer之前就已经收到了。  赢家占据了受控的角色，因此输家（本节考虑的应答者）必须改变其角色为受控。  因此，如果代理要发送更新的要约，因为根据第8.2.2节的规则，它是控制的，它不再需要发送更新的要约。
除了潜在的角色变化、Valid列表中的变化和状态变化之外，答案的构建与Section 9.1.3中描述的offer的构建是一样的。
9.3.  Updating the Check and Valid Lists
9.3.1.  Procedures for Full Implementations
9.3.1.1.  ICE Restarts
代理商必须在重启之前记住媒体流中每个组件的有效列表中优先级最高的提名对，称为先前选择的对。  如第11.1节所述，代理将继续使用这些对发送媒体。  一旦记下这些目的地，代理MUST就会刷新有效列表和检查列表，然后重新计算检查列表及其状态，如第5.7节所述。
9.3.1.2.  New Media Stream
如果offeranswer exchange添加了一个新的媒体流，代理必须为它创建一个新的检查列表（和一个空的Valid列表开始ofcourse），如5.7节所述。
9.3.1.3.  Removed Media Stream
如果要约和答复交换删除了一个媒体流，或者答复拒绝了一个要约媒体流，代理必须刷新该媒体流的有效列表。  它必须终止该媒体流的任何正在进行的STUN交易。  代理商必须删除该媒体流的检查列表，并取消该媒体流的任何未决普通检查。
9.3.1.4.  ICE Continuing for Existing Media Stream
除非ICE重新启动，否则有效列表不受更新后的交换报价影响。
如果代理处于该媒体流的运行状态，则更新检查列表（如果状态已完成，则检查列表无关紧要）。  为此，代理使用第 5.7 节中描述的程序重新计算检查列表。  如果新的检查列表中的一个对也在以前的检查列表中，并且它的状态是等待、进行中、成功或失败，那么它的状态就会被复制过来，否则，它的状态就会被设置为冻结。
如果检查列表中没有一个是活动的（意味着每个检查列表中的对都是Frozen），全模式代理将第一个媒体流的检查列表中的第一个对设置为Waiting，然后将该检查列表中所有其他的对的状态设置为Waiting，这些对的ID是相同的，并且具有相同的基础。
接下来，代理将从最高优先级的对开始，检查每个检查列表。  如果一个对子的状态为成功，并且其组件ID为1，那么在同一个检查列表中，所有具有相同基础的Frozen对子，其组件ID不是1的，其状态设置为等待。  如果对于一个特定的检查列表，该媒体流的每个组件都有对处于成功状态，则代理将所有其他媒体流(从而在不同的检查列表中)的第一个组件的所有Frozen对的状态移动到等待。
9.3.2.  Procedures for Lite Implementations
如果ICE正在为一个媒体流重新启动，代理必须为该媒体流启动一个新的Valid列表。  它必须记住上一个Valid列表中媒体流的每个组件的对子，称为以前选择的对子，并继续在那里发送媒体，如第11.1节所述。  每个媒体流的ICE处理状态MUST改为Running，ICE处理状态MUST改为Running。
10.  Keepalives
所有端点必须为每个媒体会话发送keepalives。  这些keepalives的作用是使媒体会话的NAT绑定保持有效。  这些keepalives必须被发送，无论媒体流当前是否处于非活动状态、sendonly、recvonly或sendrecv，也无论带宽属性是否存在或值。  这些keepalive必须被发送，即使ICE根本没有被用于会话。  keepalive必须使用对等体支持的格式来发送。  ICE端点允许基于STUN的UDP流的keepalives，因此，当一个代理是一个完整的ICE实施，并与支持ICE（精简或完整）的对等体通信时，必须使用STUN keepalives。  代理商可以通过每个媒体会话的存在ofa=候选属性来确定其对等体是否支持ICE。  如果对等体不支持ICE，那么选择用于保持生命的数据包格式是一个本地实现的问题。  建议采用一种允许在没有实际媒体内容的情况下轻松发送数据包的格式。  如果对等体不支持任何特别适合于keepalives的格式，代理应该发送带有不正确版本号的RTP数据包，或者其他形式的错误，从而导致它们被对等体丢弃。
如果在ICE用于媒体组件的候选对上有Tr秒没有发送数据包（其中数据包包括为该组件定义的数据包（RTP或RTCP）和以前的keepalives），代理必须在该对上生成一个keepalive。  Tr必须是可配置的，并且默认为15秒。  Tr必须不能配置为小于15秒。  另外，如果一个代理有动态的方法来发现中间NAT的绑定寿命，它可以使用该值来确定Tr。 在更受控的网络环境中部署ICE的管理员应该将Tr设置为其环境中尽可能长的持续时间。
如果STUN被用于保持生命，则使用STUN绑定指示[RFC5389]。  该指示必须不使用任何认证机制。  它应该包含FINGERPRINT属性，以帮助不复用，但不能包含任何其他属性。  它仅用于保持NAT绑定的活力。  绑定指示是使用媒体使用的相同的本地和远程候选者发送的。  虽然Binding Indication用于保持生命，但代理必须准备好接收连接性检查，如果接收到连接性检查，就会产生响应，如[RFC5389]中所述，但对ICE处理没有任何影响。
一旦ICE选择了要使用媒体的候选者，或者媒体开始流动，代理必须开始进行keepalive处理，以先发生者为准。  一旦会话终止或媒体流被移除，keepalives就会结束。
11.  Media Handling
11.1.  Sending Media
完全实施和精简实施的发送介质程序不同。
11.1.1.  Procedures for Full Implementations
代理商总是使用一个候选对来发送媒体，称为选定的候选对（the selectedcandidate pair）。  代理商将向选定对中的远程候选者发送媒体(将包的目的地址和端口设置为等于该远程候选者)，并从选定对中的本地候选者发送媒体。  当本地候选者是server或peer reflexive时，媒体由基站发起。  来自中继候选者的媒体发自基站，通过该TURNserver发送，使用[RFC5766]中定义的程序。
如果本地候选者是一个中继候选者，建议代理在TURN服务器上创建一个指向远程候选者的通道。  这是用[RFC5766]第11节中定义的通道创建程序来完成的。
媒体流的一个组件的选定对是：
o 如果该媒体流的检查列表状态为Running，且该组件没有先前的选择对，则为空；如果该媒体流的检查列表状态为Running，则等于该媒体流组件的先前选择对。 如果检查列表的状态为已完成（Complete），则该媒体流的至少一个组件的选择对为空，则代理不得为该媒体流的任何组件发送媒体。  如果媒体流的每个组件的选择对有一个值，代理可以为该媒体流的所有组件发送媒体。
请注意，媒体流中某一组件的选定对可能与最近一次交换的同一组件的默认对相同。  当这种情况发生时，媒体将使用所选的对，而不是默认对。  当ICE首次完成时，如果这些选择的对子与默认对子不匹配，控制代理就会发送一个更新的offeranswer交换来弥补这种差异。  然而，在该更新的提议到达之前，不会有匹配。  此外，在非常特殊的情况下，更新后的offeranswer中的defaultcandidates将不匹配。
11.1.2.  Procedures for Lite Implementations
精简的实现必须不发送媒体，直到它有一个包含该mediastream的每个组件的候选对的Valid listthat。  一旦发生这种情况，代理可以开始发送媒体包。  要做到这一点，它向该对中的远程候选者发送媒体（将数据包的目标地址和端口设置为等于该远程候选者），并将从本地候选者发送。
11.1.3.  Procedures for All Implementations
ICE与抖动缓冲区适应机制有互动。  一个RTP流可以开始使用一个候选者，然后切换到另一个，尽管这种情况在ICE中很少发生。  新的候选者可能会导致RTP数据包在网络中采取不同的路径--具有不同的延迟特性。  如下文所述，当媒体数据包的源地址或目的地址发生变化时，我们鼓励代理重新调整抖动缓冲区。  此外，许多音频编解码器使用标记位来表示alkspurt的开始，以达到抖动缓冲区适应的目的。  对于这样的编解码器，建议发送方在代理将媒体传输从一个候选对切换到另一个候选对时设置标记位[RFC3550]。
11.2.  Receiving Media
ICE的实施必须准备好接收每个组件上的媒体，在最近的交换中为该组件提供的任何候选者（在RTP的情况下，这将包括RTP和RTCP，如果为两者提供候选者）。
建议当代理收到带有特定媒体流的新源或目的IP地址的RTP数据包时，代理应重新调整其抖动缓冲区。
RFC3550[RFC3550]在第8.2节中描述了一种用于检测同步源（SSRC）碰撞和循环的算法。  这些算法部分是基于看到不同的源传输地址具有相同的SSRC。  然而，当使用ICE时，当媒体流在candidates之间切换时，有时会出现这种变化。  代理商将能够确定一个媒体流是来自同一个对等体，这是媒体传输过程中STUN交换的结果。  因此，如果源传输地址发生变化，但媒体数据包来自同一个对等代理，这不应被视为SSRC碰撞。
12.  Usage with SIP
12.1.  Latency Guidelines
ICE需要在端点之间进行一系列基于STUN的连接性检查。  这些检查从应答者产生应答时开始，到应答者收到应答时开始。  这些检查需要一定的时间来完成，因此，选择与提议和回答一起使用的消息会影响用户的延迟。  有两个延迟数据是特别值得关注的。  接听后的延迟是指从用户 "接听电话 "到他们说出的任何话语可以传递给来电者之间的时间。  拨号后延时是指用户在成功地开始拨打被叫方的电话后，从用户输入用户的目的地址到回铃开始的时间。
有两种情况可以考虑--一种是在initial INVITE中出现了offer，一种是在response中出现了offer。
12.1.1.  Offer in INVITE
为了减少拨号后的延迟，建议呼叫方在实际发送初始邀请之前开始收集候选者，这可以在用户界面提示呼叫待定时开始，如键盘上的活动或电话脱机。
如果在INVITE请求中收到提议，应答者应在收到提议时就开始收集其候选人，并在完成该过程后在临时答复中生成答复。  ICE要求带有SDP的临时答复必须可靠地传送。  这可以通过现有的临时响应确认(PRACK)机制[RFC3262]或通过针对ICE的优化来实现。  有了这个优化，包含一个或多个媒体流的ICE处理的SDP应答的临时响应可以在没有RFC3262的情况下可靠地发送。  要做到这一点，代理用RFC 3262中描述的指数后退计时器重传临时响应。  重传必须在收到该SDP中信号的其中一个媒体流的STUN Bindingrequest时停止(因为收到Binding请求表明提供方已经收到了答案)，或者在2xx响应中传输答案时停止。  如果peer代理是精简的，永远不会有STUN Binding请求。  在这种情况下，代理必须在发送了四次之后停止重传18x（即使peer从未收到18x，ICE实际上也会工作；但是，经验表明，发送18x对于中间盒和防火墙穿越是很重要的）。  如果在最后一次重传之前没有收到Bindingrequest，代理不考虑会话终止。  尽管provisional response将被可靠地传递，但代理何时可以发送更新的offer或response的规则与RFC 3262中规定的规则没有变化。  具体来说，如果INVITE中包含了一个offer，那么相同的应答会出现在INVITE的所有1xx和2xxresponse中。  只有在该2xx发送后，才能进行更新的offeranswer交换。  如果两个代理都支持PRACK，则不应使用该优化。  需要注意的是，这个优化是针对临时响应携带的答案开始ICE处理的，它不是针对1xx可靠性的通用技术。
另外，代理可以延迟发送答案，直到200 OK；然而，这将导致糟糕的用户体验，不推荐。
一旦发送了应答，代理就应该开始进行连接性检查。  一旦am媒体流的每个组件的候选对进入有效列表，应答者就可以开始在该媒体流上发送媒体。
然而，在这之前，任何需要向呼叫方发送的媒体（如SIP早期媒体[RFC3960]）必须不被发送。  出于这个原因，实现应该延迟向被叫方发出警报，直到每个介质流的每个组件的候选者进入有效列表。  在PSTN网关的情况下，这意味着进入PSTN的设置信息将延迟到这一点。  这样做会增加拨号后的延迟，但有消除 "鬼环 "的作用。  幽灵铃是指被叫方听到电话铃声，接起电话，但什么也听不到，无法听到。  这种技术的工作不需要支持或使用前提条件[RFC3312]，因为它是一个本地化的决定。  它的另一个好处是保证没有一个媒体包会被剪断，所以后拾取延迟为零。如果一个代理选择以这种方式延迟本地警报，它应该在警报开始后生成一个180响应。
12.1.2.  Offer in Response
除了要约在INVITE中，而应答在临时或200OK响应中的用途外，ICE还适用于要约出现在响应中的情况。  在这种情况下，在第三方呼叫控制[RFC3725]中很常见，ICE代理应该在可靠的临时响应中生成他们的提议（必须使用RFC 3262），而不是在收到INVITE时提醒用户。  这允许ICE处理在报警之前进行，这样就不会有接听后的延迟，但代价是增加呼叫设置的延迟。  一旦ICE处理完成，被叫方就可以向用户发出警报，然后在用户应答时生成一个200 OK。  200 OK将不包含SDP，因为要约-应答交换已经完成。
另外，代理商也可以将报价放在2xx中（在这种情况下，答案在ACK中出现）。  当这种情况发生时，电话将在收到INVITE时提醒用户，而ICE交换将在用户回答后才进行。  这样做的效果是减少呼叫设置延迟，但可能会造成大量的后接电话延迟和媒体剪接。
12.2.  SIP Option Tags and Media Feature Tags
RFC5768]指定了一个SIP选项标签和媒体特征标签，以便与ICE一起使用。  使用SIP的ICE实现应该支持这个规范，它在注册中使用特征标签，通过信令中介促进互操作性。
12.3.  Interactions with Forking
ICE与分叉的互动非常好。  事实上，ICE解决了一些与分叉相关的问题。  如果没有ICE，当一个呼叫分叉而呼叫者收到多个传入的媒体流时，它无法确定哪个媒体流对应于哪个被叫方。
有了ICE，这个问题就解决了。  在传输媒体之前发生的连通性检查会携带用户名碎片，而用户名碎片又与特定的clee相关联。  随后到达与连通性检查相同的候选对的介质包将与同一被叫方相关联。  因此，被叫方只要收到应答，就可以进行这种关联。
12.4.  Interactions with Preconditions
RFC3312[RFC3312]和RFC4032[RFC4032]中定义的服务质量(QoS)前提条件，只适用于在offeranswer中被列为媒体默认目标的传输地址。
如果ICE改变了接收媒体的传输地址，这种变化会反映在更新的报价中，该报价改变了媒体的defaultdestination，以符合ICE的选择。  因此，它看起来就像任何其他重新INVITE一样，并且在RFCs 3312和4032中得到了充分的处理，它适用于不考虑由于 "在后台 "发生的ICE协商而导致目的地formedia改变的事实。
事实上，在检查完成并选择了用于媒体的候选pairsto之前，代理不应表明QoS先决条件已经得到满足。
ICE还与连接性前提条件[SDP-PRECON]进行了（有目的的）交互。  请注意，第12.1节描述的程序描述了它们的 "前提条件 "类型，尽管与[SDP-PRECON]中的显式前提条件相比功能较少。
12.5.  Interactions with Third Party Call Control
ICE与流I、III和IV一起工作，如[RFC3725]中所述。  流程I可以在控制器不支持或不知道ICE的情况下工作，流程IV可以在控制器不改变ICE属性的情况下工作。  流程II与ICE基本不兼容；每个代理都会认为自己是应答者，因此不会产生重新INVITE。
如RFC3725第7节所述，继续操作的流程需要ICE实现的额外行为来支持.特别是，如果代理收到一个不包含任何提议的中间对话重新INVITE，它必须为每个媒体流重新启动ICE，并通过收集新候选者的过程。  此外，该候选者列表SHOULD包括当前正在使用的formedia。
13.  Relationship with ANAT
RFC4091[RFC4091]，即SDP分组框架的替代网络地址类型(ANAT)语义，以及RFC4092[RFC4092]，即其在SIP中的使用，定义了一种机制，用于指示代理可以同时支持媒体流的IPv4和IPv6，并通过包含两个m行，一个用于v4，一个用于v6。 这与ICE类似，ICE允许代理使用候选属性指示多个传输地址。  然而，ANAT依靠静态选择来选择，而不是ICE使用的动态连接性检查。
本规范废除了RFC 4091和RFC 4092。  相反，希望支持双栈的代理将利用ICE。
14.  Extensibility Considerations
该规范对会话中的两个代理如何进行协调，以达到为媒体选择的候选对的集合做出了非常具体的选择。  预计未来的规范将希望改变这些算法，无论是简单的变化，如定时器的调整，还是更大的变化，如优先级算法的改造。  当做出这样的改变时，在一个会话中提供两个代理之间的互操作性是至关重要的。
首先，ICE提供a=ice-options SDP属性。  每一个对ICE的扩展或变更都与一个令牌相关联。  当支持这种扩展或变更的代理产生一个提议或回答时，它必须在这个属性中包括该扩展的令牌。  这使得每一方都能知道另一方在做什么。  如果代理不支持任何ICE扩展或变更，该属性必须不存在。
目前，还没有定义这些选项标签的IANA注册表或注册程序。  在撰写本报告时，尚不清楚ICE变更和扩展是否足够普遍而需要注册。
实现互操作性的一个复杂问题是，ICE依靠在两个代理上运行的分布式算法来收敛商定的一组候选对。  如果两个代理运行不同的算法，就很难保证收敛在同一个候选对上。  第8节中描述的常规提名程序通过将这些选择算法完全委托给控制代理来消除一些紧密的协调，因此，当控制代理与支持它不知道的选项的peerthat进行通信时，代理必须运行常规提名算法。  当使用regular nomination时，即使两个代理使用不同的pairprioritization算法，ICE也会完美收敛。  这种收敛的关键之一是触发检查，它确保提名的对子被两个代理验证。  因此，未来任何ICE的改进都必须保留触发检查。
ICE还可以扩展到RTP以外的其他媒体流，以及UDP以外的传输协议。  对于非RTP媒体流的ICE扩展需要指定它们使用了多少个组件，并为它们分配组件ID，最重要的组件ID从1开始。  新传输协议的规范必须定义ICE处理中的各个步骤与UDP的不同，如果有的话。
15.  Grammar
本规范定义了七个新的SDP属性--"候选者"、"远程候选者"、"ice-lite"、"ice-match"、"ice-ufrag"、"ice-pwd "和 "ice-options "属性。
15.1.  "candidate" Attribute
候选者属性是一个媒体级属性，它包含一个候选者的传输地址，可用于连接性检查。  它包含一个候选者的传输地址，可用于连接性检查。
这个属性的语法使用RFC 5234[RFC5234]中定义的增强BNF来定义。
candidate-attribute = "candid" ":"foundation SP component-id SPtransport SPpriority SPconnection-address SP ;from RFC 4566port ;port from RFC 4566SP cand-type[SP rel-addr][SP rel-port]*(SP extension-att-name SPextension-att-value)foundation = 1*32ice-charcomponent-id = 1*5DIGITtransport = "UDP" transport-extensiontransport-extension = token 。 从 RFC 3261priority = 1*10DIGITcand-type = "ty" SP candidate-typandidate-types = "host" "srflx" "prflx" "rel relay" tokenrel-addr = "raddr" SP connection-addressrel-port = "rport" SP portextension-att-name = byte-string 。来自 RFC 4566extension-att-value = byte-stringice-char = ALPHA DIGIT "+" ""这个语法编码了候选者的主要信息。 它的IP地址、端口和传输协议，以及它的属性：基础、组件ID、优先级、类型和相关传输地址。
<连接地址>：取自RFC 4566[RFC4566]，是候选者的IP地址，允许使用IPv4地址、IPv6addresses和完全合格的域名（FQDN）。  它是候选者的 IP 地址，允许使用 IPv4 地址、IPv6 地址和完全限定域名（FQDN）。  当解析这个字段时，代理可以通过在其值中出现冒号来区分IPv4地址和IPv6地址--出现冒号表示IPv6。  代理商必须忽略包含不支持或不识别的 IP 地址版本的候选行。  应该使用 IP 地址，但可以使用 FQDN 来代替 IP 地址。  在这种情况下，当收到a=candidate属性中包含FQDN的offer或应答时，首先使用AAAA记录（假设代理支持IPv6）在DNS中查找FQDN，如果没有找到结果或代理只支持IPv4，则使用A.如果DNS查询返回一个以上的IP地址，则选择一个，然后用于ICE处理的其余部分。
<port>: 也是取自 RFC 4566 [RFC4566]。  它是候选者的端口。
<transport>：表示候选者的传输协议，本规范只定义了UDP。  但是，本规范提供了扩展性，以允许未来的传输协议与ICE一起使用，如TCP或数据报拥塞控制协议(DCCP)[RFC4340]。
<基础>：由1至32个<冰字符>组成。  它是一个标识符，相当于两个相同类型、共享相同基数、来自同一STUNserver的候选者。  在Frozen算法中，该基础用于优化ICE性能。
<component-id>：是一个介于1到256之间的正整数，用于标识媒体流中的特定组件，这是一个候选组件。  它必须从1开始，并且必须为特定候选者的每个组件递增1。  对于基于 RTP 的媒体流，实际 RTP 媒体的候选者必须具有 1 的组件 ID，而 RTCP 的候选者必须具有 2 的组件 ID。 其他类型的媒体流需要多个组件，必须制定规范，定义组件与组件 ID 的映射。  参见第14节关于将ICE扩展到新媒体流的额外讨论。
<优先级>：是介于1和（2**31-1）之间的正整数。
<cand-type>：对候选者的类型进行编码。  本规范定义了 "host"、"srflx"、"prflx "和 "relay "的值，分别代表主机、服务器反射型、对等反射型和中继型候选者。  候选类型的集合是可扩展的，以备将来使用。
<rel-addr>和<rel-port>：传递与候选者相关的传输地址，对诊断和其他目的有用。 <rel-addr>和<rel-port>对于服务器反射、对等反射和中继候选者必须存在。  如果候选者是服务器或对等反射，<rel-addr>和<rel-port>等于该服务器或对等反射候选者的基数。  如果候选者是中继的，<rel-addr>和<rel-port>等于向客户端提供该中继候选者的Allocate响应中的映射地址（关于它的用途，请参见附录B.3）。  如果候选者是主机候选者，<rel-addr>和<rel-port>必须省略。
候选属性本身可以扩展。  语法允许在属性的末尾添加新的name-value对。  Animplementation必须忽略任何它不理解的namevalue对。
15.2.  "remote-candidates" Attribute
"remote-candidates "属性的语法使用RFC 5234[RFC5234]中定义的Augmented BNF来定义。  remote-candidates属性只是一个媒体级属性。
remote-candidate-att = "remote-candidates" ":" remote-candidate0*(SP remote-candidate)remote-candidate = component-ID SP connection-address SP port该属性包含每个组件的连接地址和端口。  组件的顺序无关紧要。  但是，媒体流的每个组件必须有一个值。  此属性必须包含在控制代理为已完成的媒体流提供的报价中，在任何其他情况下都不得包含。
15.3.  "ice-lite" and "ice-mismatch" Attributes
"ice-lite "和 "ice-mmisatch "属性的语法是，这两个属性都是标志。
ice-lite="ice-lite "ice-mismatch="ice-mismatch""ice-lite "仅是会话级属性，表示agent是lite实现。 "ice-mismatch "仅是媒体级属性，当出现在答案中时，表示offer到达时，媒体组件的默认目的地没有对应的候选属性。
15.4.  "ice-ufrag" and "ice-pwd" Attributes
"ice-ufrag "和 "ice-pwd "属性传达了ICE用于消息完整性的用户名片段和密码。  它们的语法是：
ice-pwd-att = "ice-pwd" ":" passwordice-ufrag-att = "ice-ufrag" ":" ufragpassword = 22*256ice-charufrag = 4*256ice-char "ice-pwd "和 "ice-ufrag "属性可以出现在会话级别或媒体级别。  当这两个属性同时出现时，媒体级的值优先。  因此，会话级别的值实际上是适用于所有媒体流的默认值，除非被媒体级别的值覆盖。  无论在会话或媒体级别，每个媒体流都必须有ice-pwd和ice-ufrag属性。  如果两个媒体流有相同的ice-ufrag，它们必须有相同的ice-pwd。
ice-ufrag和ice-pwd属性必须在一个会话开始时随机选择。  ice-ufrag属性必须包含至少24位的随机性，ice-pwd属性必须包含至少128位的随机性。  这意味着ice-ufrag属性将至少4个字符长，ice-pwd至少22个字符长，因为这些属性的语法允许每个字符有6位随机性。  当然，这些属性的长度可以分别超过4个和22个字符，最多不超过256个字符。  上限允许缓冲区大小的实施。  它的大上限允许随着时间的推移增加随机性的数量。
15.5.  "ice-options" Attribute
ice-options "属性是一个会话级属性。  它包含一系列标识代理所支持的选项的标记。  它的语法是：
16.  Setting Ta and RTO
ice-options = "ice-options" ":" ice-option-tag0*(SP ice-option-tag)ice-option-tag = 1*icechar在ICE的收集阶段(4.1.1节)和ICE执行连接性检查时(7节)，代理发送STUN和TURN事务。  这些事务以每Ta毫秒一个的速度进行，并利用特定的RTO。  本节描述了Ta和RTO的值是如何计算的。  这种计算取决于ICE是否与实时媒体流（如RTP）或其他东西一起使用。  当ICE用于已知最大带宽的流时，可以按照第16.1节的计算来控制ICE交换的速率。  对于所有其他流，必须遵循第16.2节的计算。
16.1.  RTP Media Streams
RTO和Ta的值在ICE处理过程中会发生变化。  一组值适用于收集阶段，另一组适用于连接性检查。
Ta的值应该是可配置的，默认值为。
对于每个媒体流i。
    Ta_i = (stun_packet_size / rtp_packet_size) * rtp_ptime
                           1
     Ta = MAX (20ms, ------------------- )
                           k
                         ----
                         \        1
                          >    ------
                         /       Ta_i
                         ----
                          i=1
其中k为媒体流的数量。  在收集阶段，Ta的计算基于代理在其offer或应答中已经indicated的媒体流的数量，RTP包大小和RTPptime是每个媒体流的最优选的编解码器.一旦交换了offer和应答，代理重新计算Tato步伐的连接性检查。  在这种情况下，Ta的值是基于会话中实际使用的媒体流的数量，RTP包大小和RTP ptime是代理将发送的最喜欢的编解码器的值。
此外，[RFC5389]中定义的STUN事务的重传定时器RTO应该是可配置的，在收集阶段，应该有一个默认值。
RTO=MAX(100ms，Ta*(对数))，其中对数指的是有STUN或TURN服务器的候选对数。
对于连通性检查，RTO是可以配置的，并且应该有adefault of：
RTO = MAX (100ms, Ta*N * (Num-Waiting + Num-In-Progress))，其中Num-Waiting是等待状态下检查列表中的检查数量，Num-In-Progress是正在进行状态下的检查数量。  需要注意的是，随着Waiting和In-Progressstates中检查数的变化，每笔交易的RTO会有所不同。
这些公式旨在使STUN交易的速度与媒体的速度相同。  这确保了ICE能在支持媒体所需的相同网络条件下正常工作。  由于这种节奏，需要一定的时间来获取所有的服务器反射和中继候选者，实现者应该意识到这样做所需的时间，如果应用程序需要时间预算，请限制收集的候选者数量。
这些公式导致了一种行为，即在执行重传之前，代理将为每一次连接性检查发送第一个数据包。  这可以从RTO（代表重传间隔）的公式中看出。  这些公式与N，即要执行的检查数量成比例。  因此，ICE保持了一个很好的恒定速率，但对丢包变得更加敏感。  任何连接性检查的第一个单包丢失很可能导致该对检查需要很长时间才能被验证，相反，优先级较低的检查(但一个检查没有丢包)更可能首先完成。  这导致ICE的性能次优，选择低优先级的对而不是高优先级的对。  实现者应该意识到这个后果，但仍然应该利用这里描述的定时器值。
16.2.  Non-RTP Sessions
在使用ICE建立某种非实时会话的情况下，并且没有与之相关的固定速率，已知在部署ICE的网络上可以工作，Ta和RTO恢复到更保守的值。  Ta应该是可配置的，应该有500ms的默认值，而且一定不能配置成小于500ms。
此外，STUN交易的重传定时器RTO应该是可配置的，在收集阶段，SHOULD的默认值为：
RTO=MAX(500ms，Ta*(对数))，其中对数指的是有STUN或TURN服务器的候选对数。
对于连通性检查，RTO是可以配置的，并且应该有adefault of：
17.  Example
RTO = MAX (500ms, Ta*N * (Num-Waiting + Num-In-Progress))这个例子是基于图8的简化拓扑结构。
                             +-----+
                             |     |
                             |STUN |
                             | Srvr|
                             +-----+
                                |
                     +---------------------+
                     |                     |
                     |      Internet       |
                     |                     |
                     |                     |
                     +---------------------+
                       |                |
                       |                |
                +---------+             |
                |  NAT    |             |
                +---------+             |
                     |                  |
                     |                  |
                     |                  |
                  +-----+            +-----+
                  |     |            |     |
                  |  L  |            |  R  |
                  |     |            |     |
                  +-----+            +-----+
图8：示例TopologyTwo代理，L和R，正在使用ICE。  两者都是全模式的 ICEimplementation，并在控制时使用侵略性提名。  两个代理都有一个IPv4地址。  对于代理L来说，是私有地址空间的10.0.1.1[RFC1918]，对于代理R来说，是公共互联网上的192.0.2.1。  两者都配置了相同的STUN服务器(为了简单起见，本例中显示的是STUN服务器，但在实际操作中，代理不需要使用相同的STUN服务器)，STUN服务器以192.0.2.2的IP地址和3478端口监听STUN Binding请求。  本例中没有使用TURN服务器。  代理Lis在NAT后面，代理R在公共互联网上。  NAT有一个端点独立映射属性和一个地址依赖过滤属性。  NAT的公网侧的IP地址为192.0.2.3。
为了便于理解，传输地址使用具有记忆性名称的变量列出。  名称的格式是entity-type-seqno，其中entity指的是传输地址所在的IP地址实体，是 "L"、"R"、"STUN "或 "NAT "中的一种。  最后，seq-no 是一个序列号，对于特定实体上相同类型的每个传输地址来说，这个序列号是不同的。  每个variable都有一个IP地址和端口，分别用varname.IP和varname.PORT表示，其中varname是variable的名称。
STUN服务器公布了传输地址STUN-PUB-1（即192.0.2.2:3478）。
在呼叫流本身，STUN消息有几个属性注释。  "S="属性表示消息的源传输地址。  "D="属性表示消息的目的传输地址。  "MA="属性在STUN绑定响应消息中使用，指的是映射地址。"USE-CAND "意味着存在USE-CANDIDATE属性。
呼叫流示例省略了STUN认证操作和RTCP,而专注于两个完整实现之间的单一媒体流的RTP。
             L             NAT           STUN             R
             |RTP STUN alloc.              |              |
             |(1) STUN Req  |              |              |
             |S=$L-PRIV-1   |              |              |
             |D=$STUN-PUB-1 |              |              |
             |------------->|              |              |
             |              |(2) STUN Req  |              |
             |              |S=$NAT-PUB-1  |              |
             |              |D=$STUN-PUB-1 |              |
             |              |------------->|              |
             |              |(3) STUN Res  |              |
             |              |S=$STUN-PUB-1 |              |
             |              |D=$NAT-PUB-1  |              |
             |              |MA=$NAT-PUB-1 |              |
             |              |<-------------|              |
             |(4) STUN Res  |              |              |
             |S=$STUN-PUB-1 |              |              |
             |D=$L-PRIV-1   |              |              |
             |MA=$NAT-PUB-1 |              |              |
             |<-------------|              |              |
             |(5) Offer     |              |              |
             |------------------------------------------->|
             |              |              |              |RTP STUN
             alloc.
             |              |              |(6) STUN Req  |
             |              |              |S=$R-PUB-1    |
             |              |              |D=$STUN-PUB-1 |
             |              |              |<-------------|
             |              |              |(7) STUN Res  |
             |              |              |S=$STUN-PUB-1 |
             |              |              |D=$R-PUB-1    |
             |              |              |MA=$R-PUB-1   |
             |              |              |------------->|
             |(8) answer    |              |              |
             |<-------------------------------------------|
             |              |(9) Bind Req  |              |Begin
             |              |S=$R-PUB-1    |              |Connectivity
             |              |D=L-PRIV-1    |              |Checks
             |              |<----------------------------|
             |              |Dropped       |              |
             |(10) Bind Req |              |              |
             |S=$L-PRIV-1   |              |              |
             |D=$R-PUB-1    |              |              |
             |USE-CAND      |              |              |
             |------------->|              |              |
             |              |(11) Bind Req |              |
             |              |S=$NAT-PUB-1  |              |
             |              |D=$R-PUB-1    |              |
             |              |USE-CAND      |              |
             |              |---------------------------->|
             |              |(12) Bind Res |              |
             |              |S=$R-PUB-1    |              |
             |              |D=$NAT-PUB-1  |              |
             |              |MA=$NAT-PUB-1 |              |
             |              |<----------------------------|
             |(13) Bind Res |              |              |
             |S=$R-PUB-1    |              |              |
             |D=$L-PRIV-1   |              |              |
             |MA=$NAT-PUB-1 |              |              |
             |<-------------|              |              |
             |RTP flows     |              |              |
             |              |(14) Bind Req |              |
             |              |S=$R-PUB-1    |              |
             |              |D=$NAT-PUB-1  |              |
             |              |<----------------------------|
             |(15) Bind Req |              |              |
             |S=$R-PUB-1    |              |              |
             |D=$L-PRIV-1   |              |              |
             |<-------------|              |              |
             |(16) Bind Res |              |              |
             |S=$L-PRIV-1   |              |              |
             |D=$R-PUB-1    |              |              |
             |MA=$R-PUB-1   |              |              |
             |------------->|              |              |
             |              |(17) Bind Res |              |
             |              |S=$NAT-PUB-1  |              |
             |              |D=$R-PUB-1    |              |
             |              |MA=$R-PUB-1   |              |
             |              |---------------------------->|
             |              |              |              |RTP flows
图9：示例流程首先，代理L从它的本地IP地址(未显示)获得一个主机候选者，并由此向STUNserver发送一个STUN Binding请求，以获得一个服务器反射候选者(消息1-4)。  回想一下，NAT具有地址和端口无关的映射属性.这里，它为这个UDP请求创建了一个NAT-PUB-1的绑定，这就成了RTP的服务器反射候选者。
代理人L为主机候选者设置的类型偏好为126，为服务器反射者设置的类型偏好为100。  本地优先级为65535。  Based onthis，the priority of the host candidate is 2130706431 and for theserver reflexive candidate is 1694498815.  The host candidate isassigned a foundation of 1, and the server reflexive, a foundation of2.  它选择其服务器反义候选者作为defaultcandidate，并将其编码到m和c行中。  resultingoffer(消息5)的样子(为了清晰起见，行数折叠)。
v=0o=jdoe 2890844526 2890842807 IN IP4 $L-PRIV-1.IPs=c=IN IP4 $NAT-PUB-1.IPt=0 0a=ice-pwd:asd88fgpdd777uzjYhagZga=ice-ufrag:8hhYm=audio $NAT-PUB-1.PORT RTPAVP 0b=RS:0b=RR:0a=rtpmap:0 PCMU8000a=candidate:1 1 UDP 2130706431 $L-PRIV-1.IP $L-PRIV-1.PORT typhosta=candidate:2 1 UDP 1694498815 $NAT-PUB-1.IP $NAT-PUB-1.PORT typsrflx raddr $L-PRIV-1.IP rport $L-PRIV-1.PORTThe offer, with the variables replaced with their values, will looklike ( lines folded for clarity):
v=0o=jdoe 2890844526 2890842807 IN IP4 10.0.1.1s=c=IN IP4 192.0.2.3t=0 0a=ice-pwd:asd88fgpdd777uzjYhagZga=ice-ufrag:8hhYm=audio 45664 RTPAVP 0b=RS:0b=RR:0a=rtpmap:0 PCMU8000a=candidate:1 1 UDP 2130706431 10.0.1.1 8998 typ hosta=candidate:2 1 UDP 1694498815 192.0.2.3 45664 typ srflx raddr10.0.1.1 rport 8998该提议在代理R处收到，代理R将获得一个hostcandidate，并从中获得一个服务器反射候选者（消息6-7）。  由于R不在NAT后面，这个候选者与它的主机候选者是相同的，它们共享相同的基础。  因此，它抛弃了这个冗余的候选者，最后得到一个单一的hostcandidate。  在类型和本地偏好与L相同的情况下，这个候选者的优先级为2130706431。  它为其单一候选者选择了一个foundationof1。  其得出的答案是这样的。
v=0o=bob 2808844564 2808844564 IN IP4 $R-PUB-1.IPs=c=IN IP4 $R-PUB-1.IPt=0 0a=ice-pwd:YH75Fviy6338Vbrhrlp8Yha=ice-ufrag:9uB6m=audio $R-PUB-1.PORT RTPAVP 0b=RS:0b=RR:0a=rtpmap:0 PCMU8000a=candidate:1 1 UDP 2130706431 $R-PUB-1.IP $R-PUB-1.PORT typ hostWith the variables filled in:
v=0o=bob 2808844564 2808844564 IN IP4 192.0.2.1s=c=IN IP4 192.0.2.1t=0 0a=icepwd:YH75Fviy6338Vbrhrlp8Yha=iceufrag:9uB6m=audio 3478 RTPAVP 0b=RS:0b=RR:0a=rtpmap:0 PCMU8000a=candidate:1 1 UDP 2130706431 192.0.2.1 3478 typ hostSince neither side indicated that it is lite, the agent that sent theoffer that began ICE processing (agent L) becomes the controllingagent.
   Agents L and R both pair up the candidates.  They both initially have
   two pairs.  However, agent L will prune the pair containing its
   server reflexive candidate, resulting in just one.  At agent L, this
   pair has a local candidate of $L_PRIV_1 and remote candidate of
   $R_PUB_1, and has a candidate pair priority of 4.57566E+18 (note that
   an implementation would represent this as a 64-bit integer so as not
   to lose precision).  At agent R, there are two pairs.  The highest
   priority has a local candidate of $R_PUB_1 and remote candidate of
   $L_PRIV_1 and has a priority of 4.57566E+18, and the second has a
   local candidate of $R_PUB_1 and remote candidate of $NAT_PUB_1 and
   priority 3.63891E+18.
代理人 R 开始对第一对（两个候选主机之间）进行连接性检查（消息 9）。  因为 R 是这个会话的受控代理，所以检查省略了 USE-CANDIDATE 属性。  来自代理 L 的主机候选者是私有的，并且在 NAT 后面，所以检查不会成功，因为数据包不能从 R 路由到 L。
当代理 L 得到答案时，它会执行它唯一的连接性检查（消息 10-13）。  它实现了 aggressivenomination 算法， 因此在这个检查中包含了 USE-CANDIDATE 属性。  由于检查成功，代理 L 创建了一个新的对，其本地候选者来自 Bindingresponse 中的映射地址 (来自消息 13 的 NAT-PUB-1)，其远程候选者是请求的目的地 (来自消息 10 的 R-PUB-1)。  这将被添加到有效列表中。  此外， 如果 Binding 请求中包含了 USE-CANDIDATE 属性， 则会被标记为选定。  如果这个媒体流的一个组件在有效列表中被选中，则这个媒体流的 ICE 处理将进入完成状态。  代理人 L 如果愿意，现在可以发送媒体。
在收到代理L的STUN Binding请求(消息11)后不久，代理R将产生其触发的检查。  这个检查恰好与它的检查列表中的下一个检查列表相匹配--从它的主机候选者到代理L的服务器反射候选者。  这个检查(消息14-17)将成功。  因此，代理R用响应的映射地址作为本地候选者(R-PUB-1)和请求的目的地(NAT-PUB-1)作为远程候选者，构建一个新的候选者对。  该对被添加到该媒体流的有效列表中。  由于该检查是以包含 USE-CANDIDATE 属性的检查的相反方向生成的，因此候选者对被标记为选定。  因此，该媒体流的处理进入 Completed 状态，代理 R 也可以发送媒体。
18.  Security Considerations
ICE系统中可能存在几种类型的攻击。  本节将讨论这些攻击及其对策。  这些对策包括：
o 结合安全信令技术（如SIPS）使用ICE。
o 限制连通性检查的总数为100次，并选择性地限制他们在offer或答案中接受的候选人数量。
18.1.  Attacks on Connectivity Checks
攻击者可能会试图破坏STUN的连接性检查.最终，所有这些攻击都会愚弄代理，使其认为连接性检查的结果是不正确的.攻击者可能会尝试并导致的错误结论是。
假的无效。  攻击者可以愚弄一对代理，使其认为一对候选者无效，其实不然。  这可以用来让代理选择不同的候选者（如攻击者注入的候选者），或者通过强迫所有候选者失败来中断呼叫。
虚假有效。  攻击者可以愚弄一对代理，使其认为一个候选对是有效的，但实际上是无效的，这可能导致代理继续进行会话，但却无法接收任何媒体。  这可能导致代理继续进行会话，但却无法接收任何媒体。
False Peer Reflexidive Candidate: 攻击者可以使代理发现一个新的peer Reflexidive candidate，当它不应该发现的时候。
假候选者上的假有效：攻击者已经让一个代理相信，有一个候选者的地址实际上并没有路由到该代理（例如，通过注入一个假的peer reflexive候选者或假的服务器reflexive候选者），然后我必须发起攻击，迫使代理相信这个候选者是有效的。  然后我必须发起攻击，迫使代理相信这个候选者是有效的。
如果攻击者可以造成虚假的对等反身候选者或虚假候选者上的falsevalid，就可以发起[RFC5389]中描述的任何攻击。
为了迫使假的无效结果，攻击者必须等待其中一个代理的连接性检查被发送。  当它被发送时，攻击者需要注入一个带有不可恢复的error响应的假响应，如400。  然而，由于候选者事实上是有效的，所以原始请求可能会到达对等代理，并得到一个成功的响应。  攻击者需要通过DoS攻击、第2层网络中断或其他技术，迫使这个包或其响应被丢弃。  如果它不这样做，成功响应也会到达发起者，提醒它注意可能的攻击。  幸运的是，这种攻击可以通过STUN短期凭证机制完全缓解。  攻击者需要注入一个假的响应，为了让这个响应被处理，攻击者需要密码。  如果offeranswersignaling是安全的，攻击者将没有密码，其response将被丢弃。
强制伪造有效结果的工作方式类似。  代理需要等待每个代理的Binding请求，并注入假的成功响应。  攻击者不需要担心破坏实际的响应，因为如果候选者不是有效的，那么无论如何都不会收到它。  然而，与伪造无效攻击一样，这种攻击也会被STUN短期凭证机制与安全的offeranswerexchange所缓解。
强制假对等反身候选结果可以用假请求或响应，也可以用重播。  我们首先考虑假请求和响应的情况。  它要求攻击者向一个具有源IP地址和端口的代理发送Binding请求，以获取假候选者。  此外，攻击者必须等待另一个代理的Binding请求，并生成一个包含假候选者的XOR-MAPPED-ADDRESS属性的假响应。像本文描述的其他攻击一样，这种攻击被STUN消息完整性机制和安全的offeranswerexchanges所缓解。
强制假对等反思候选结果与数据包重播不同。  攻击者会等到其中一个代理发送check，它拦截这个请求，并用伪造的源IP地址向另一个代理重播。  它拦截这个请求，并用伪造的源IP地址向另一个代理重播。  它还必须阻止原始请求到达远程代理，或者通过发起DoS攻击导致数据包被丢弃，或者使用第2层机制迫使它被bedropped。  重放的数据包被另一个代理接收，并被接受，因为完整性检查通过了（完整性检查不能也不覆盖源IP地址和端口）。  然后对其进行响应。  这个响应将包含一个与假候选者的XOR-MAPPED-ADDRESS，并将被发送到该假候选者。  然后，攻击者必须接收它，并将它转发到发起者那里。
然后，另一个代理将向该假候选人发起连接性检查。  这个验证需要成功。  这就要求攻击者在假候选者上强制进行假验证。  Ininjectgof fake requests or response to achieve this goal is prevented using the integrity mechanisms of STUN and the offeranswer exchange.This, this attack can only be launched through replays.  要做到这一点，攻击者必须拦截对这个假候选者的检查，并对另一个代理进行重播。  然后，它必须拦截到对方的回复，并将其重放回来。
这种攻击很难发动，除非攻击者被假候选人识别出来。  这是因为它要求攻击者拦截和重放两个不同主机发送的数据包。  如果两台主机都在不同的网络上（例如，在公共互联网上），这种攻击就很难协调，因为它需要同时针对网络不同部分的两个不同端点进行攻击。
如果攻击者本身被假候选人识别，那么攻击就比较容易协调。  然而，如果使用SRTP[RFC3711]，攻击者将无法播放媒体包，而只能丢弃它们，从而有效地禁用呼叫的媒体流。  然而，这种攻击要求代理中断数据包，以阻止连接检查到达目标。  在这种情况下，如果目标是破坏媒体流，那么用同样的机制来破坏媒体流要容易得多，而不是攻击ICE。
18.2.  Attacks on Server Reflexive Address Gathering
ICE端点使用STUN Binding请求从STUN服务器收集服务器反射候选者。  这些请求没有经过任何方式的认证。  因此，攻击者可以利用许多技巧为客户端提供虚假的服务器反射候选者。
o 攻击者可以破坏DNS，导致DNS查询返回流氓STUN服务器地址。  该服务器可以向客户端提供虚假的服务器反射候选地址。  这种攻击可以通过DNS安全来缓解，尽管不需要DNS-SEC来解决。
o 能够观察到STUN消息的攻击者（如WiFi等共享网段上的攻击者）可以注入一个有效的假响应，并被客户端接受。
o 攻击者可以通过病毒入侵STUN服务器，使其以错误的映射地址发送响应。
通过这些攻击学习到的虚假映射地址将被用作ICE交换中的服务器反射候选地址。  要想让这个候选者真正用于媒体，攻击者还必须攻击连接性检查，特别是在afalse候选者上强制进行虚假有效。  如果falseaddress标识的是第四方（既不是发包方、应答方，也不是攻击方），这种攻击就很难发动，因为它需要攻击会话中每个agent产生的检查，如果它标识的是攻击方自己，就会被SRTP阻止。
如果攻击者选择不攻击连接性检查，最坏的情况是阻止服务器反身候选者被使用。  但是，如果对等代理至少有一个被攻击的代理可以到达的候选者，STUN连接性检查本身就会提供一个可以用于媒体交换的对等反身候选者。  对等反射候选者一般比服务器反射候选者更受欢迎。  因此，仅仅针对STUN地址收集的攻击通常不会对会话产生任何影响。
18.3.  Attacks on Relayed Candidate Gathering
攻击者可能会试图扰乱中继candidates的收集，迫使客户机相信它有一个虚假的中继candidate。  与TURN服务器的交换是使用沿期凭证进行认证的。  因此，注入虚假的响应或请求将无法工作。  此外，与Binding请求不同，Allocate请求不容易受到修改源IP地址和端口的重放攻击，因为源IP地址和端口并没有被用来向客户端提供中继候选者。
然而，TURN服务器很容易受到DNS攻击，或者受到针对TURN服务器的病毒攻击，目的是把它变成一个僵尸代理服务器。  这些攻击可以通过DNS-SEC和通过TURN服务器上良好的盒子和软件安全来减轻。
即使攻击者使客户机相信了一个假的候选者，连接性检查也只会在成功的情况下才会导致这样的候选者被使用。  因此，攻击者必须按照上面的说法，对一个虚假的候选者发起一个falsevalid，这是一个非常难以协调的攻击。
18.4.  Attacks on the Offer/Answer Exchanges
攻击者如果能够修改或破坏他们自己的交换条件，就可以很容易地用ICE发起各种攻击。  他们可以将媒体导向DoS攻击的目标，他们可以将自己插入媒体流中，等等。  这些类似于提供应答交换的一般安全考虑，RFC3264[RFC3264]中的安全考虑也适用。  这些都需要消息完整性的技术和提供和应答的加密技术，当使用SIP时，SIPS机制[RFC3261]可以满足这些要求。  因此，推荐使用SIPS和ICE。
18.5.  Insider Attacks
除了攻击者是第三方试图插入假的报价、答案或眩晕信息的攻击外，当攻击者是ICE交易所中经过认证和有效的参与者时，ICE还有几种可能的攻击。
18.5.1.  The Voice Hammer Attack
语音锤攻击是一种放大攻击。  在这种攻击中，攻击者发起与其他代理的会话，并恶意地将DoS目标的IP地址和端口作为SDP信号中媒体流量的目的地。  这就造成了大量的放大，一个单一的问答交换就可以产生持续的媒体数据包洪流，可能是高速率的（考虑视频资源）。  这种攻击不是ICE特有的，但ICE可以帮助提供补救措施。
具体来说，如果使用ICE，接收恶意SDP的代理将首先对媒体目标进行连接检查，然后再将媒体发送到那里。  如果这个目标是第三方主机，则检查不会成功，媒体永远不会被发送。
遗憾的是，如果不使用ICE，那么ICE就无济于事，在这种情况下，攻击者可以简单地发送没有ICE参数的offer.然而，在已知客户集的环境中，并且仅限于那些支持ICE的客户，服务器可以拒绝任何不表明支持ICE的offer或回答。
18.5.2.  STUN Amplification Attack
STUN放大攻击类似于语音锤.然而，STUN连接性检查不是将语音包指向目标，而是指向目标。  攻击者发送一个包含大量候选者的offer，比如50个。  应答者收到提议后，开始检查，而检查是针对目标的，因此，永远不会产生响应。  应答者将每隔Ta毫秒(比如，Ta=20ms)开始一次新的连接性检查.然而，由于候选者数量众多，重传定时器被设置为大数。  因此，数据包将以每Ta毫秒一个的时间间隔发送，之后以递增的时间间隔发送。  因此，STUN发送数据包的速度不会比媒体发送的速度快，而且STUN数据包的持续时间很短，直到ICE失败为止。  尽管如此，这是一种放大机制。
虽然不可能消除放大，但可以通过各种启发式方法来减少数量。  代理商应该将他们执行的连接性检查的总次数限制在100次.此外，代理商还可以限制他们在报价或答案中接受的候选人数量。
通常情况下，希望避免这类攻击的协议会迫使发起者在发送下一条消息之前等待响应。  然而，在ICE的情况下，这是不可能的。  以下两种情况是不可能区分的。
o没有响应，因为发起者被用来对一个毫无防备的目标发起DoS攻击，而这个目标不会响应。
o 由于发起者无法到达IP地址和端口，所以没有响应。
在第二种情况下，应在下一个机会再发一次支票，而在前一种情况下，不应再发支票。
18.6.  Interactions with Application Layer Gateways and SIP
应用层网关(ALGs)是存在于NAT设备中的功能，它检查数据包的内容并进行修改，以方便应用协议的NAT穿越。  会话边界控制器(SBCs)是ALG的近亲，但由于它们实际上是作为应用层SIP中间人而存在的，所以并不透明。  ICE与SBCs和ALGs有交互作用。
如果ALG知道SIP，但不知道ICE，只要ALG正确修改SDP，ICE就会通过它来工作。  一个正确的ALGimplementation的行为如下。
o 如果m和c行或rtcp属性包含外部地址，ALG不会修改它们。
o 如果m和c行包含内部地址，修改取决于ALG的状态。
如果ALG已经建立了一个绑定，该绑定将外部端口映射到与m和c行或rtcp属性中的值相匹配的内部IP地址和端口，ALG将使用该绑定，而不是创建一个新的绑定。
如果ALG还没有绑定，它就会创建一个新的one并修改SDP，重写m和c行和rtcpattribute。
不幸的是，许多ALG在这些情况下工作得很糟糕。  ICE并不试图解决ALG的问题，因为这超出了它的功能范围。  ICE可以帮助诊断这些情况，这些情况通常表现为candidates集合和m、c行和rtcp属性之间的不匹配。  ice-mismatch属性就是用于这个目的的。
当信令通过TLS运行时，ICE通过ALG工作得最好。  这可以避免ALG操纵SDP消息，干扰ICE的运行。  预计部署在ALG后面的实现应该提供SDP的TLS传输。
如果一个SBC知道SIP但不知道ICE，结果取决于SBC的行为。  如果它作为一个正确的背对背用户代理(B2BUA)，SBC将删除任何它不理解的SDP属性，包括ICE属性。  因此，呼叫将在两个端点上显示为对方不支持ICE。  这将导致ICE被禁用，如果SBC有请求，媒体将流经SBC。  然而，如果SBC没有修改ICE属性就通过了，但却修改了媒体的默认目的地(包含在m和c行和rtcp属性中)，这将被检测为ICE不匹配，ICE处理将被中止。  ICE作为 "绕过 "SBC的工具，不属于ICE的范围。  如果有一个，ICE将不被使用，而以SBC技术为优先。
19.  STUN Extensions
19.1.  New Attributes
本规范定义了四个新的属性，即PRIORITY、USE-CANIDATE、ICE-CONTROLLED和ICE-CONTROLLING。
PRIORITY属性表示如果通过该检查发现了一个对等反身候选者，则与之相关联的优先级。  它是一个 32 位无符号整数，属性值为 0x0024。
USE-CANDIDATE 属性表示该检查所产生的候选对应该用于传输媒体，该属性没有内容（属性的长度字段为零），它是一个标志。  该属性没有内容（属性的Length字段为零），它作为一个标志，其属性值为0x0025。
ICE-CONTROLLED属性存在于Binding请求中，表示客户机认为它当前处于受控角色。  该属性的内容是一个64位无符号整数，按网络字节顺序排列，其中包含一个随机数，用于打破角色冲突的平局。
ICE-CONTROLLING属性存在于Binding请求中，表示客户机认为它目前处于控制角色。  该属性的内容是一个64位无符号整数，按网络字节顺序排列，其中包含一个随机数，用于打破角色冲突的平局。
19.2.  New Error Response Codes
本规范定义了一个单一的错误响应代码。
487（角色冲突）。  绑定请求包含ICE-CONTROLLING或ICE-CONTROLLED属性，表明与服务器冲突的角色。  服务器根据请求中的平局值进行平局测试，确定客户端需要切换角色。
20.  Operational Considerations
本节将讨论与寻求部署ICE的网络运营商相关的问题。
20.1.  NAT and Firewall Types
事实上，开发ICE的目的是为了在IP语音（VoIP）运营商无法控制IP网络基础设施（包括防火墙和NAT）的环境中进行部署。
也就是说，ICE在NAT设备符合 "行为 "的环境中效果最好，符合[RFC4787]和[RFC5766]中定义的建议。  在符合行为规范的NAT的网络中，ICE可以在不需要TURN服务器的情况下工作，从而提高语音质量，减少呼叫设置时间，降低网络运营商的带宽需求。
20.2.  Bandwidth Requirements
部署ICE可能会与可用网络容量产生一些相互作用，运营商应予以考虑。
20.2.1.  STUN and TURN Server Capacity Planning
首先，ICE利用TURN和STUN服务器，这些服务器通常位于网络运营商的数据中心，STUN服务器需要的带宽相对较少。  对于每个媒体流的每个组成部分，每个客户端都会有一个或多个STUN交易到STUN服务器。  在一个基本的纯语音IPv4 VoIP部署中，每个呼叫将有四个事务（一个用于RTP，一个用于RTCP，用于呼叫者和被呼叫者）。  每个事务都是一个单一的请求和一个单一的响应，前者是20字节长，后者是28字节长。  因此，如果一个系统有N个用户，每个用户在繁忙的一小时内打4个电话，这就需要N*1.7bps。  对于100万用户来说，就是1.7Mbps，这是一个非常小的数字（相对来说）。

20.2.2.  Gathering and Connectivity Checks
收集候选人和执行连接性检查的过程可能会占用大量带宽。  ICE的设计是为了加快这两个过程的速度。  收集阶段和连接性检查阶段的目的是为了以与媒体流量本身大致相同的带宽产生流量。  这样做的目的是为了确保，如果一个网络被设计成支持某种类型的多媒体流量（语音、视频或仅仅是文本），它将有足够的容量来支持该媒体的ICE检查。  当然，ICE检查会导致总利用率的边际增加，但这通常是极小的增加。
事实证明，收集和检查阶段造成的拥堵在没有利用步调的部署中是一个问题。  通常情况下，由于端点以最快的速度向网络发送检查，访问链路变得拥挤。  因此，网络运营商应该确保他们的ICE实现支持pacing功能。  虽然这种步调确实增加了呼叫设置时间，但它使ICE网络友好，更容易部署。
20.2.3.  Keepalives
STUN保持生命（以STUN绑定指示的形式）在媒体会话中间发送。  但是，它们只在没有实际媒体流量的情况下发送。  在没有使用语音活动检测（VAD）的部署中，永远不会使用keepalives，也不会增加带宽使用量。  当使用VAD时，将在静默期发送keepalives。  这涉及到每15-20秒发送一个数据包，远远低于有语音时每20-30毫秒发送一个数据包。  因此，keepalives对容量规划没有任何实际影响。
20.3.  ICE and ICE-lite
利用ICE和ICE-lite混合使用的部署可以完美地运行。  它们被明确地设计为这样做，而不损失功能。
然而，ICE-lite只能在有限的使用情况下部署。  这些案例，以及这样做所涉及的注意事项，在附录A中都有记载。
20.4.  Troubleshooting and Performance Management
ICE利用端到端连接检查，并将大部分处理工作放在端点上。  这给网络运营商带来了一个挑战--他们如何解决ICE部署的问题？  他们如何才能知道ICE的性能？  信令路径上的SIP服务器（通常部署在网络运营商的数据中心）将看到传递ICE参数的提议回答交换的内容。  这些参数包括每个候选者的类型（主机、服务器反射或中继），以及它们的相关地址。  一旦ICE处理完成，就会进行一次更新的offeranswer交换，发出所选地址（及其类型）的信号。  这种更新的重新邀请正是为了让网络设备（如连接到SIP服务器的诊断工具）了解ICE处理的结果而进行的。
因此，通过SIP服务器生成的日志，网络运营商可以观察到每个呼叫使用了哪些类型的候选者，以及ICE选择了什么地址。  这是最主要的信息，有助于评估ICE的性能。
20.5.  Endpoint Configuration
ICE依赖于几项数据被配置到endpoints中。  这些配置数据包括定时器、TURN服务器的凭证以及STUN和TURN服务器的主机名。  ICE本身并没有为这种配置提供机制。  相反，我们认为这些信息被附加到任何用于配置端点中所有其他参数的机制中。  对于SIP电话，已经定义了标准的解决方案，如配置框架[SIP-UA-FRMWK]。
21.  IANA Considerations
本规范注册了新的SDP属性、4个新的STUN属性和一个新的STUN错误响应。
21.1.  SDP Attributes
本规范根据[RFC4566]第8.2.4节的程序定义了七个新的SDP属性。  这里包含了注册所需的信息。
21.1.1.  candidate Attribute
联系人姓名：  Jonathan Rosenberg，jdrosen@jdrosen.net。
属性名称：候选者长式：候选者属性类型：media-levelCharset考虑。  该属性不受charsetattribute的限制。
目的：该属性与交互式连接建立（ICE）一起使用，提供了许多可能的通信候选地址之一。  这些地址通过使用会话遍历工具（Session Traversal Utilitiesfor NAT，STUN）进行端到端连接检查来验证。
适当的数值。  见RFC 5245第15节。
21.1.2.  remote-candidates Attribute
联系人姓名：  Jonathan Rosenberg，jdrosen@jdrosen.net。
属性名称：remote-candidatesLong Form：remote-candidatesType of Attribute：media-levelCharset Considerations。  该属性不受charsetattribute的限制。
目的：该属性与交互式连接建立（ICE）一起使用，并提供发包人希望应答人在其应答中使用的远程候选者的身份。
适当的数值。  见RFC 5245第15节。
21.1.3.  ice-lite Attribute
联系人姓名：  Jonathan Rosenberg，jdrosen@jdrosen.net。
属性名称：ice-liteLong形式：ice-lite属性类型：会话级Charset考虑。  该属性不受charsetattribute的限制。
目的：该属性与交互式连接建立（ICE）一起使用，并表示代理具有支持ICE与具有完整实施的peerthat的相互操作所需的最低功能。
适当的数值。  见RFC 5245第15节。
21.1.4.  ice-mismatch Attribute
联系人姓名：  Jonathan Rosenberg，jdrosen@jdrosen.net。
属性名称：ice-mismatchLong形式：ice-mismatch属性类型：会话级Charset考虑。  该属性不受charsetattribute的限制。
用途：此属性用于交互式连接建立（ICE），表示代理具有 ICE 能力，但由于候选者与 SDP 中的媒体信号默认目的地不匹配而没有进行 ICE。
适当的数值。  见RFC 5245第15节。
21.1.5.  ice-pwd Attribute
联系人姓名：  Jonathan Rosenberg，jdrosen@jdrosen.net。
属性名称：ice-pwd长式：ice-pwd属性类型：会话或媒体级Charset考虑。  该属性不受charsetattribute的限制。
目的：此属性与交互式连接建立（ICE）一起使用，并提供用于保护STUN连接检查的密码。
适当的数值。  见RFC 5245第15节。
21.1.6.  ice-ufrag Attribute
联系人姓名：  Jonathan Rosenberg，jdrosen@jdrosen.net。
属性名称：ice-ufragLong形式：ice-ufrag属性类型：会话或媒体级Charset考虑。  该属性不受charsetattribute的限制。
目的：该属性与交互式连接建立（ICE）一起使用，并提供用于在STUN连接检查中构建用户名的片段。
适当的数值。  见RFC 5245第15节。
21.1.7.  ice-options Attribute
联系人姓名：  Jonathan Rosenberg，jdrosen@jdrosen.net。
属性名称：ice-optionsLong Form：ice-optionsType of Attribute：session-levelCharset Considerations。  该属性不受charsetattribute的限制。
用途：此属性与交互式连接建立（ICE）一起使用，并指示代理使用的 ICE 选项或扩展。
适当的数值。  见RFC 5245第15节。
21.2.  STUN Attributes
本节根据[RFC5389]中的程序注册了四个新的STUN属性。
21.3.  STUN Error Responses
0x0024 PRIORITY0x0025 USE-CANDIDATE0x8029 ICE-CONTROLLED0x802A ICE-CONTROLLING 本节根据 [RFC5389] 中的程序注册一个新的 STUN 错误响应代码。
487 角色冲突。 客户端宣称的ICE角色(controllingorcontrolled)与服务器的角色冲突。
22.  IAB Considerations
IAB研究了 "单边自寻址 "的问题，它是一个代理试图通过合作协议反射机制来确定其在NAT另一边的另一个领域的地址的一般过程[RFC3424]。  有意思的是，ICE的过程不是单边的，而是双边的，这种差异对IAB提出的问题有很大影响。  事实上，ICE可以被认为是一个B-SAF（Bilateral Self-AddressFixing）协议，而不是UNSAF协议。  无论如何，国际生物圈计划规定，为此目的制定的任何协议都要记录一套特定的考虑因素。  本节符合这些要求。
22.1.  Problem Definition
>根据RFC 3424，任何UNSAF提案必须提供：
准确地界定将用联阿安全部队建议解决的具体的、范围有限的问题。  短期解决办法不应笼统地用来解决其他问题；这就是为什么 "短期解决办法通常不是"。
ICE正在解决的具体问题是：
为两个对等体提供一种确定可用于通信的传输地址集的方法。
提供一种手段，让代理确定它希望与之通信的另一个对等体可以到达的地址。
22.2.  Exit Strategy
>根据RFC 3424，任何UNSAF提案必须提供：
描述退出战略过渡计划。  较好的短期修复措施是随着适当技术的部署，自然会减少和不使用的措施。
ICE本身并不容易被淘汰。  然而，即使在全球联网的互联网中，它也是有用的，例如，它可以作为检测路由器故障是否暂时中断连接的手段。  ICE还有助于防止某些与NAT无关的安全攻击。  然而，ICE的作用是帮助淘汰其他UNSAF机制。  ICE可以有效地在这些机制中进行选择，优先考虑那些较好的机制，优先考虑那些较差的机制。  本地IPv6地址可以被优先考虑。  随着IPv6的引入，NATsbegin逐渐消散，服务器反射和中继候选地址(UNSAF地址的两种形式)根本不会被使用，因为与本地主机候选地址之间存在更高的优先级连接。  因此，服务器的使用量越来越少，当其使用量为零时，最终可以被移除。
事实上，ICE可以帮助从IPv4向IPv6过渡，当两个双栈主机与SIP通信（使用IPv6）时，它可以用来决定使用IPv6还是IPv4。  当两个双栈主机与SIP通信时，它可以用来决定是使用IPv6还是IPv4（使用IPv6）。  它还可以让一个同时具有6to4和本机v6连接的网络在与对等设备通信时决定使用哪个地址。
22.3.  Brittleness Introduced by ICE
>根据RFC 3424，任何UNSAF提案必须提供：
讨论可能使系统更加 "脆弱 "的具体问题。  例如，涉及在多个网络层使用数据的方法会产生更多的依赖性，增加了调试的难度，并使系统更难过渡。
ICE实际上消除了现有UNSAF机制的脆性。  特别是，经典的STUN（如RFC3489[RFC3489]所述）有几个脆性点。  其中之一是发现过程，它要求代理试图对它所处的NAT类型进行分类。  这个过程是容易出错的。  在ICE中，根本就没有使用这种发现过程。  它不是单方面地评估地址的有效性，而是通过测量与对等体的连接性来动态地确定其有效性。  确定连接性的过程是非常稳健的。
经典的STUN和任何其他单边机制的另一个缺点是它绝对依赖一个额外的服务器。  ICE利用服务器来分配单边地址，但如果可能的话，允许代理直接连接。  因此，在某些情况下，当使用ICE时，STUN服务器的故障仍然允许调用的进展。
经典STUN的另一个缺点是，它假设STUN服务器在公共互联网上。  有趣的是，在ICE中，这一点是不必要的。  在不同的地址域中可以有许多STUN服务器。  ICE将发现提供了一个可用地址的服务器。
经典的STUN最麻烦的一点是，它并不是在所有的网络拓扑结构中都能工作。  在每个代理和STUN服务器之间有共享NAT的情况下，传统的STUN可能无法工作。  有了ICE，这个限制就不存在了。
经典STUN也引入了一些安全考虑因素，幸运的是，这些安全考虑因素也被ICE减轻了。
因此，ICE的作用是修复包括STUN在内的脆性，而不会给系统带来任何额外的脆性。
这些改进的惩罚是ICE增加了sessionestablishment时间。
22.4.  Requirements for a Long-Term Solution
在RFC 3424中，任何SAF提案必须提供：
.对较长期、健全的技术解决方案的要求 -- -- 协助寻找正确的较长期解决方案的过程。
我们从RFC 3489中得到的结论仍然没有改变。  然而，我们觉得ICEactually帮助，因为我们相信它可以成为长期解决方案的一部分。
22.5.  Issues with Existing NAPT Boxes
在RFC 3424中，任何SAF提案必须提供：
讨论所指出的实际问题对现有的、已部署的北大西洋公约组织和经验报告的影响；
目前市场上正在部署一些NAT盒，试图提供 "通用 "ALG功能。  这些通用的ALG在数据包中寻找文本或二进制形式的IP地址，如果它们与绑定相匹配，则将其写入。  这干扰了经典的STUN。  然而，STUN的更新[RFC5389]使用了一种编码，将这些二进制地址从通用ALG中隐藏起来。
现有的NAPT盒对于基于UDP的绑定来说，其到期时间是非确定的，通常是很短的。  这就要求实现定期发送keepalives来维护这些绑定。  ICE使用的默认值是15秒，这是一个非常保守的估计。  最终，随着时间的推移，随着NAT盒子变得合规[RFC4787]，这个最小的keepalive将成为确定性的和众所周知的，并且ICE定时器可以被调整。  有一种方法可以发现和控制最小keepalive间隔将是远远better仍然。
23.  Acknowledgements