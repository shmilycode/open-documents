# An Offer/Answer Model with the Session Description Protocol (SDP)

RFC 3264

Copyright Notice

   Copyright (C) The Internet Society (2002).  All Rights Reserved.

# Abstract
本规范定义了一种机制，通过这种机制，两个实体可以利用会话描述协议(SDP)来达成它们之间对多媒体会话的共同看法。在该模型中，一个参与者从自己的角度向另一个参与者提供所需会话的描述，另一个参与者从自己的角度回答所需会话。这种offer/answer模型在单播会话中是最有用的，因为在这种情况下如果想获得会话的完整视图，需要两个参与者的信息。offer/answer模型被像 Session Initiation Protocol（SIP）这样的协议所使用。

<!-- TOC -->

- [An Offer/Answer Model with the Session Description Protocol (SDP)](#an-offeranswer-model-with-the-session-description-protocol-sdp)
- [Abstract](#abstract)
- [1 引言](#1-引言)
- [2 术语](#2-术语)
- [3 定义](#3-定义)
- [4 协议操作](#4-协议操作)
- [5 生成初始offer](#5-生成初始offer)
  - [5.1 单播](#51-单播)
  - [5.2 多播流](#52-多播流)
- [6 生成Answer](#6-生成answer)
  - [6.1 单播流](#61-单播流)
  - [6.2 多播流](#62-多播流)
- [7 要约人对应答的处理](#7-要约人对应答的处理)
- [8 修改会话](#8-修改会话)
  - [8.1 添加媒体流](#81-添加媒体流)
  - [8.2 删除媒体流](#82-删除媒体流)
  - [8.3 修改媒体流](#83-修改媒体流)
    - [8.3.1 修改地址、端口或传输](#831-修改地址端口或传输)
    - [8.3.2 更改媒体格式集](#832-更改媒体格式集)
    - [8.3.3 改变媒体类型](#833-改变媒体类型)
    - [8.3.4 改变属性](#834-改变属性)
  - [8.4 搁置单播媒体流](#84-搁置单播媒体流)
- [9 表明能力](#9-表明能力)
- [10 Offer/Answer 示例](#10-offeranswer-示例)
  - [10.1 基本交换](#101-基本交换)
  - [10.2 从N个编解码器中选出一个](#102-从n个编解码器中选出一个)
- [11 安全考虑因素](#11-安全考虑因素)
- [14 规范性参考文献](#14-规范性参考文献)
- [15 参考信息](#15-参考信息)

<!-- /TOC -->

# 1 引言

会话描述协议(Session Description Protocol，SDP)[1]最初被设想为描述在Mbone上进行的多播会话的一种方式。会话公告协议（Session Announcement Protocol，SAP）[6]被设计成一种携带SDP消息的多播机制。虽然SDP规范允许单播操作，但它并不完整。多播有一个全局的会话视图，被所有参与者使用，而与多播不同的是，单播会话涉及两个参与者，完整的会话视图需要来自两个参与者的信息，以及他们之间的参数协议。

例如，一个多播会议需要为一个特定的媒体流传达一个单一的多播地址，然而，对于单播会话，则需要两个地址--每个参与者一个地址。另一个例子是，一人多播会话需要显示指出使用哪种编码，但是对于单播而言，编解码器的集合需要通过在每个参与者支持的集合中找到一个重叠来确定。

因此，尽管SDP具有描述单播会话的表达能力，但它缺少实际操作的语义和操作细节。在本文档中，我们通过定义一个基于SDP的简单的offer/answer模型来弥补这一不足。在这个模型中，会话中的一个参与者生成一个SDP消息，该消息包含了offer -- 即要约人（offerer）希望使用的一组媒体流和编解码器，以及要约人希望用来接收媒体的IP地址和端口。该提议被传送给另一个参与者，称为应答者。应答者产生一个answer，这是一个SDP消息，它对要约人提供的offer作出回应。答复中为offer中的每个流提供了一个匹配的媒体流，表明该流是否被接受，同时还提供了将使用的编解码器以及应答者要用来接收媒体的IP地址和端口。

多播会话的工作方式也可能与单播会话类似；其参数在一对用户之间协商，就像单播的情况一样，但双方都向同一个多播地址而不是单播地址发送数据包。本文档还讨论了offer/answer模型在多播流中的应用。

我们还定义了如何在最初的offer-answer交换后，继续使用offer-answer模型来更新会话的准则。

offer和answer的传递方式不在本文档的范围内，这里定义的提供应答模型是会话启动协议（SIP）[7]使用的强制性基准机制。

# 2 术语

在本文档中，关键词 "MUST"、"MUST NOT"、"REQUIRED"、"SHALL"、"SHALL NOT"、"SHOULD"、"SHOULD NOT"、"RECOMMENDED"、"MAY "和 "OPTIONAL "应按照RFC 2119[2]中的描述进行解释，并说明合规实现的需求级别。

# 3 定义

本文件中使用了以下术语：

* Agent：代理是指参与offer/answer交换的协议实现。在offer/answer交换中，有两个代理参与。

* Answer：应答者为了回应要约人的 offer 而发出的SDP信息。

* Answerer: 一个代理从另一个代理那里接收到一个会话描述，描述了所需的媒体交流的各个方面，然后用自己的会话描述来回应。

* Media Stream: 从RTSP[8]的角度来看，媒体流是一个单一的媒体实例，例如，一个音频流或视频流，以及一个白板或共享应用组。在SDP中，一个媒体流由 "m="行及其相关属性来描述。

* offer: 要约人发送的SDP信息。

* Offerer: 生成会话描述以创建或修改会话的代理。

# 4 协议操作

offer/answer交换是假设存在一个上层协议(如SIP)的前提下，该协议能够交换SDP，用于代理之间建立会话的目的。

当一个代理向另一个代理发送一个初始提议时，协议操作就开始了。如果offer在可能已通过高层协议建立的任何上下文之外，则该提议则为初始状态，这里假设的是上层协议提供了某种维护上下文的手段，使各种SDP交换关联在一起。

收到offer的代理可以产生应答，也可以拒绝offer。拒绝offer的方式取决于上层协议。offer与answer的交换是原子性的；如果应答被拒绝，会话就会恢复到本offer之前的状态（可能是没有会话）。

在任何时候，任何一个代理都可以产生一个新的offer，以更新会话，但是，如果它`已经收到`了一个offer，但尚未回答或拒绝，则不得产生新的offer。此外，如果它已经`产生`了一个还offer，但没有收到回答或拒绝，那它也不能产生新的提议。如果代理在发出offer后, 但在收到回复之前, 收到一个offer，则被认为是 "glare(眩光)" 状态。

    glare一词最初用于电路交换电信网络中，描述了两个开关同时试图抢占同一主干上的同一可用电路的情况。这里是指两个代理同时试图发送更新的offer。

上层协议需要提供一种解决这种情况的手段，即需要提供一种对每个方向的消息进行排序的手段。SIP就符合这些要求[7]。

# 5 生成初始offer

offer（和answer）必须是RFC2327[1]定义的有效SDP消息。但有一个例外，RFC2327规定SDP报文中必须有e或a, p行，本规范放宽了这一限制；为offer/answer应用程序制定的SDP可以省略e和p行。o行中的会话id和版本的数值必须用64位有符号的整数来表示。版本的初始值必须小于(2**62)-1，以避免回环。  虽然SDP规范允许将多个会话描述并入一个大的SDP报文中，但在offer/answer模型中使用的SDP报文必须只包含一个会话描述。

SDP中"s="行表示会话的主题，对于多播来说，这是合理的，但对于单播来说，这个定义就的不是特别清晰。所以对于单播会话，建议由一个空格字符(0x20)或破折号(-)组成。

    注：SDP不允许 "s=" 行为空。

SDP的 "t=" 行表示会话的时间，一般来说，单播会话的流是通过外部信令手段（如SIP）创建和销毁的，在这种情况下，"t="行的值应该是 "0 0"。

offer将包含零个或多个媒体流（每个媒体流由 "m=" 行及其相关属性描述）。零个媒体流意味着要约人希望进行通信，但会话的媒体流将在以后通过修改后的offer添加。流可以是单播和多播的混合；后者显然意味着相关"c="行中的多播地址。

每个offer中流的构造取，取决于流是多播还是单播。

## 5.1 单播

如果要约方希望通过这条流只向对方发送媒体，则必须用 "a=sendonly" 属性将该流标记为sendonly。如果一个direction属性作为媒体流属性或a会话属性存在，则流会被标记为有一个确定的方向。如果发包方希望只从其对等方接收媒体，则必须将流标记为recvonly。如果要约方希望进行通信，但希望此时既不发送也不接收媒体，则必须用 "a=inactive "属性标记流。"inactive" 方向属性在RFC 3108[3]中规定。注意，在实时传输协议（RTP）[4]的情况下，即使流属性为sendonly、recvonly或inactive，RTCP仍然会进行发送和接收，也就是说，媒体流的方向性对RTCP的使用没有影响。如果发包方希望与对等方同时发送和接收媒体，可以包含 "a=sendrecv "属性，也可以省略它，因为sendrecv是默认的。

对于recvonly和sendrecv流，offer中的端口号和地址表示要约方希望接收介质流的位置。  对于sendonly属性的RTP流，地址和端口号直接表示提供方希望在哪里接收RTCP报告。除非有明确的指示，否则报告将被发送到比所指示的号码高一个的端口号，offer中的IP地址和端口并不表示要约人要发送的RTP和RTCP报文的源IP地址和源端口。offer中的端口号为0表示流被提供，但必须不被使用，这在初始offer中没有有用的语义，但为了完整性，允许这样做，因为answer可以包含一个表示拒绝的零端口的流（第6节）。此外，现有的流可以通过将端口设置为零来表示终止(第 8 节)。一般来说，端口号为零表示不需要该媒体流。

每个媒体流的媒体格式列表传达了两个信息，即要约方能够发送或接收（取决于方向属性）的一组格式（在RTP的情况下表示编解码器和编解码器相关的参数），以及在RTP的情况下，用于标识这些格式的RTP有效载荷类型编号。如果列出了多种格式，则意味着要约方能够在会话中使用其中的任何一种格式。换句话说，应答者可以在会话中间改变格式，使用列出的任何一种格式，而不需要发送新的offer。对于一个sendonly的流，offer中应该指出要约方愿意在这个流使用的发送格式。对于recvonly 流，该offer应该指出要约人愿意在该流中使用的接收格式。对于send-recv流，offer应该指出了发件人愿意发送和接收的哪些解码器。

对于recvonly RTP串流，有效载荷类型号表示要约方预期为该编解码器接收的RTP封包中的有效载荷类型字段的值。对于sendonly的RTP流，有效载荷类型编号表示要约方计划为该编解码器发送的RTP数据包中的有效载荷类型字段的值。但是，对于sendonly和sendrecv流，answer可能为相同的编解码器指明了不同的有效载荷类型号，在这种情况下，要约人必须使用answer中的有效载荷类型号进行发送。

    由于与H.323的互操作性问题，每个方向可能需要不同的有效载荷类型号。

根据RFC 2327，`fmtp` 参数可能存在，以提供媒体格式的附加参数。

在RTP流的情况下，所有的媒体描述都应该包含从RTP有效载荷类型到编码的 "a=rtpmap "映射，如果没有 "a=rtpmap"，则使用当前使用的profile（例如，RFC 1890[5]）所定义的默认有效载荷类型映射。

    这样可以使静态有效载荷类型的移值更容易。

在所有情况下，"m="行中的格式必须按偏好顺序排列，列出的第一种格式为首选。在这种情况下，首选意味着offer的接受者应该使用其可以接受的最高偏好的格式。

如果一个流存在 `ptime` 属性，它表示要约方希望收到的理想的数据包的时间长度。ptime 属性必须大于零。

如果流的带宽属性存在，则表示要约人希望使用的带宽。允许使用0值，但不鼓励使用，因为它表示不应该发送任何媒体。在RTP的情况下，它也会禁用所有RTCP。

如果存在多个不同类型的媒体流，则意味着要约人希望同时使用这些媒体流。一个非典型的例子是音频和视频流同时作为视频会议的一部分。

如果在一份offer中出现了同一类型的多个媒体流，则意味着要约人希望同时发送（或接收）该类型的多个媒体流。当发送同一类型的多个媒体流时，如何将该类型的每个媒体源（例如，在视频的情况下，摄像机和录像机）映射到每个流上，由本地政策决定。当用户拥有一个特定媒体类型的单一源时，只有一种策略是有意义的：源被发送到与源类型相同的每个流上。每个流可以使用不同的编码。当接收同一类型的多个数据流时，如何将每个数据流映射到该特定类型的各种媒体槽（sink）（例如，在音频的情况下，扬声器或录音设备）同样是一个本地策略的问题。  然而，这些策略有一些限制；首先，当接收同一类型的多个流时，每个流必须被映射到至少一个槽中，以便向用户展示。换句话说，接收同一类型的多个流的意图是，它们都应该被并行呈现，而不是只选择一个。另一个约束条件是，当多个流被接收并发送至同一个槽时，它们必须以某种特定的媒体方式组合。例如，在两个音频流的情况下，从每个音频流接收到的媒体都需要被映射到扬声器，所以在这种情况下，组合操作将是混音。在多个即时通讯流的情况下，如果槽是屏幕，则组合操作将是把它们全部呈现在用户界面上。第三个约束是，如果多个消息源被映射到同一个流上，这些消息源必须在被发送到流上之前以某种特定的媒体方式进行组合。虽然这些约束条件之外的策略是灵活的，但除非是会议服务器，否则代理一般不会想要一个将媒体从它的sinks复制到它的sources的策略（即，不要将一个流上的接收媒体复制到另一个流上）。

同一类型的多个媒体流的一个典型使用实例是一个预付费电话卡应用，用户可以在通话过程中随时按住磅（"#"）键挂断电话，并在同一张卡上进行新的通话。这就需要用户将媒体传送到两个目的地--远程网关，以及寻找磅键的DTMF处理应用程序。这可以用两个媒体流来实现，一个sendrecv到网关，另一个sendonly（从用户的角度）到DTMF应用程序。

一旦要约人发送了offer，它必须准备好接收该offer所描述的任何recvonly流的媒体，也必须准备好为offer中的任何sendrecv流发送和接收媒体，并为offer中的任何sendonly流发送媒体（当然，在对等体提供所需地址和端口信息的应答之前，它不能实际发送）。在RTP的情况下，即使它可以在应答到达之前接收媒体，但在应答到达之前，它将不能发送RTCP接收报告。

## 5.2 多播流

如果会话描述中包含的多播媒体流被列为只接收(发送)，则意味着包括要约人和应答人在内的参与者只能接收(发送)该流。这与单播视图不同，在单播视图中，方向性取决于要约人和应答人之间的媒体流。

除了这些说明之外，提供的多播流的语义与RFC 2327[1]中的描述完全一致。

# 6 生成Answer

对offer会话描述的answer是基于offer会话描述的。如果answer与offer的会话描述有任何不同（不同的 IP 地址、端口等），则answer中的起始行必须不同，因为answer是由不同的实体生成的。在这种情况下，answer中 "o=" 行的版本号与offer中o行的版本号无关。

对于offer中的每一行 "m="，answer中必须有相应的 "m=" 行。answer必须包含与offer完全相同数量的 "m="行。这允许根据流的顺序进行匹配，同时这也意味着，如果offer包含0个 "m="行，则answer也必须包含零个 "m=" 行。

应答中的"t="行必须等于报价，会议时间不能协商。

所提供的流可以在应答中被拒绝，原因不限。如果一个流被拒绝，提供方和应答方必须不为该流生成媒体（或RTCP包）。要拒绝一个提供的流，answer中对应流的端口号必须设置为0，任何列出的媒体格式都会被忽略（至少有一媒体格式存在，这是SDP的要求）。

为单播和组播提供的流的应答是不同的。

## 6.1 单播流

如果一个流被提供了一个单播地址，该流的应答必须包含一个单播地址。应答的流的媒体类型必须与提供的流相匹配。

如果一个媒体流是以 sendonly 的形式提供的，那么相应的媒体流必须在应答中标明为 recvonly 或 inactive。如果一个媒体流在offer中被列为recvonly，则answer中必须标记为sendonly或inactive。如果所提供的媒体流被列为sendrecv（或者如果在媒体或会话级别上没有方向属性，在这种情况下，该流默认为sendrecv），则应答中相应的流可以标记为sendonly、recvonly、sendrecv或inactive。如果所提供的媒体流被列为非活动，则必须在应答中也标记为非活动。

对于在answer中标明为recvonly的数据流，"m="行必须包含至少一种存在于offer中的，且应答者愿意接收的媒体格式。流可以表示应答者愿意接受的额外，但不在offer中的媒体格式。对于在应答中标记为sendonly的数据流，"m="行必须包含至少一种存在于offer列中，且应答者发送的媒体格式。  对于在应答中标记为sendrecv的流，"m="行必须包含至少一种存在于offer编解码器列表中，且应答者愿意同时发送和接收的编解码器。对于在应答中标记为inactive的流，媒体格式的列表是基于offer构建的；如果该offer是只发送的，那么该列表就会被构造为好像answer是recvonly一样；同样，如果offer是recvonly，则列表的构造就像answer是sendonly一样；如果offer是sendrecv，则列表的构造就像answer是sendrecv一样；如果offer为非活动状态，则列表构造的就像offer实际上是sendrecv，而应答是sendrecv。

应答中的连接地址和端口表示应答者希望接收媒体的地址（在RTP的情况下，除非有其他明确的指示，否则RTCP将在高一个端口上接收）。这个地址和端口即使对于只发送流也必须存在；在RTP的情况下，高一个的端口仍然用来接收RTCP。

在 RTP 的情况下，如果在offer中用特定的有效载荷类型号引用了特定的编解码器，则应在answer中为该编解码器使用相同的有效载荷类型号。即使使用了相同的payload类型号，应答中也必须包含rtpmap属性，以定义动态payload类型的映射，并应包含静态payload类型的映射。在 "m=" 行中的媒体格式必须按优先顺序列出，第一个列出的格式是首选项。在这种情况下，首选意味着要约人应该使用应答中偏好度最高的格式。

虽然应答者可以按其希望的优先顺序列出格式，但建议除非有特殊原因，应答者应按其在offer中出现的相同相对顺序列出格式。换句话说，如果一个流在offer中列出了音频编解码器8、22和48的顺序，而应答者只支持编解码器8和48，建议如果应答者没有改变它的理由的话，应答者的编解码器顺序是8、48，而不是48、8。这有助于确保在两个方向上使用相同的编解码器。

fmtp参数在offer中的解释取决于参数。在许多情况下，这些参数描述了媒体格式的特定配置，因此应该像媒体格式值本身一样处理。这意味着，如果应答中存在它们所描述的媒体格式，那么具有相同值的相同fmtp参数必须存在于应答中。其他的fmtp参数更像是参数，对于这些参数，每个代理使用不同的值是完全可以接受的。在这种情况下，应答中可能包含fmtp参数，这些参数可能与offer中的参数具有相同的值，也可能不同。定义新参数的SDP扩展应该在offer/answer中指定正确的解释。

应答者可以为任何媒体流包含一个非零的 `ptime` 属性；这表示应答者希望收到的封包时间长度。对某一特定流来说，不要求每个方向的封包时间长度都相同。

应答者可以为任何媒体流指定一个带宽属性，这表示应答者希望发件人在发送媒体时使用的带宽，允许为零，解释见第5节。

如果应答者对某一特定提供的媒体流没有共同的媒体格式，则应答者必须通过将端口设置为0来拒绝该媒体流。

如果所有流没有共同的媒体格式，则拒绝整个提供的会话。

一旦应答者发送了应答，它必须准备好接收该应答所描述的任何recvonly流的媒体，必须准备好为该应答中的任何sendrecv流发送和接收媒体，并且可以立即发送媒体，必须准备使用应答中为recvonly或sendrecv流列出的任何媒体格式来接收媒体，并且可以立即发送媒体。当发送媒体时，它应该使用一个等于offer中ptime属性值的封包时长。它发送媒体时使用的带宽不高于offer中带宽属性的值。应答者必须使用应答中列出的offer中的媒体格式进行发送，并且应该使用应答中列出的offer中最喜欢的媒体格式进行发送。在RTP的情况下，即使与应答中的有效载荷类型号不同，也必须使用offer中的有效载荷类型号。

## 6.2 多播流

与单播不同，单播有流的两面视图，而多播只有流的一面视图。因此，生成一个多播offer的answer通常只涉及修改流的有限方面。

如果接受了多播流，则answer中的地址和端口信息必须与offer中的地址和端口信息一致。  同样，应答中的方向性信息（sendonly、recvonly或sendrecv）也必须与offer的信息相同。这是因为多播会话中的所有参与者需要对会话的参数有相等的看法，这是RFC 2327中多播偏向的一个基本假设。

answer中的媒体格式集必须等于或是offer中的格式集的子集。删除格式是应答者表明不支持该格式的一种方式。

answer中的ptime和带宽属性必须等于offer中的属性（如果存在）。如果不存在，答案中可以添加一个非零的ptime。

# 7 要约人对应答的处理

当要约人收到应答时，它可以在被接受的流上发送媒体（假设它在应答中被列为sendrecv或recvonly）。它必须使用应答中列出的媒体格式进行发送，并且在发送时应该使用应答中列出的第一种媒体格式。

    之所以说这是应该，而不是必须的（对应答者来说，这也是应该，而不是必须的），是因为经常需要在过程中改变编解码器。例如，在静音期间，代理可能想切换到一个合适的噪音编解码器。或者，如果用户在键盘上按了一个数字，代理可能会使用RFC 2833[9]来发送。拥塞控制也可能需要根据反馈改变到一个较低速率的编解码器。

要约人应根据应答中任何ptime和bandwidth属性的值发送媒体。

要约人可立即停止监听已列入初始offer，但未出现在答案中的媒体格式。

# 8 修改会话

在会话期间的任何时候，任何一个参与者都可以发出新的offer来修改会话的特性。在修改现有会话的参数时，使用与上述定义完全相同的offer/answer过程是offer/answer模型运行的根本。

该offer可能与向对方提供的上一次SDP相同（可能是在offer或answer中提供的），也可能不同。我们将最后提供的SDP称为 "上一次SDP"。如果offer相同，则answer可能与应答者提供的上一个SDP相同，也可能不同；如果所提供的SDP与上一个SDP不同，则对其构造进行一些限制，下文将进行讨论。

几乎可以修改会话的所有方面。可以增加新的流，删除现有的流，改变现有流的参数。当发出修改会话的offer时，新的SDP的 "o="行必须与上一个SDP中的相同，但origin字段中的版本号必须比上一个SDP增加一。如果origin行中的版本不增加，则SDP必须与该版本号的SDP相同。应答者必须准备好接收一个包含版本号没有变化的SDP的应答，这实际上是一个no-op（空操作）。但是，应答者必须根据第6节中定义的程序，生成一个有效的应答（它可能与应答者之前的SDP相同，也可能不同）。

如果提供的SDP与之前的SDP不同，那么新的SDP必须为之前SDP中的每个媒体流提供匹配的媒体流。换句话说，如果前一个SDP有N个 "m="行，新的SDP必须至少有N个 "m="行。前一个SDP中从头算起的第i个媒体流，，与新SDP中从头算起的第i个媒体流相匹配。为了让应答者确定新SDP中的哪个流对应于前一个SDP中的流，这种匹配是必要的。由于这些要求，一个流中 "m="行的数量永远不会减少，而是保持不变或增加。从以前的SDP中删除的媒体流在新的SDP中必须不被删除；但是，这些流的属性不需要存在。

## 8.1 添加媒体流 

新的媒体流是通过在现有媒体流下面添加新的媒体描述来创建的，或者通过重新使用旧的媒体流所使用的 "槽 "来创建的，旧的媒体流通过将其端口设置为零而被禁用。

重复使用其槽位意味着新的媒体描述取代了旧的媒体描述，但保留了其相对于SDP中其他媒体描述的位置。新的媒体描述必须出现在任何现有媒体部分的下方。这些媒介描述的格式化规则与第5节中描述的规则相同。

当应答者收到的SDP中包含了比前一个SDP更多的媒体描述，或者它收到的SDP中包含了一个媒体流，而之前的端口是零，应答者就知道有新的媒体流被添加进来。通过在应答中放置适当结构的媒体描述，可以拒绝或接受这些媒体流。在应答中构造新的介质描述的过程在第6节中描述。

## 8.2 删除媒体流

通过创建一个新的SDP，并将该媒体流的端口号设置为0，即可删除现有的媒体流。媒体流描述可以包含之前存在的所有属性，也可以只列出单一媒体格式。

如果提供的流的端口为零，则必须在应答中标明端口为0。与offer一样，应答可以省略之前存在的所有属性，只列出offer中的一个媒体格式。

删除一个媒体流意味着不再向该流发送媒体，任何接收到的媒体都被丢弃。在RTP的情况下，RTCP的传输也停止，对任何接收到的RTCP数据包的处理也停止。任何与之相关的资源都可以被放弃。用户界面可以通过关闭PC上的相关窗口等方式来表明流已经结束。

## 8.3 修改媒体流

几乎可以修改媒体流的所有特性。

### 8.3.1 修改地址、端口或传输

流的端口号可以修改改。要做到这一点，要约人创建一个新的媒体描述，其中的端口号与上一个SDP中的相应流不同。如果只有端口号要改变，媒体流描述的其余部分应保持不变。要约人必须做好准备，在要约发出后立即同时接收新旧端口上的媒体。要约人不应该停止监听旧端口上的媒体，直到收到应答和新端口上的媒体到达为止，因为这样做可能会导致过渡期间媒体的丢失。

接收在数据，在这种情况下，意味着媒体被传递到一个媒体接收槽。如果有一个播放缓冲区，代理将继续在旧端口上监听，直到新端口上的媒体到达播放缓冲区的顶部。这时，它可以停止监听旧端口上的媒体。

应答中对应的媒体流可能与应答者上一个SDP中的媒体流相同，也可能不同，如果应答者接受了更新的媒体流，则应答者应立即开始向新端口发送该媒体流。如果应答者改变了以前的SDP端口，必须在应答者发送时立即准备好同时接收新旧端口的媒体。应答者必须在新端口收到媒体之前，不停止监听旧端口的媒体，一旦收到新媒体，它可以停止监听旧端口上的媒体。同样的道理也适用于用新端口发送更新offer的应答者；它必须不停止监听旧端口上的媒体，直到媒体到达新端口。

当然，如果提供的数据流被拒绝，要约人可以在收到拒绝后立即停止使用新端口接收。

要更改媒体发送的IP地址，请遵循与更改端口号相同的步骤。唯一不同的是，更新的是连接地址，而不是端口号。

流的传输协议也可以被改变。这样做的过程和改变端口的过程是一样的，只是更新的是传输协议，而不是端口。

### 8.3.2 更改媒体格式集

在会话中使用的媒体格式列表可以更改。为此，要约人创建一个新的媒体描述，在 "m=" 行中的媒体格式列表与前一个SDP中的相应媒体流不同。这个列表可以包括新的格式，也可以删除以前SDP中的格式。然而，在RTP的情况下，从特定动态有效载荷类型号到该媒体流中的特定编解码器的映射在会话期间必须不能修改。例如，如果 A 生成一個分配給动态有效载荷类型号 46 的 G.711 的offer，则有效载荷类型号码 46 必须在会话中对该媒体流的任何offer或answer中都指代 G.711。然而，可以接受将多个有效载荷类型号映射到同一编解码器上，这样，更新后的offer也可以使用有效载荷类型号72来表示G.711。

    由于SDP的信令交换和媒体流之间的松散同步，这些映射需要在会话期间保持不变。

应答中相应的媒体流按照第6节的描述制定，并可能导致媒体格式的改变。同样，如第6节所述，当它发送应答时，应答者必须使用应答中也存在的任何格式开始发送媒体，并且应该使用应答中也列出的offer最喜欢的格式(假设流允许发送)，而不能使用offer中没有的任何格式发送，即使它们存在于对等体的上一个SDP中。同样，当要约人收到应答时，它必须使用应答中的任何格式开始发送媒体，并且应该使用最喜欢的格式（假设流允许发送），并且必须不使用应答中没有的任何格式进行发送，即使它们存在于对等方之前的SDP中。

当一个代理停止使用一种媒体格式时（通过不在offer或answer中列出该格式，即使该格式在以前的SDP中出现过），该代理仍然需要准备在短时间内接收该格式的媒体。它如何知道何时可以准备停止接收该格式的媒体？ 有三种技巧可以应用。首先，除了改变格式外，代理还可以改变端口。当媒体到达新的端口时，它就知道对等体已经停止用旧的格式发送，它就可以停止从旧的端口接收旧格式的媒体，并准备使用新格式的媒体。这种方法的好处是与媒体格式无关。但是，端口的改变可能需要改变预留资源或需要安全协议重新交换密钥。第二种方法是当一个编解码器被丢弃时，对所有编解码器使用一套全新的动态有效载荷类型。当通过接收到其中一个新的有效载荷类型时，代理就知道对端已经不再使用旧的格式了。这种方法不影响保留或安全上下文，但它是RTP特有的，浪费了很小的有效载荷类型空间。第三种方法是使用一个定时器。当接收到来自对端的SDP时，定时器被设置。当它超时时，代理可以停止准备旧格式接收然后使用新格式。一般来说，一分钟的值就足够了。在某些情况下，代理可能并不在意，因此继续准备用旧格式接收，在这种情况下，不需要做任何事情。

当然，如果提供的流被拒绝，只要收到了反对意见，就可以停止准备使用任何新的格式接收。

### 8.3.3 改变媒体类型

流的媒体类型（音频、视频等）可以改变。当传输相同的逻辑数据，但只是以不同的媒体格式传输时，建议更改媒体类型（而不是添加一个新的流）。这对于在单一流中的声频传真和视频传真之间的转换特别有用，因为它们都是独立的媒体类型。要做到这一点，要约人用新的媒体类型创建一个新的媒体描述，以代替要改变的前一个SDP中的描述。

应答中对应的媒体流的制定如第6节所述。假设媒体流是可以接受的，应答者在收到offer时就应该开始用新的媒体类型和格式发送。要约人必须准备好同时接收新旧类型的媒体，直到收到应答，并且接收到新类型的媒体并到达播放缓冲区的顶部。

### 8.3.4 改变属性

媒体描述中的任何其他属性都可以在offer或应答中进行更新，一般情况下，代理必须在收到带有更改的SDP后使用新的参数进行媒体发送（如果流的方向属性允许）。

## 8.4 搁置单播媒体流

如果呼叫中的一方想让对方 "搁置"，即要求对方暂时停止发送一个或多个单播媒体流，一方向对方提供一个更新的SDP。

如果要搁置的媒体流之前是sendrecv媒体流，则通过标记为sendonly来搁置。如果要搁置的流之前是recvonly媒体流，则通过标记为非活动流来搁置。

这意味着一个流在每个方向上分别被 "搁置"。每个数据流都是独立 "搁置 "的。对一个流的 "搁置 "提议的接收方，不应自动回复相应的 "搁置 "流。所有数据流都处于 "搁置 "状态的SDP称为 "搁置SDP"。

    当应答者用搁置SDP响应搁置SDP时，某些第三方呼叫控制场景会停止工作。

通常情况下，当用户 "按下" 搁置时，代理会与SDP中的所有流生成一个offer，指示一个sendonly的方向，它还会在本地静音，这样就不会有媒体被发送到远端，也不会有媒体被播放出来。

RFC 2543[10]规定，通过将连接地址设置为 "0.0.0.0" 来实现用户的搁置。现在不再推荐使用它来搁置呼叫，因为它不允许RTCP与搁置流一起使用，不能与IPv6一起工作，并且在与面向连接的媒体一起时无法工作。但是，当发包方知道要使用一组特定的媒体流和格式，但在发包时不知道地址和端口时，它在初始发包中是有用的。当然，在使用时，端口号必须不为零，因为这将指定该流已被禁用。代理必须能够接收连接地址为 "0.0.0.0" 的SDP，在这种情况下，意味着既不应该向对端发送RTP，也不应该发送RTCP。

# 9 表明能力

在代理发送offer之前，了解offer中的媒体格式是否为应答者所接受是很有帮助的，某些协议，如SIP，提供了查询这种能力的方法。SDP可用于响应这种查询，以指示能力。本节介绍如何格式化这样的SDP消息。由于SDP没有办法表明消息是为了能力指示的目的，所以要根据上层协议的上下文来确定。基准SDP指示能力的能力是非常有限的。它不能表达允许的参数范围或值，也不能与offer/answer本身并行完成。扩展可能会在将来解决这种限制。

为表示媒体能力而构建的SDP结构如下。它必须是一个有效的SDP，但可以省略 "e="和 "p="两行。t="行必须等于 "0 0"。对于代理所支持的每种媒体类型，必须有该类型的相应媒体描述。origin字段中的会话ID必须对于每个构建的SDP都是唯一的，以表明媒体能力。端口必须设置为零，但连接地址是任意的。使用零端口可以确保为能力而格式化的SDP如果被解释为offer或answer，也不会导致媒体流被建立。

"m="行的传输分量表示该媒体类型的传输协议。对于代理支持的每一种媒体格式，"m="行中必须有一个媒体格式。在RTP的情况下，如果使用动态的有效载荷类型，必须有一个rtpmap属性来将该类型绑定到特定的格式上。没有办法表明限制，例如对于特定的编解码器可以支持多少个多流，以及类似的一些情况。

    v=0
    o=carol 28908764872 28908764872 IN IP4 100.3.6.6
    s=-
    t=0 0
    c=IN IP4 192.0.2.4
    m=audio 0 RTP/AVP 0 1 3
    a=rtpmap:0 PCMU/8000
    a=rtpmap:1 1016/8000
    a=rtpmap:3 GSM/8000
    m=video 0 RTP/AVP 31 34
    a=rtpmap:31 H261/90000
    a=rtpmap:34 H263/90000
 
    Figure 1: SDP Indicating Capabilities

图1的SDP表明，代理可以支持三种有声编解码器(PCMU、1016和GSM)和两种视频编解码器(H.261和H.263)。

# 10 Offer/Answer 示例

本节提供了要约-答案交换的示例。

## 10.1 基本交换

假设呼叫者Alice在她的offer中包含了以下描述。它包括一个双向音频流和两个双向视频流，使用H.261（有效载荷类型31）和MPEG（有效载荷类型32）。所提供的SDP是：

    v=0
    o=alice 2890844526 2890844526 IN IP4 host.anywhere.com
    s=
    c=IN IP4 host.anywhere.com
    t=0 0
    m=audio 49170 RTP/AVP 0
    a=rtpmap:0 PCMU/8000
    m=video 51372 RTP/AVP 31
    a=rtpmap:31 H261/90000
    m=video 53000 RTP/AVP 32
    a=rtpmap:32 MPV/90000

被叫方Bob不想接收或发送第一个视频流，所以他返回下面的SDP作为回答。

    v=0
    o=bob 2890844730 2890844730 IN IP4 host.example.com
    s=
    c=IN IP4 host.example.com
    t=0 0
    m=audio 49920 RTP/AVP 0
    a=rtpmap:0 PCMU/8000
    m=video 0 RTP/AVP 31
    m=video 53000 RTP/AVP 32
    a=rtpmap:32 MPV/90000

在某一时刻，Bob决定改变他将接收音频流的端口（从49920到65422），同时，增加一个额外的音频流作为只接收，使用RTP payload format完成这件事[9]。Bob在offer中提供了以下SDP。

    v=0
    o=bob 2890844730 2890844731 IN IP4 host.example.com
    s=
    c=IN IP4 host.example.com
    t=0 0
    m=audio 65422 RTP/AVP 0
    a=rtpmap:0 PCMU/8000
    m=video 0 RTP/AVP 31
    m=video 53000 RTP/AVP 32
    a=rtpmap:32 MPV/90000
    m=audio 51434 RTP/AVP 110
    a=rtpmap:110 telephone-events/8000
    a=recvonly

Alice接受了额外的媒体流，因此产生了下面的回答。

    v=0
    o=alice 2890844526 2890844527 IN IP4 host.anywhere.com
    s=
    c=IN IP4 host.anywhere.com
    t=0 0
    m=audio 49170 RTP/AVP 0
    a=rtpmap:0 PCMU/8000
    m=video 0 RTP/AVP 31
    a=rtpmap:31 H261/90000
    m=video 53000 RTP/AVP 32
    a=rtpmap:32 MPV/90000
    m=audio 53122 RTP/AVP 110
    a=rtpmap:110 telephone-events/8000
    a=sendonly

## 10.2 从N个编解码器中选出一个

嵌入式手机中常见的情况是，用于压缩的数字信号处理器(DSP)可以同时支持多个编解码器，但一旦选择了该编解码器，就不能轻易在使用过程中更改。这个例子展示了如何使用一个初始offer和answer的交换来设置一个会话，然后立即使用第二个交换来锁定一组编解码器。

从Alice到Bob的初始offer表明，DSP中可用的三个音频编解码器是一个单一的音频流。该流被标记为非活动状态，因为在编解码器被锁定之前不能接收媒体。

    v=0
    o=alice 2890844526 2890844526 IN IP4 host.anywhere.com
    s=
    c=IN IP4 host.anywhere.com
    t=0 0
    m=audio 62986 RTP/AVP 0 4 18
    a=rtpmap:0 PCMU/8000
    a=rtpmap:4 G723/8000
    a=rtpmap:18 G729/8000
    a=inactive

Bob可以支持PCMU和G.723之间的动态切换。所以，他发送的应答如下：

    v=0
    o=bob 2890844730 2890844731 IN IP4 host.example.com
    s=
    c=IN IP4 host.example.com
    t=0 0
    m=audio 54344 RTP/AVP 0 4
    a=rtpmap:0 PCMU/8000
    a=rtpmap:4 G723/8000
    a=inactive

Alice就可以从这两个编解码器中任意选择一个。所以，她发送一个更新的offer与sendrecv流。

    v=0
    o=alice 2890844526 2890844527 IN IP4 host.anywhere.com
    s=
    c=IN IP4 host.anywhere.com
    t=0 0
    m=audio 62986 RTP/AVP 4
    a=rtpmap:4 G723/8000
    a=sendrecv

Bob接受单一编解码器：

    v=0
    o=bob 2890844730 2890844732 IN IP4 host.example.com
    s=
    c=IN IP4 host.example.com
    t=0 0
    m=audio 54344 RTP/AVP 4
    a=rtpmap:4 G723/8000
    a=sendrecv

如果应答者(Bob)，只能够支持N中编解码器中的一种，Bob会从offer中选择一个编解码器，并放置在他的回答中。在这种情况下，Alice会做一个重新的offer，以激活该编解码器的流。

作为在第一次交换中使用 "a=inactive" 的替代方法，Alice可以列出所有的编解码器，一旦收到Bob的媒体，就生成一个更新的offer，将编解码器锁定为刚刚收到的那个。当然，如果Bob只支持N个编解码器中的一个，那么在他的回答中应该只有一个编解码器，在这种情况下，就不需要重新交换以锁定到一个编解码器。

# 11 安全考虑因素

如果攻击者能够在传输过程中修改offer或answer，则有许多攻击的可能，一般来说，这些攻击包括转移媒体流（使窃听成为可能，使呼叫失效，以及注入不需要的媒体流）。如果一个不怀好意的监听者能够构建虚假的提议，并将这些提议注入到交换中，那么类似的攻击是可能的。即使只要攻击者可以简单地观察提议和回答，他们就可以将媒体流注入现有的对话中。

Offer/answer依赖于应用信令协议（如SIP）内的传输，它还依赖于该协议的安全能力。由于上述攻击，该协议必须提供一种手段，用于提供和应答的端到端认证和综合保护，必须提供主体的加密，以防止窃听。然而，媒体注入攻击也可以通过认证的媒体交换来解决，因此加密要求是SHOULD而不是MUST。

重放攻击也会导致问题。攻击者可以重播一个旧的offer，也许是一个已经将媒体搁置的offer，从而使对话中的媒体流失效。因此，应用协议必须提供一种安全的方式来对offer和answer进行排序，并检测和拒绝旧的offer或answer。

SIP[7]符合所有这些要求。

# 14 规范性参考文献

    [1]   Handley, M. and V. Jacobson, "SDP: Session Description
          Protocol", RFC 2327, April 1998.

    [2]   Bradner, S., "Key Words for Use in RFCs to Indicate Requirement
          Levels", BCP 14, RFC 2119, March 1997.

    [3]   Kumar, R. and M. Mostafa, "Conventions For the Use of The
          Session Description Protocol (SDP) for ATM Bearer Connections",
          RFC 3108, May 2001.

    [4]   Schulzrinne, H., Casner, S, Frederick, R. and V. Jacobson,
          "RTP: A Transport Protocol for Real-Time Applications", RFC
          1889, January 1996.

    [5]   Schulzrinne, H., "RTP Profile for Audio and Video Conferences
          with Minimal Control", RFC 1890, January 1996.

# 15 参考信息

    [6]   Handley, M., Perkins, C. and E. Whelan, "Session Announcement
          Protocol", RFC 2974, October 2000.

    [7]   Rosenberg, J., Schulzrinne, H., Camarillo, G., Johnston, A.,
          Peterson, J., Sparks, R., Handley, M. and E. Schooler, "SIP:
          Session Initiation Protocol", RFC 3261, June 2002.

    [8]   Schulzrinne, H., Rao, A. and R. Lanphier, "Real Time Streaming
          Protocol (RTSP)", RFC 2326, April 1998.

    [9]   Schulzrinne, H. and S. Petrack, "RTP Payload for DTMF Digits,
          Telephony Tones and Telephony Signals", RFC 2833, May 2000.

    [10]  Handley, M., Schulzrinne, H., Schooler, E. and J. Rosenberg,
          "SIP: Session Initiation Protocol", RFC 2543, March 1999.